[{"id":"15cc9fb0e94d56cd","type":"tab","label":"[deadred] minimal viable backend","disabled":false,"info":"# Deadred backend for a serverless Node-RED client\n\nProvides the minimum required dynamic input that a Node-RED client requires to start up and be useful.\n\nThe the frontend is hosted @ [GitHub](https://github.com/gorenje/cdn.flowhub.org) and can be accessed at [cdn.flowhub.org](https://cdn.flowhub.org).\n\nThe frontend is completely static including node and plugin definitions. This backend provides dynamic flow delivery so that the flow shown at startup can be influenced.\n\nThis is used at [flowhub.org](https://flowhub.org) for demonstrating how flows can be edited in Node-RED. For example, [this flow](https://cdn.flowhub.org/?fhid=15cc9fb0e94d56cd).\n\n\n--- \n\n<small>*[\"Better dead than red\"](https://en.wikipedia.org/wiki/Better_dead_than_red)*</small>","env":[]},{"id":"71e12e12a2f4d2bd","type":"group","z":"15cc9fb0e94d56cd","name":"prevent the not connected message in node-red","style":{"label":true},"nodes":["2cde456edb1be7e9","d80b4dce46ac0750"],"x":737,"y":878,"w":309,"h":138},{"id":"673c71e09607ca7c","type":"group","z":"15cc9fb0e94d56cd","name":"flows.json is dynamically generated based on 2 different references","style":{"label":true},"nodes":["d585b1fdd36073bd","30735a9b2b2429d2","9567e0c0960791be","a11f4e4b21c55af0","05556527c9fd23a0","b3b29cfb6ef83822"],"x":903,"y":330,"w":824,"h":211},{"id":"3be9e6565bc22bf3","type":"group","z":"15cc9fb0e94d56cd","name":"not found response","style":{"label":true},"nodes":["f9d9df91d34b19f8","edd7686c50e5c47a","97b3b80a437340a4"],"x":316,"y":882,"w":349,"h":125},{"id":"d11f8e05fc86d9d1","type":"link in","z":"15cc9fb0e94d56cd","name":"[deadred] frontend","links":["530add3ac74f2fba"],"x":281.75,"y":285.5,"wires":[["b911a5c5b566fcfe"]]},{"id":"4e5fc022b6c49255","type":"switch","z":"15cc9fb0e94d56cd","name":"get paths","property":"req.path","propertyType":"msg","rules":[{"t":"regex","v":"^/credentials/.+/.+","vt":"str","case":true},{"t":"eq","v":"/flows","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":497,"y":381,"wires":[["aeb921545f5cb930"],["9567e0c0960791be"],["adfb4cba14f13528"]]},{"id":"b70a08baf6289565","type":"http response","z":"15cc9fb0e94d56cd","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":929,"y":264,"wires":[]},{"id":"d585b1fdd36073bd","type":"link call","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","links":["72ab63276a4a76f6"],"linkType":"static","timeout":"30","x":1611,"y":371,"wires":[["b45eafe6c234fd1b"]]},{"id":"30735a9b2b2429d2","type":"change","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","rules":[{"t":"set","p":"req.params.flid","pt":"msg","to":"67a6db53dc49ae4c","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1472,"y":500,"wires":[["d585b1fdd36073bd"]]},{"id":"6988e71a196b0aac","type":"function","z":"15cc9fb0e94d56cd","name":"create data structure requird for client","func":"msg.payload = {\n    flows: msg.payload,\n    rev: RED.util.generateId() + RED.util.generateId()\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2015,"y":281,"wires":[["b71d276dc6086f2c"]]},{"id":"b45eafe6c234fd1b","type":"json","z":"15cc9fb0e94d56cd","name":"","property":"payload","action":"","pretty":false,"x":1895,"y":371,"wires":[["6988e71a196b0aac"]]},{"id":"31166a4f1d48c2ee","type":"function","z":"15cc9fb0e94d56cd","name":"function 12","func":"msg.payload = {\n    rev: RED.util.generateId() + RED.util.generateId()\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":776,"y":578,"wires":[["3aff4940f41ca872"]]},{"id":"b911a5c5b566fcfe","type":"switch","z":"15cc9fb0e94d56cd","name":"POST or GET?","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":241,"y":373,"wires":[["4e5fc022b6c49255"],["2256ec0a4c041a89"]]},{"id":"2256ec0a4c041a89","type":"switch","z":"15cc9fb0e94d56cd","name":"post paths","property":"req.path","propertyType":"msg","rules":[{"t":"eq","v":"/flows","vt":"str"},{"t":"eq","v":"/nodes","vt":"str"},{"t":"eq","v":"/settings/user","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":490,"y":580,"wires":[["31166a4f1d48c2ee"],["31166a4f1d48c2ee"],["31166a4f1d48c2ee"],["297b31f099d63e56"]]},{"id":"2cde456edb1be7e9","type":"websocket in","z":"15cc9fb0e94d56cd","g":"71e12e12a2f4d2bd","name":"","server":"b3804011d211bca3","client":"","x":833,"y":919,"wires":[[]]},{"id":"d80b4dce46ac0750","type":"websocket out","z":"15cc9fb0e94d56cd","g":"71e12e12a2f4d2bd","name":"","server":"b3804011d211bca3","client":"","x":898,"y":975,"wires":[]},{"id":"9567e0c0960791be","type":"switch","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","property":"req.headers.referer","propertyType":"msg","rules":[{"t":"regex","v":"fhid=[a-z0-9]{16}","vt":"str","case":true},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":979,"y":378,"wires":[["a11f4e4b21c55af0"],["05556527c9fd23a0"]]},{"id":"a11f4e4b21c55af0","type":"function","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"retrieve from referrer","func":"let mth = msg.req.headers.referer.match( /fhid=(.{16})/)\n\nmsg.req.params.flid = mth[1]\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1292,"y":372,"wires":[["d585b1fdd36073bd"]]},{"id":"aeb921545f5cb930","type":"template","z":"15cc9fb0e94d56cd","name":"/credentials/.+/.+","field":"payload","fieldType":"msg","format":"json","syntax":"plain","template":"{}\n","output":"str","x":730,"y":263,"wires":[["b70a08baf6289565"]]},{"id":"05556527c9fd23a0","type":"switch","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","property":"req.headers['x-winloc']","propertyType":"msg","rules":[{"t":"regex","v":"fhid=[a-z0-9]{16}","vt":"str","case":true},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1042,"y":494,"wires":[["b3b29cfb6ef83822"],["30735a9b2b2429d2"]]},{"id":"b3b29cfb6ef83822","type":"function","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"retrieve from x-winloc header","func":"let mth = msg.req.header('x-winloc').match( /fhid=(.{16})/)\n\nmsg.req.params.flid = mth[1]\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1274,"y":436,"wires":[["d585b1fdd36073bd"]]},{"id":"3aff4940f41ca872","type":"http response","z":"15cc9fb0e94d56cd","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":958,"y":578,"wires":[]},{"id":"f9d9df91d34b19f8","type":"debug","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"debug 75","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"req.originalUrl","targetType":"msg","statusVal":"","statusType":"auto","x":559,"y":966,"wires":[]},{"id":"edd7686c50e5c47a","type":"http response","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"not found","statusCode":"404","headers":{},"x":568,"y":923,"wires":[]},{"id":"97b3b80a437340a4","type":"link in","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"[deadred] handle not found","links":["adfb4cba14f13528","297b31f099d63e56"],"x":357,"y":946,"wires":[["edd7686c50e5c47a","f9d9df91d34b19f8"]]},{"id":"adfb4cba14f13528","type":"link out","z":"15cc9fb0e94d56cd","name":"link out 124","mode":"link","links":["97b3b80a437340a4"],"x":645,"y":421,"wires":[]},{"id":"297b31f099d63e56","type":"link out","z":"15cc9fb0e94d56cd","name":"link out 125","mode":"link","links":["97b3b80a437340a4"],"x":634,"y":619,"wires":[]},{"id":"b71d276dc6086f2c","type":"http response","z":"15cc9fb0e94d56cd","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":2229,"y":209,"wires":[]},{"id":"b3804011d211bca3","type":"websocket-listener","path":"/comms","wholemsg":"false"}]