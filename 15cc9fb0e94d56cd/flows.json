[{"id":"15cc9fb0e94d56cd","type":"tab","label":"[deadred] minimal viable backend","disabled":false,"info":"# Deadred backend for a serverless Node-RED client\n\nProvides the minimum required dynamic input that a Node-RED client requires to start up and be useful.\n\nThe the frontend is hosted @ [GitHub](https://github.com/gorenje/cdn.flowhub.org) and can be accessed at [cdn.flowhub.org](https://cdn.flowhub.org).\n\nThe frontend is completely static including node and plugin definitions. This backend provides dynamic flow delivery so that the flow shown at startup can be influenced.\n\nThis is used at [flowhub.org](https://flowhub.org) for demonstrating how flows can be edited in Node-RED. For example, [this flow](https://cdn.flowhub.org/?fhid=15cc9fb0e94d56cd).\n\n\n--- \n\n<small>*[\"Better dead than red\"](https://en.wikipedia.org/wiki/Better_dead_than_red)*</small>","env":[]},{"id":"71e12e12a2f4d2bd","type":"group","z":"15cc9fb0e94d56cd","name":"prevent the not connected message in node-red","style":{"label":true},"nodes":["2cde456edb1be7e9","d80b4dce46ac0750"],"x":286,"y":1123,"w":309,"h":138},{"id":"673c71e09607ca7c","type":"group","z":"15cc9fb0e94d56cd","name":"flows.json is dynamically generated based on 2 different references","style":{"label":true},"nodes":["d585b1fdd36073bd","30735a9b2b2429d2","9567e0c0960791be","a11f4e4b21c55af0","05556527c9fd23a0","b3b29cfb6ef83822","6988e71a196b0aac","b45eafe6c234fd1b","b71d276dc6086f2c"],"x":922,"y":170.5,"w":1579,"h":210.5},{"id":"3be9e6565bc22bf3","type":"group","z":"15cc9fb0e94d56cd","name":"not found response","style":{"label":true},"nodes":["f9d9df91d34b19f8","edd7686c50e5c47a","97b3b80a437340a4"],"x":922,"y":402,"w":349,"h":125},{"id":"5639c1d6cd21c022","type":"group","z":"15cc9fb0e94d56cd","name":"FlowHubPush","style":{"label":true},"nodes":["4b5d8fb001f23133","5feaf4613bf569e8","58f68c88700a2795","af9ea73d2a291be5"],"x":921,"y":946.3333129882812,"w":483,"h":215.66668701171875},{"id":"ece99e85e967b5ce","type":"group","z":"15cc9fb0e94d56cd","name":"Flow Compare","style":{"label":true},"nodes":["782fbdf4d6da9fd8","0f278adc6eae43eb","2e7286a4d8f3ceb3","f6d510486f1c767c","184689445e5f2943","daf6c23f01f397a2"],"x":921,"y":683,"w":1010,"h":219},{"id":"40ae412cd86f16b5","type":"group","z":"15cc9fb0e94d56cd","name":"NodeFactory package loading","style":{"label":true},"nodes":["b63e72f536584143"],"x":921,"y":1370,"w":196,"h":82},{"id":"adab5681a06067fb","type":"group","z":"15cc9fb0e94d56cd","name":"FlowHubDiff","style":{"label":true},"nodes":["1d16d2318f13208b"],"x":921,"y":1245.6666666666667,"w":85,"h":82},{"id":"e48ded81eef1210f","type":"junction","z":"15cc9fb0e94d56cd","x":925.5497903823853,"y":579.4452621936798,"wires":[["8fd5ed779e69ea5e","915db6d43ff240ee"]]},{"id":"d11f8e05fc86d9d1","type":"link in","z":"15cc9fb0e94d56cd","name":"[deadred] backend","links":["530add3ac74f2fba"],"x":187.75,"y":505,"wires":[["b911a5c5b566fcfe"]]},{"id":"4e5fc022b6c49255","type":"switch","z":"15cc9fb0e94d56cd","name":"get paths","property":"req.path","propertyType":"msg","rules":[{"t":"eq","v":"/","vt":"str"},{"t":"regex","v":"^/credentials/.+/.+","vt":"str","case":true},{"t":"eq","v":"/flows","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":497,"y":211,"wires":[["d9edf3cc6e25a756"],["aeb921545f5cb930"],["9567e0c0960791be"],["adfb4cba14f13528"]]},{"id":"b70a08baf6289565","type":"http response","z":"15cc9fb0e94d56cd","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":989,"y":125,"wires":[]},{"id":"d585b1fdd36073bd","type":"link call","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","links":["72ab63276a4a76f6"],"linkType":"static","timeout":"30","x":1710,"y":211.5,"wires":[["b45eafe6c234fd1b"]]},{"id":"30735a9b2b2429d2","type":"change","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","rules":[{"t":"set","p":"req.params.flid","pt":"msg","to":"67a6db53dc49ae4c","tot":"str"},{"t":"set","p":"req.params.flid","pt":"msg","to":"ac7774554793f417","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1541,"y":340,"wires":[["d585b1fdd36073bd"]]},{"id":"6988e71a196b0aac","type":"function","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"create data structure requird for client","func":"msg.payload = {\n    flows: msg.payload,\n    rev: RED.util.generateId() + RED.util.generateId()\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2143,"y":211.5,"wires":[["b71d276dc6086f2c"]]},{"id":"b45eafe6c234fd1b","type":"json","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","property":"payload","action":"","pretty":false,"x":1895,"y":211.5,"wires":[["6988e71a196b0aac"]]},{"id":"b911a5c5b566fcfe","type":"switch","z":"15cc9fb0e94d56cd","name":"POST or GET?","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":312,"y":505,"wires":[["4e5fc022b6c49255"],["2256ec0a4c041a89"]]},{"id":"2256ec0a4c041a89","type":"switch","z":"15cc9fb0e94d56cd","name":"post paths","property":"req.path","propertyType":"msg","rules":[{"t":"eq","v":"/flows","vt":"str"},{"t":"eq","v":"/nodes","vt":"str"},{"t":"eq","v":"/settings/user","vt":"str"},{"t":"eq","v":"/FlowCompareCfg","vt":"str"},{"t":"eq","v":"/FlowHubPush","vt":"str"},{"t":"eq","v":"/FlowHubDiff","vt":"str"},{"t":"eq","v":"/NodeFactorySidebarCfg","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":8,"x":495,"y":829,"wires":[["e48ded81eef1210f"],["e48ded81eef1210f"],["e48ded81eef1210f"],["0f278adc6eae43eb","daf6c23f01f397a2"],["4b5d8fb001f23133"],["1d16d2318f13208b"],["b63e72f536584143"],["297b31f099d63e56"]]},{"id":"2cde456edb1be7e9","type":"websocket in","z":"15cc9fb0e94d56cd","g":"71e12e12a2f4d2bd","name":"","server":"b3804011d211bca3","client":"","x":382,"y":1164,"wires":[[]]},{"id":"d80b4dce46ac0750","type":"websocket out","z":"15cc9fb0e94d56cd","g":"71e12e12a2f4d2bd","name":"","server":"b3804011d211bca3","client":"","x":447,"y":1220,"wires":[]},{"id":"9567e0c0960791be","type":"switch","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","property":"req.headers.referer","propertyType":"msg","rules":[{"t":"regex","v":"fhid=[a-z0-9]{16}","vt":"str","case":true},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":998,"y":218,"wires":[["a11f4e4b21c55af0"],["05556527c9fd23a0"]]},{"id":"a11f4e4b21c55af0","type":"function","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"retrieve from referrer","func":"let mth = msg.req.headers.referer.match( /fhid=(.{16})/)\n\nmsg.req.params.flid = mth[1]\n\nmth = msg.req.headers.referer.match( /rev=([a-z0-9]{8,40})/i)\nif ( mth ) {\n    msg.payload = {\n        v: mth[1]\n    }\n}\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1391,"y":211.5,"wires":[["d585b1fdd36073bd"]]},{"id":"aeb921545f5cb930","type":"template","z":"15cc9fb0e94d56cd","name":"/credentials/.+/.+","field":"payload","fieldType":"msg","format":"json","syntax":"plain","template":"{}\n","output":"str","x":792,"y":125,"wires":[["b70a08baf6289565"]]},{"id":"05556527c9fd23a0","type":"switch","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"","property":"req.headers['x-winloc']","propertyType":"msg","rules":[{"t":"regex","v":"fhid=[a-z0-9]{16}","vt":"str","case":true},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1141,"y":334,"wires":[["b3b29cfb6ef83822"],["30735a9b2b2429d2"]]},{"id":"b3b29cfb6ef83822","type":"function","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"retrieve from x-winloc header","func":"let mth = msg.req.header('x-winloc').match(/fhid=(.{16})/)\n\nmsg.req.params.flid = mth[1]\n\nmth = msg.req.header('x-winloc').match(/rev=([a-z0-9]{8,40})/i)\nif ( mth ) {\n    msg.payload = {\n        v: mth[1]\n    }\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1373,"y":276,"wires":[["d585b1fdd36073bd"]]},{"id":"3aff4940f41ca872","type":"http response","z":"15cc9fb0e94d56cd","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":1868,"y":632,"wires":[]},{"id":"f9d9df91d34b19f8","type":"debug","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"debug 75","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.originalUrl","targetType":"msg","statusVal":"req.path","statusType":"msg","x":1165,"y":486,"wires":[]},{"id":"edd7686c50e5c47a","type":"http response","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"not found","statusCode":"404","headers":{},"x":1174,"y":443,"wires":[]},{"id":"97b3b80a437340a4","type":"link in","z":"15cc9fb0e94d56cd","g":"3be9e6565bc22bf3","name":"[deadred] handle not found","links":["adfb4cba14f13528","297b31f099d63e56"],"x":963,"y":466,"wires":[["edd7686c50e5c47a","f9d9df91d34b19f8"]]},{"id":"adfb4cba14f13528","type":"link out","z":"15cc9fb0e94d56cd","name":"link out 124","mode":"link","links":["97b3b80a437340a4"],"x":645,"y":261,"wires":[]},{"id":"297b31f099d63e56","type":"link out","z":"15cc9fb0e94d56cd","name":"link out 125","mode":"link","links":["97b3b80a437340a4"],"x":623,"y":1035,"wires":[]},{"id":"b71d276dc6086f2c","type":"http response","z":"15cc9fb0e94d56cd","g":"673c71e09607ca7c","name":"json","statusCode":"","headers":{"content-type":"application/json"},"x":2425,"y":211.5,"wires":[]},{"id":"d9edf3cc6e25a756","type":"change","z":"15cc9fb0e94d56cd","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"302","tot":"num"},{"t":"set","p":"_loc","pt":"msg","to":"'https://cdn.flowhub.org' & msg.req.originalUrl","tot":"jsonata"},{"t":"set","p":"headers","pt":"msg","to":"{ \"Location\": msg._loc }","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"\"<a href='\" & msg._loc & \"'>Redirect</a>\"","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":721,"y":51.5,"wires":[["b1b6e4de719a922f"]]},{"id":"b1b6e4de719a922f","type":"http response","z":"15cc9fb0e94d56cd","name":"redirect to cdn.flowhub.org","statusCode":"","headers":{},"x":986,"y":51.5,"wires":[]},{"id":"915db6d43ff240ee","type":"debug","z":"15cc9fb0e94d56cd","name":"debug 76","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"counter","x":1208,"y":579,"wires":[]},{"id":"8fd5ed779e69ea5e","type":"function","z":"15cc9fb0e94d56cd","name":"generate fake response","func":"msg.payload = {\n    rev: RED.util.generateId() + RED.util.generateId()\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1081,"y":632,"wires":[["3aff4940f41ca872"]]},{"id":"4b5d8fb001f23133","type":"function","z":"15cc9fb0e94d56cd","g":"5639c1d6cd21c022","name":"handle flow hub push","func":"// msg.req.set(\"X-Email\", msg.payload.cfgnode.email || \"nonset\")\n\nmsg.req.rawHeaders.push(\"X-Email\")\nmsg.req.rawHeaders.push(msg.payload.cfgnode.email)\n\nmsg.req.headers[\"X-Name\"] = msg.payload.cfgnode.fullname\nmsg.payload.pushcomment = msg.payload.cfgnode.pushcomment\n\nmsg.payload.email = msg.req.get('X-Email')\nmsg.payload.fullname = msg.req.get('X-Name')\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1047,"y":1053.3333333333335,"wires":[["5feaf4613bf569e8","58f68c88700a2795","af9ea73d2a291be5"]]},{"id":"5feaf4613bf569e8","type":"debug","z":"15cc9fb0e94d56cd","g":"5639c1d6cd21c022","name":"debug 78","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"counter","x":1298,"y":1053.3333740234375,"wires":[]},{"id":"782fbdf4d6da9fd8","type":"function","z":"15cc9fb0e94d56cd","g":"ece99e85e967b5ce","name":"handle flow compare","func":"function compareFlows(msg) {\n  var oldFlowRevision = {};\n  var newFlowRevision = {};\n\n  for (var idx = 0; idx < msg.payload.length; idx++) {\n    oldFlowRevision[msg.payload[idx].id] = msg.payload[idx]\n  }\n\n  for (var idx = 0; idx < msg.new_flowdata.length; idx++) {\n    newFlowRevision[msg.new_flowdata[idx].id] = msg.new_flowdata[idx]\n  }\n\n  var changes = []\n\n  /* nodes that have been deleted */\n  for (var idx = 0; idx < msg.payload.length; idx++) {\n    var oldObj = msg.payload[idx];\n\n    if (!newFlowRevision[oldObj.id]) {\n      changes.push({\n        type: \"deleted\",\n        id: oldObj.id,\n        oldObj: oldObj,\n        newObj: undefined\n      })\n    }\n  }\n\n  for (var idx = 0; idx < msg.new_flowdata.length; idx++) {\n    var newObj = msg.new_flowdata[idx];\n    var oldObj = oldFlowRevision[newObj.id];\n\n    if (!oldObj) {\n      changes.push({\n        type: \"added\",\n        id: newObj.id,\n        oldObj: undefined,\n        newObj: newObj\n      })\n    } else {\n      if (JSON.stringify(oldObj) != JSON.stringify(newObj)) {\n        changes.push({\n          type: \"changed\",\n          id: newObj.id,\n          oldObj: oldObj,\n          newObj: newObj\n        })\n      }\n    }\n  }\n\n  return changes;\n}\n\nlet nodes = msg.payload;\n\nmsg.payload = {\n  \"status\": \"ok\",\n  \"flowid\": msg.flowid,\n  \"nodes\": nodes,\n  \"changes\": compareFlows({ payload: nodes, new_flowdata: msg.flowdata })\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1610,"y":821,"wires":[["3aff4940f41ca872","f6d510486f1c767c"]]},{"id":"58f68c88700a2795","type":"http response","z":"15cc9fb0e94d56cd","g":"5639c1d6cd21c022","name":"","statusCode":"405","headers":{},"x":1313,"y":987.3333129882812,"wires":[]},{"id":"0f278adc6eae43eb","type":"change","z":"15cc9fb0e94d56cd","g":"ece99e85e967b5ce","name":"","rules":[{"t":"set","p":"req.params.flid","pt":"msg","to":"payload.flowid","tot":"msg"},{"t":"set","p":"flowdata","pt":"msg","to":"payload.flowdata","tot":"msg","dc":true},{"t":"set","p":"flowid","pt":"msg","to":"payload.flowid","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1027,"y":821,"wires":[["2e7286a4d8f3ceb3"]]},{"id":"2e7286a4d8f3ceb3","type":"link call","z":"15cc9fb0e94d56cd","g":"ece99e85e967b5ce","name":"","links":["72ab63276a4a76f6"],"linkType":"static","timeout":"30","x":1238,"y":821,"wires":[["184689445e5f2943"]]},{"id":"f6d510486f1c767c","type":"debug","z":"15cc9fb0e94d56cd","g":"ece99e85e967b5ce","name":"debug 79","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"counter","x":1825,"y":861,"wires":[]},{"id":"184689445e5f2943","type":"json","z":"15cc9fb0e94d56cd","g":"ece99e85e967b5ce","name":"","property":"payload","action":"","pretty":false,"x":1419,"y":821,"wires":[["782fbdf4d6da9fd8"]]},{"id":"daf6c23f01f397a2","type":"function","z":"15cc9fb0e94d56cd","d":true,"g":"ece99e85e967b5ce","name":"handle flow compare - noop","func":"msg.payload = {\n  \"status\": \"ok\",\n  \"flowid\": msg.payload.flowid,\n  \"nodes\": msg.payload.flowdata,\n  \"changes\": []\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1445,"y":724,"wires":[["3aff4940f41ca872"]]},{"id":"b63e72f536584143","type":"http response","z":"15cc9fb0e94d56cd","g":"40ae412cd86f16b5","name":"","statusCode":"405","headers":{},"x":1007,"y":1411,"wires":[]},{"id":"1d16d2318f13208b","type":"link out","z":"15cc9fb0e94d56cd","g":"adab5681a06067fb","name":"flowhub diff flow","mode":"link","links":["78dc51861b2dc8d1"],"x":962,"y":1286.6666666666667,"wires":[]},{"id":"af9ea73d2a291be5","type":"link out","z":"15cc9fb0e94d56cd","d":true,"g":"5639c1d6cd21c022","name":"push submission flow","mode":"link","links":["4f6edf6c73dffc5a"],"x":1270,"y":1121,"wires":[]},{"id":"b3804011d211bca3","type":"websocket-listener","path":"/comms","wholemsg":"false"}]