[{"id":"e46be6066ea2231c","type":"tab","label":"[Web] Benchmarking requests","disabled":false,"info":"::: aim\n\nTo build a simple [ab](https://httpd.apache.org/docs/2.4/programs/ab.html) tool for simulating website traffic.\n\n:::\n\n::: warning\n\nThis flow contains Http-In endpoinst definitions that could interrupt existing endpoints and services or open your Node-RED installation to malicious attacks.\n\n:::\n\n::: palette\n\n- [node-red-dashboard](https://flows.nodered.org/node/node-red-dashboard)\n\n:::\n\n<!--\n// [] [tab] \"[Web] Benchmarking requests\" - e46be6066ea2231c\n// [] [group] \"Define endpoint for testing - assumed to be connected to localhost:1800\" - 4f370f0a01427fa2\n// [] [group] \"test button\" - 6bf9baeaba1ea6df\n// [] [group] \"\" - 5ea92899c308965f\n// [] [group] \"handle results and update graph\" - 0f0c46ada8e678c0\n// [] [group] \"handle requests concurrently\" - 3055dea84895f5f6\n// [] [group] \"dashboard input elements\" - 3e5b59ceaa703583\n// [] [group] \"initial values\" - fc26cbac040d4f16\n// [] [inject] \"set url and count\" - 4de89aba64f6a744\n// [] [function] \"create count number of messages \\n with requestTimeout\" - c5071dcbcf7ced38\n// [] [split] \"\" - bfb961534391079d\n// [] [http request] \"\" - b17afc78fb472d40\n// [] [catch] \"\" - e6be7a5009f301b6\n// [] [join] \"\" - 5f78cbafd3481358\n// [] [http in] \"\" - 68b5f5cc96af4dfc\n// [] [http response] \"\" - d4f4d119f907475a\n// [] [function] \"group by statusCode\" - ebfe60187962ec1d\n// [] [delay] \"Random delay between 0.5 and 4 seconds\" - b3176bfe3e920a9a\n// [] [change] \"Set random status code either 200 or 404 or 500\" - f569c0f5674297ed\n// [] [debug] \"results of first resultset\" - 1de2adbf5b60cbba\n// [] [ui_chart] \"chart\" - 3eb18afccbc7b415\n// [] [ui_button] \"Go!\" - 0ce9aa4abb433919\n// [] [ui_numeric] \"count\" - 3ab21275fe27a799\n// [] [ui_text_input] \"URL\" - fdac928f5002b118\n// [] [change] \"\" - ea436141fe6f8a22\n// [] [change] \"\" - 17dee616c2ff7322\n// [] [change] \"\" - da30c45c53fe81f8\n// [] [debug] \"debug 42\" - 0d53d825d5888fa8\n// [] [inject] \"http:&#x2F;&#x2F;localhost:1880&#x2F;end&#x2F;point\" - 10f30e247db695bb\n// [] [inject] \"300\" - 1a10ef3b878e77b1\n// [] [ui_numeric] \"timeout\" - ab23b3dd21dfb8cb\n// [] [change] \"\" - 5d69ca94805c687c\n// [] [inject] \"2000\" - 7f86b2c53f48718e\n// [] [ui_group] \"Request Benchmarking\" - 26cb9ede1b16da67\n// [] [ui_tab] \"Benchmark\" - eed79fd69cef6849\n-->\n\n\n::: explanation\n\nThe flow defines a dashboard for <a class=\"ahl-group-only\" data-ids=\"3e5b59ceaa703583\">configuration of the inputs</a>, this group being <a class=\"ahl-group-only\" data-ids=\"fc26cbac040d4f16\">initialised by injects</a> that are triggered on flow restart. Inputs to the flow are:\n\n- `url` is the target endpoint for testing\n- `requestTimeout` is the maximums time (in milliseconds) that the <a class=\"ahl-node-only\" data-ids=\"b17afc78fb472d40\">http request node</a> will wait for a request to complete\n- `req_count` is the number of requests to be made to the endpoint.\n\nThese attributes must be set on the `msg` object passed into the flow via the <a class=\"ahl-node-only\" data-ids=\"c5071dcbcf7ced38\">function node</a>. These are set by the <a class=\"ahl-group-only\" data-ids=\"6bf9baeaba1ea6df\">testing button</a> and the <a class=\"ahl-link-node\" data-ids=\"0ce9aa4abb433919,da30c45c53fe81f8\">Go! button</a>.\n\nThere is a <a class=\"ahl-group-only\" data-ids=\"6bf9baeaba1ea6df\">testing button</a> for testing out the setup. For testing purposes there is also an <a class=\"ahl-group-only\" data-ids=\"4f370f0a01427fa2\">internal server defined</a> that generates random HTTP status including time outs by delaying longer the request timeout.\n\nBy setting a <a class=\"ahl-link-node\" data-ids=\"ab23b3dd21dfb8cb,5d69ca94805c687c\">`requestTimeout`</a>, this benchmarking does not record the average time it takes for a request rather it describes that number of requests that completed within the timeout period. The <a class=\"ahl-group-only\" data-ids=\"0f0c46ada8e678c0\">graph details</a> are generated after all requests have completed.\n\nThe core of the flow is the <a class=\"ahl-group-only\" data-ids=\"5ea92899c308965f\">function node</a> that generates an array of URL requests. The array has `req_count` entries because the <a class=\"ahl-group-only\" data-ids=\"3055dea84895f5f6\">split/join group</a> splits this array and the generates all the requests concurrently. This is the advantage of the split/join approach as the parallelism comes for free by the nature of the underlying Node.js-based Node-RED engine.\n\n\n:::\n\n\n### Dashboard\n\n![img](https://cdn.openmindmap.org/content/1692818649416_Screen_Shot_2023-08-23_at_21.22.05.png)\n\n### Related flows\n\n- [Request timeout](https://flowhub.org/f/60871bf5eadd6d7f) on http requests.","env":[]},{"id":"4f370f0a01427fa2","type":"group","z":"e46be6066ea2231c","name":"Define endpoint for testing - assumed to be connected to localhost:1800","style":{"label":true},"nodes":["68b5f5cc96af4dfc","d4f4d119f907475a","b3176bfe3e920a9a","f569c0f5674297ed"],"x":1552.66650390625,"y":664.2083539962769,"w":934,"h":166},{"id":"6bf9baeaba1ea6df","type":"group","z":"e46be6066ea2231c","name":"test button","style":{"label":true},"nodes":["4de89aba64f6a744"],"x":381.6666259765625,"y":400.6666660308838,"w":232,"h":82},{"id":"5ea92899c308965f","type":"group","z":"e46be6066ea2231c","name":"","style":{"label":true},"nodes":["c5071dcbcf7ced38"],"x":873.6666259765625,"y":388.6666660308838,"w":332,"h":106},{"id":"0f0c46ada8e678c0","type":"group","z":"e46be6066ea2231c","name":"handle results and update graph","style":{"label":true},"nodes":["ebfe60187962ec1d","1de2adbf5b60cbba","3eb18afccbc7b415"],"x":1921.6666259765625,"y":454.66668701171875,"w":564.9998779296875,"h":134.99997901916504},{"id":"3055dea84895f5f6","type":"group","z":"e46be6066ea2231c","name":"handle requests concurrently","style":{"label":true},"nodes":["bfb961534391079d","b17afc78fb472d40","e6be7a5009f301b6","5f78cbafd3481358"],"x":1250.6666259765625,"y":383.6666660308838,"w":646,"h":111},{"id":"3e5b59ceaa703583","type":"group","z":"e46be6066ea2231c","name":"dashboard input elements","style":{"label":true},"nodes":["0ce9aa4abb433919","3ab21275fe27a799","fdac928f5002b118","ea436141fe6f8a22","17dee616c2ff7322","da30c45c53fe81f8","ab23b3dd21dfb8cb","5d69ca94805c687c"],"x":381.6666259765625,"y":505.6666660308838,"w":469,"h":324.54168796539307},{"id":"fc26cbac040d4f16","type":"group","z":"e46be6066ea2231c","name":"initial values","style":{"label":true},"nodes":["10f30e247db695bb","1a10ef3b878e77b1","7f86b2c53f48718e"],"x":29,"y":586.8889090220134,"w":332,"h":243.31944497426343},{"id":"4de89aba64f6a744","type":"inject","z":"e46be6066ea2231c","g":"6bf9baeaba1ea6df","name":"set url and count","props":[{"p":"url","v":"http://localhost:1880/end/point","vt":"str"},{"p":"req_count","v":"300","vt":"num"},{"p":"requestTimeout","v":"1500","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":507.6666259765625,"y":441.6666660308838,"wires":[["c5071dcbcf7ced38"]]},{"id":"c5071dcbcf7ced38","type":"function","z":"e46be6066ea2231c","g":"5ea92899c308965f","name":"create count number of messages \\n with requestTimeout","func":"msg.payload = [];\n\nfor ( var idx = 0 ; idx < msg.req_count; idx++ ) {\n    msg.payload.push({\n        ...msg\n    })\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1039.6666259765625,"y":441.6666660308838,"wires":[["bfb961534391079d"]]},{"id":"bfb961534391079d","type":"split","z":"e46be6066ea2231c","g":"3055dea84895f5f6","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1326.6666259765625,"y":453.6666660308838,"wires":[["b17afc78fb472d40"]]},{"id":"b17afc78fb472d40","type":"http request","z":"e46be6066ea2231c","g":"3055dea84895f5f6","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1573.6666259765625,"y":453.6666660308838,"wires":[["5f78cbafd3481358"]]},{"id":"e6be7a5009f301b6","type":"catch","z":"e46be6066ea2231c","g":"3055dea84895f5f6","name":"","scope":["b17afc78fb472d40"],"uncaught":false,"x":1607.6666259765625,"y":424.6666660308838,"wires":[[]]},{"id":"5f78cbafd3481358","type":"join","z":"e46be6066ea2231c","g":"3055dea84895f5f6","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1820.6666259765625,"y":453.6666660308838,"wires":[["ebfe60187962ec1d"]]},{"id":"68b5f5cc96af4dfc","type":"http in","z":"e46be6066ea2231c","g":"4f370f0a01427fa2","name":"","url":"/end/point","method":"get","upload":false,"swaggerDoc":"","x":1658.66650390625,"y":789.2083539962769,"wires":[["b3176bfe3e920a9a"]]},{"id":"d4f4d119f907475a","type":"http response","z":"e46be6066ea2231c","g":"4f370f0a01427fa2","name":"","statusCode":"","headers":{},"x":2410.66650390625,"y":705.2083539962769,"wires":[]},{"id":"ebfe60187962ec1d","type":"function","z":"e46be6066ea2231c","g":"0f0c46ada8e678c0","name":"group by statusCode","func":"var newpload = {};\n\nfor ( var idx = 0; idx < msg.payload.length; idx++ ) {\n    (newpload[msg.payload[idx].statusCode] ||= []).push(msg.payload[idx])\n}\n\nvar labels = [];\nvar data = [];\n\nvar keys = Object.keys(newpload);\n\nfor ( var idx = 0 ; idx < keys.length; idx++ ) {\n    labels.push( keys[idx]);\n    data.push( newpload[ keys[ idx ] ].length );\n}\nmsg.payload = [{\n    \"series\": [\"x\"],\n    \"data\": [ data ],\n    \"labels\": labels\n}];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2047.6666259765625,"y":495.66668701171875,"wires":[["1de2adbf5b60cbba","3eb18afccbc7b415"]]},{"id":"b3176bfe3e920a9a","type":"delay","z":"e46be6066ea2231c","g":"4f370f0a01427fa2","name":"Random delay between 0.5 and 4 seconds","pauseType":"random","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"500","randomLast":"4000","randomUnits":"milliseconds","drop":false,"allowrate":false,"outputs":1,"x":2042.66650390625,"y":789.2083539962769,"wires":[["f569c0f5674297ed"]]},{"id":"f569c0f5674297ed","type":"change","z":"e46be6066ea2231c","g":"4f370f0a01427fa2","name":"Set random status code either 200 or 404 or 500","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"$random() > 0.6 ? 404 : ($random() > 0.3 ? 500 : 200)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2063.66650390625,"y":705.2083539962769,"wires":[["d4f4d119f907475a"]]},{"id":"1de2adbf5b60cbba","type":"debug","z":"e46be6066ea2231c","g":"0f0c46ada8e678c0","name":"results of first resultset","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2340.66650390625,"y":496.66668701171875,"wires":[]},{"id":"3eb18afccbc7b415","type":"ui_chart","z":"e46be6066ea2231c","g":"0f0c46ada8e678c0","name":"","group":"26cb9ede1b16da67","order":0,"width":0,"height":0,"label":"chart","chartType":"horizontalBar","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":2308.6666259765625,"y":548.6666660308838,"wires":[[]]},{"id":"0ce9aa4abb433919","type":"ui_button","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"","group":"26cb9ede1b16da67","order":3,"width":0,"height":0,"passthru":false,"label":"Go!","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":457.6666259765625,"y":546.6666660308838,"wires":[["da30c45c53fe81f8"]]},{"id":"3ab21275fe27a799","type":"ui_numeric","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"","label":"count","tooltip":"","group":"26cb9ede1b16da67","order":2,"width":0,"height":0,"wrap":false,"passthru":true,"topic":"count","topicType":"str","format":"{{value}}","min":0,"max":"10000","step":"10","className":"","x":457.6666259765625,"y":627.5138953526815,"wires":[["17dee616c2ff7322"]]},{"id":"fdac928f5002b118","type":"ui_text_input","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"","label":"URL","tooltip":"URL","group":"26cb9ede1b16da67","order":1,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"url","sendOnBlur":false,"className":"","topicType":"str","x":457.6666259765625,"y":708.3611246744792,"wires":[["ea436141fe6f8a22"]]},{"id":"ea436141fe6f8a22","type":"change","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"set flow.url","rules":[{"t":"set","p":"url","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":674.6666259765625,"y":707.7777980168661,"wires":[[]]},{"id":"17dee616c2ff7322","type":"change","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"set flow.count","rules":[{"t":"set","p":"count","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":684.6666259765625,"y":627.8889090220134,"wires":[[]]},{"id":"da30c45c53fe81f8","type":"change","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"copy flow details to msg ","rules":[{"t":"set","p":"url","pt":"msg","to":"url","tot":"flow"},{"t":"set","p":"req_count","pt":"msg","to":"count","tot":"flow"},{"t":"set","p":"payload","pt":"msg","to":"[]","tot":"json"},{"t":"set","p":"requestTimeout","pt":"msg","to":"requestTimeout","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":714.6666259765625,"y":546.6666660308838,"wires":[["0d53d825d5888fa8","3eb18afccbc7b415","c5071dcbcf7ced38"]]},{"id":"0d53d825d5888fa8","type":"debug","z":"e46be6066ea2231c","name":"debug 42","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1030.6666259765625,"y":587.6666660308838,"wires":[]},{"id":"10f30e247db695bb","type":"inject","z":"e46be6066ea2231c","g":"fc26cbac040d4f16","name":"http://localhost:1880/end/point","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"http://localhost:1880/end/point","payloadType":"str","x":205,"y":708.7777980168661,"wires":[["fdac928f5002b118","ea436141fe6f8a22"]]},{"id":"1a10ef3b878e77b1","type":"inject","z":"e46be6066ea2231c","g":"fc26cbac040d4f16","name":"300","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"300","payloadType":"num","x":125,"y":627.8889090220134,"wires":[["3ab21275fe27a799","17dee616c2ff7322"]]},{"id":"ab23b3dd21dfb8cb","type":"ui_numeric","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"","label":"timeout","tooltip":"","group":"26cb9ede1b16da67","order":2,"width":0,"height":0,"wrap":true,"passthru":true,"topic":"timeout","topicType":"str","format":"{{value}}","min":0,"max":"10000","step":"100","className":"","x":467.6666259765625,"y":789.2083539962769,"wires":[["5d69ca94805c687c"]]},{"id":"5d69ca94805c687c","type":"change","z":"e46be6066ea2231c","g":"3e5b59ceaa703583","name":"set flow.requestTimeout","rules":[{"t":"set","p":"requestTimeout","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":714.6666259765625,"y":789.2083539962769,"wires":[[]]},{"id":"7f86b2c53f48718e","type":"inject","z":"e46be6066ea2231c","g":"fc26cbac040d4f16","name":"2000","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"2000","payloadType":"num","x":125.3333740234375,"y":789.2083539962769,"wires":[["ab23b3dd21dfb8cb","5d69ca94805c687c"]]},{"id":"26cb9ede1b16da67","type":"ui_group","name":"Request Benchmarking","tab":"eed79fd69cef6849","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"eed79fd69cef6849","type":"ui_tab","name":"Benchmark","icon":"dashboard","disabled":false,"hidden":false}]