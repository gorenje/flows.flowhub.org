[{"id":"49221ed0e76e27c3","type":"tab","label":"[Swagger] An API for Scroll pHAT","disabled":false,"info":"::: aim\n\nDefining a [Swagger](https://en.wikipedia.org/wiki/OpenAPI_Specification) OpenAPI for the I2C-based [Scroll pHAT](https://github.com/pimoroni/scroll-phat) LED board.\n\n:::\n\n::: warning\n\nThis flow contains Http-In endpoinst definitions that could interrupt existing endpoints and services or open your Node-RED installation to malicious attacks.\n\n:::\n\n::: palette\n\n- [node-red-node-swagger](https://flows.nodered.org/node/node-red-node-swagger) - [github](node-red-node-swagger)\n\n:::\n\n::: requirements\n\nInstallation of the <a href=\"https://flowhub.org/f/be2109bba90b6c5a\">flow for interfacing</a> with the Scroll pHAT. This is assumed to be installed.\n\n:::\n\n### Flow Explanation\n\nThe flow begins with three <a class=\"ahl-group-only\" data-ids=\"09fcd412777de621\">API endpoints</a> that allow the user to toggle pixels on and off and set the brightness for the entire display. The Swagger definitions are included in the http-in nodes, there aren't any extra nodes for Swagger definitions.\n\nThe nodes behind the http-in nodes are the <a class=\"ahl-group-only\" data-ids=\"61bc1dfd39ea0a43\">integer parsers and action intrepretors</a> these function nodes simply setup the message for further processing. Any exceptions that occur here are <a class=\"ahl-link-node\" data-ids=\"80c7bc61ceb98959,d83e278353ad2985\">caught and send to 404 not found-land</a>.\n\n\n\nIf all goes well, the Swagger definition for this flow will be accessible at [http://localhost:1880/http-api/swagger.json](http://localhost:1880/http-api/swagger.json) - if running Node-RED on localhost and port 1880.\n\nIf you don't have a Scroll pHAT board, then go to the dashboard - there will be a 5 x 11 array of switches displayed that will be toggled accordingly. This virtual display is defined by the <a href=\"https://flowhub.org/f/be2109bba90b6c5a\">Scroll pHAT</a> flow.\n\n\n### Related flows\n\n- <a href=\"https://flowhub.org/f/be2109bba90b6c5a\">Flow for interfacing</a> with the Scroll pHAT.\n\n- <a href=\"https://flowhub.org/f/81d46dabe68094e4\">Flow for doing a ticker</a> with the Scroll pHAT.\n\n","env":[]},{"id":"bc59b489bda1dacf","type":"group","z":"49221ed0e76e27c3","name":"Respond: 404 - not found","style":{"label":true},"nodes":["d83e278353ad2985","0f06c3a94c1e2774","eda2ccc80ee653a5"],"x":1351,"y":372.5,"w":455,"h":107},{"id":"09fcd412777de621","type":"group","z":"49221ed0e76e27c3","name":"API endpoints","style":{"label":true},"nodes":["b6b44010bed48b97","127aadbd180d5ca0","7a68f23cad7fadc4"],"x":133,"y":455,"w":272,"h":329},{"id":"66da78e9a29bc89b","type":"group","z":"49221ed0e76e27c3","name":"I2C interaction","style":{"label":true},"nodes":["5031135bc60eb1ab","213ead979035ac25","808f931788e5cf71","8a8c4bc4e56d4ed9"],"x":1838,"y":498,"w":99,"h":299},{"id":"5d01eeca4c733e31","type":"group","z":"49221ed0e76e27c3","name":"Respond: 200 - status ok","style":{"label":true},"nodes":["ab7f3e1da6e1b158","488779d4bb4a4ff2"],"x":1392,"y":645,"w":377,"h":82},{"id":"61bc1dfd39ea0a43","type":"group","z":"49221ed0e76e27c3","name":"parse integers and setup message object","style":{"label":true},"nodes":["e559d9a4df03dd71","73387382d2f06a07","a8ad6b4d3c808645"],"x":593,"y":455,"w":267,"h":329},{"id":"bc61f3c146ebeaad","type":"group","z":"49221ed0e76e27c3","name":"Check value ranges","style":{"label":true},"nodes":["fafd4b742ca6d27a","ed1b376dac4b0f4c","5e971003d917ca3a","64611a7df34e8d18"],"x":901,"y":509.5,"w":411,"h":282},{"id":"b6b44010bed48b97","type":"http in","z":"49221ed0e76e27c3","g":"09fcd412777de621","name":"","url":"/v1/:col/:row/:action","method":"put","upload":false,"swaggerDoc":"b03169b37284de35","x":269,"y":496,"wires":[["e559d9a4df03dd71"]]},{"id":"fafd4b742ca6d27a","type":"switch","z":"49221ed0e76e27c3","g":"bc61f3c146ebeaad","name":"check col","property":"col","propertyType":"msg","rules":[{"t":"gt","v":"11","vt":"num"},{"t":"lt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":987,"y":558,"wires":[["d83e278353ad2985"],["d83e278353ad2985"],["ed1b376dac4b0f4c"]]},{"id":"e559d9a4df03dd71","type":"function","z":"49221ed0e76e27c3","g":"61bc1dfd39ea0a43","name":"create message","func":"return {\n    ...msg,\n    col: parseInt( msg.req.params.col ),\n    row: parseInt(msg.req.params.row),\n    payload: msg.req.params.action == \"on\"\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":699,"y":496,"wires":[["fafd4b742ca6d27a"]]},{"id":"127aadbd180d5ca0","type":"http in","z":"49221ed0e76e27c3","g":"09fcd412777de621","name":"","url":"/v1/:col/:action","method":"put","upload":false,"swaggerDoc":"65a4cafca3800930","x":249,"y":631,"wires":[["395809587ee2c48f"]]},{"id":"ed1b376dac4b0f4c","type":"switch","z":"49221ed0e76e27c3","g":"bc61f3c146ebeaad","name":"check row","property":"row","propertyType":"msg","rules":[{"t":"lt","v":"0","vt":"str"},{"t":"gt","v":"5","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":1195,"y":571,"wires":[["d83e278353ad2985"],["d83e278353ad2985"],["f22e9cce69d23150","488779d4bb4a4ff2"]]},{"id":"d83e278353ad2985","type":"function","z":"49221ed0e76e27c3","g":"bc59b489bda1dacf","name":"not found","func":"msg.statusCode = 404;\nmsg.payload = {\n    status: \"not_found\",\n    msg: \"page not found\",\n    path: msg.req.originalUrl\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1537,"y":438.5,"wires":[["0f06c3a94c1e2774"]]},{"id":"0f06c3a94c1e2774","type":"http response","z":"49221ed0e76e27c3","g":"bc59b489bda1dacf","name":"","statusCode":"","headers":{},"x":1730,"y":438.5,"wires":[]},{"id":"eda2ccc80ee653a5","type":"link in","z":"49221ed0e76e27c3","g":"bc59b489bda1dacf","name":"[resp] 404","links":["df2d2aabe8f52c1c","9589cae62b6982b3","64611a7df34e8d18"],"x":1392,"y":413.5,"wires":[["d83e278353ad2985"]]},{"id":"73387382d2f06a07","type":"function","z":"49221ed0e76e27c3","g":"61bc1dfd39ea0a43","name":"create message","func":"return {\n    ...msg,\n    col: parseInt( msg.req.params.col ),\n    row: 0,\n    payload: msg.req.params.action == \"on\"\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":699,"y":558,"wires":[["fafd4b742ca6d27a"]]},{"id":"f22e9cce69d23150","type":"function","z":"49221ed0e76e27c3","name":"intrepret column and row values","func":"// if col or row is zero, then all leds in a row or a col respectively is meant\nif ( msg.col == 0 && msg.row == 0 ) {\n    if ( msg.payload ){\n        msg.payload = {\n            status: \"ok\",\n            action: \"all-on\"\n        }\n        node.send([undefined, msg, undefined])\n    } else {\n        msg.payload = {\n            status: \"ok\",\n            action: \"all-off\"\n        }\n        node.send([msg, undefined, undefined])\n    }\n    \n    return undefined;\n}\n\nif ( msg.col == 0 ) {\n    for ( var idx = 1; idx < 12; idx++ ) {\n        node.send([undefined,undefined, {\n            ...msg,\n            col: idx\n        }])\n    }\n    return undefined;\n}\n\n\nif (msg.row == 0) {\n    for (var idx = 1; idx < 6; idx++) {\n        node.send([undefined, undefined, {\n            ...msg,\n            row: idx\n        }])\n    }\n    return undefined;\n}\n\n\nreturn [undefined,undefined,msg];","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1598,"y":584,"wires":[["5031135bc60eb1ab"],["213ead979035ac25"],["808f931788e5cf71"]],"outputLabels":["reset all off","reset all on","set pixel"]},{"id":"5031135bc60eb1ab","type":"link out","z":"49221ed0e76e27c3","g":"66da78e9a29bc89b","name":"link out 3","mode":"link","links":["259bf8083e21a786"],"x":1879,"y":539,"wires":[]},{"id":"213ead979035ac25","type":"link out","z":"49221ed0e76e27c3","g":"66da78e9a29bc89b","name":"link out 4","mode":"link","links":["b1a6d68cec9a6f89"],"x":1879,"y":584,"wires":[]},{"id":"ab7f3e1da6e1b158","type":"http response","z":"49221ed0e76e27c3","g":"5d01eeca4c733e31","name":"","statusCode":"200","headers":{"content-type":"application/json"},"x":1683,"y":686,"wires":[]},{"id":"488779d4bb4a4ff2","type":"change","z":"49221ed0e76e27c3","g":"5d01eeca4c733e31","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"status\": \"ok\" }","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1498,"y":686,"wires":[["ab7f3e1da6e1b158"]]},{"id":"808f931788e5cf71","type":"link out","z":"49221ed0e76e27c3","g":"66da78e9a29bc89b","name":"link out 5","mode":"link","links":["53d3662bddce099d"],"x":1879,"y":628,"wires":[]},{"id":"7a68f23cad7fadc4","type":"http in","z":"49221ed0e76e27c3","g":"09fcd412777de621","name":"","url":"/v1/:val/brightness","method":"put","upload":false,"swaggerDoc":"42a29ca7a8e0fab5","x":261,"y":743,"wires":[["a8ad6b4d3c808645"]]},{"id":"395809587ee2c48f","type":"switch","z":"49221ed0e76e27c3","name":"","property":"req.params.action","propertyType":"msg","rules":[{"t":"eq","v":"brightness","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":484,"y":631,"wires":[["a8ad6b4d3c808645"],["73387382d2f06a07"]]},{"id":"a8ad6b4d3c808645","type":"function","z":"49221ed0e76e27c3","g":"61bc1dfd39ea0a43","name":"create message","func":"return {\n    ...msg,\n    payload: parseInt(msg.req.params.col|| msg.req.params.val )\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":699,"y":743,"wires":[["5e971003d917ca3a"]]},{"id":"5e971003d917ca3a","type":"switch","z":"49221ed0e76e27c3","g":"bc61f3c146ebeaad","name":"check val","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"127","vt":"num"},{"t":"lt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1077,"y":743,"wires":[["64611a7df34e8d18"],["64611a7df34e8d18"],["8a8c4bc4e56d4ed9","488779d4bb4a4ff2"]]},{"id":"64611a7df34e8d18","type":"link out","z":"49221ed0e76e27c3","g":"bc61f3c146ebeaad","name":"link out 6","mode":"link","links":["eda2ccc80ee653a5"],"x":1271,"y":674,"wires":[]},{"id":"8a8c4bc4e56d4ed9","type":"link out","z":"49221ed0e76e27c3","g":"66da78e9a29bc89b","name":"link out 7","mode":"link","links":["b6db635a0b4a4bfc"],"x":1879,"y":756,"wires":[]},{"id":"80c7bc61ceb98959","type":"catch","z":"49221ed0e76e27c3","name":"","scope":["e559d9a4df03dd71","73387382d2f06a07","a8ad6b4d3c808645"],"uncaught":false,"x":795,"y":438,"wires":[["d83e278353ad2985"]]},{"id":"b03169b37284de35","type":"swagger-doc","summary":"Toggle on a pixel a specific column and row","description":"Endpoint can used to either turn on or turn off a single pixel, a row of pixels or a column. A call with col = 0 and row = 0 will affect the entire display, either all on or all off.","tags":"","consumes":"","produces":"","parameters":[{"name":"col","in":"path","description":"Specify the column. A value between 0 and 11 (incl.). Zero means the entire column.","required":true,"type":"number"},{"name":"row","in":"path","description":"Specify the row. A value between 0 and 5 (incl.). Zero means the entire row.","required":true,"type":"number"},{"name":"action","in":"path","description":"The action to be performed, must either be 'on' or 'off'.","required":true,"type":"string"}],"responses":{"200":{"description":"All went well and the pixel is now on. Status value will be 'ok'","schema":{"properties":{"status":{"type":"string"}}}},"404":{"description":"Pixel not found, out of bounds."},"500":{"description":"Head for the hills."}},"deprecated":false},{"id":"65a4cafca3800930","type":"swagger-doc","summary":"Toggle on a pixel a specific column and row","description":"This is the equivalent of the row value being zero, that is an entire column is affected by the action.","tags":"","consumes":"","produces":"","parameters":[{"name":"col","in":"path","description":"A value between 0 and 11 giving the column index.","required":true,"type":"number"},{"name":"action","in":"path","description":"Either 'on' of 'off' meaning toggle the pixel on or off.","required":true,"type":"string"}],"responses":{"200":{"description":"All went well and the pixel is now on or off. Status value will always be 'ok'","schema":{"properties":{"status":{"type":"string"}}}},"404":{"description":"Pixel not found, out of bounds"},"500":{"description":"Head for the hills."}},"deprecated":false},{"id":"42a29ca7a8e0fab5","type":"swagger-doc","summary":"Set display brightness.","description":"Set the brightness of the entire display. Zero is off and 127 is the brightest.","tags":"","consumes":"","produces":"","parameters":[{"name":"val","in":"path","description":"The brightness value from 0 (off) to 127 (brightest) - range is inclusive.","required":true,"type":"number"}],"responses":{"200":{"description":"All went well and the pixel is now on or off. Status value will always be 'ok'","schema":{"properties":{"status":{"type":"string"}}}},"404":{"description":"Pixel not found, out of bounds"},"500":{"description":"Head for the hills."}},"deprecated":false}]