[{"id":"bc9878770c1350d8","type":"tab","label":"[LinkedIn] Create post","disabled":false,"info":"This is a continuation of the [LinkedIn OAuth flow](https://flowhub.org/f/fafd7c807c192d4a). Once the user has accepted, this flow obtains an `access_token` using the `linked-code` provided by the [previous flow](https://flowhub.org/f/fafd7c807c192d4a). The flow then creates a post in the users feed.\n\nThis flows uses the <a class='ahl-node-only' data-ids='8d25f069742ef57e'>`BlogPages` node</a> that provides details on the page to be posted into the users feed. This provides the title, summary and image for the blog page. These are added to the post on LinkedIn. What attributes are required can be seen in the <a class=\"ahl-node-only\" data-ids=\"f9e3f4bf655bb434\">final function node</a>, the code is below.\n\nEnvironment variables:\n\n- `LINKEDIN_CLIENT_ID` which is the client id of the application defined at LinkedIn\n- `LINKEDIN_OAUTH_REDIRECT_URL` is the authentication redirect URL set in the application\n- `LINKEDIN_CLIENT_SECRET` this is the secret is set as part of the definition of the LinkedIn application\n\n### Sequence Diagram\n\n```mermaid\nsequenceDiagram\n    Flow->>Flow: Obtain blog page details\n    Flow->>LinkedIn (oauth): provide access_token for linkedin code\n    LinkedIn (oauth)->>Flow: access_token for user\n    Flow->>Flow: store access_token and prepare to obtain user_id\n    Flow->>LinkedIn (api): provide user_id\n    LinkedIn (api)->>Flow: user_id\n    Flow->>Flow: prepare details for automatic post for LinkedIn\n    Flow->>LinkedIn (api): post share with page details on users feed\n```\n\n### Code\n\nThe <a class=\"ahl-node-only\" data-ids=\"f9e3f4bf655bb434\">final function node</a> does all the heavy lifting, creating the content for the post.\n\n### External resources\n\n- [Obtaining File URN](https://learn.microsoft.com/en-us/linkedin/marketing/integrations/community-management/shares/images-api)\n- [File Upload](https://learn.microsoft.com/en-us/linkedin/marketing/integrations/community-management/shares/vector-asset-api?view=li-lms-2023-08&tabs=http#upload-the-image)\n- [Creating an Image Share](https://learn.microsoft.com/en-gb/linkedin/consumer/integrations/self-serve/share-on-linkedin#create-an-image-share)\n\n","env":[]},{"id":"57903d257285b7a0","type":"group","z":"bc9878770c1350d8","name":"Image Upload","style":{"label":true},"nodes":["085329c843b45987","3dd532bf638759d1","1bceb48602c17df8","3d8e1d77e158d4b5","f023f4a4172231f3","21570917cab492d1","bce51bcc6c866e66","f14fc04057c02c98","0a43fa87c4c08318","48cdd02b54fb5087"],"x":674,"y":691,"w":1703,"h":243},{"id":"b4b4245da2a27e4d","type":"function","z":"bc9878770c1350d8","name":"setup request for access token","func":"var data = {\n    \"client_id\":     process.env.LINKEDIN_CLIENT_ID,\n    \"code\":          msg.lnkdCode,\n    \"client_secret\": process.env.LINKEDIN_CLIENT_SECRET,\n    \"grant_type\":    \"authorization_code\",\n    \"redirect_uri\":  process.env.LINKEDIN_OAUTH_REDIRECT_URL,\n};\n\nmsg.payload = querystring.stringify(data);\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":893,"y":246,"wires":[["a359c3e8adc3a5bd"]]},{"id":"a359c3e8adc3a5bd","type":"http request","z":"bc9878770c1350d8","name":"obtain access token","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://www.linkedin.com/oauth/v2/accessToken","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"Content-Type","keyValue":"","valueType":"other","valueValue":"application/x-www-form-urlencoded"}],"x":1195,"y":246,"wires":[["b93c3fb8dd7543c6"]]},{"id":"b93c3fb8dd7543c6","type":"switch","z":"bc9878770c1350d8","name":"did we get an access_token?","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1195,"y":311.125,"wires":[["14fda90faedd4962"]]},{"id":"251d2e9c879669f7","type":"http request","z":"bc9878770c1350d8","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.linkedin.com/v2/me","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1195,"y":441.375,"wires":[["a9c228c644fe7151"]]},{"id":"14fda90faedd4962","type":"function","z":"bc9878770c1350d8","name":"obtain user_id for the urn","func":"\nmsg.access_token = msg.payload.access_token;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1195,"y":376.25,"wires":[["251d2e9c879669f7"]]},{"id":"4f168abc1486eb3b","type":"function","z":"bc9878770c1350d8","name":"set msg.user_urn and msg.headers","func":"msg.user_id = msg.payload.id;\nmsg.user_urn = \"urn:li:person:\" + msg.user_id;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1195,"y":571.625,"wires":[["e534b9b4141e8063"]]},{"id":"c970ae1048092f75","type":"http request","z":"bc9878770c1350d8","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1455,"y":1057,"wires":[[]]},{"id":"8d25f069742ef57e","type":"BlogPages","z":"bc9878770c1350d8","name":"","x":541,"y":355,"wires":[["704a67a823cf9701"]]},{"id":"704a67a823cf9701","type":"function","z":"bc9878770c1350d8","name":"find blogpage details","func":"msg.blogPageDetailsForPost = undefined;\n\nmsg.blogpages.forEach( function(dtls){\n    if ( dtls.path == msg.pageData.path ) {\n        msg.blogPageDetailsForPost = dtls;\n    }\n})\n\nif (msg.blogPageDetailsForPost ) { \n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":584,"y":431,"wires":[["a7ceef65726d2bce"]]},{"id":"e534b9b4141e8063","type":"switch","z":"bc9878770c1350d8","name":"do we have blog page details?","property":"blogPageDetailsForPost","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":1195,"y":636.75,"wires":[["085329c843b45987"],[]]},{"id":"a9c228c644fe7151","type":"switch","z":"bc9878770c1350d8","name":"was response status 200?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1195,"y":506.5,"wires":[["4f168abc1486eb3b"]]},{"id":"a7ceef65726d2bce","type":"link call","z":"bc9878770c1350d8","name":"","links":["66b4e598cb114802"],"linkType":"static","timeout":"30","x":631,"y":509,"wires":[["b4b4245da2a27e4d"]]},{"id":"33696d8422ca8eaf","type":"link in","z":"bc9878770c1350d8","name":"[linkedin] create share with page details","links":["28a8bf2eb4990d81"],"x":500,"y":250,"wires":[["8d25f069742ef57e"]]},{"id":"085329c843b45987","type":"switch","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"do we have preview image?","property":"blogPageDetailsForPost.image","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":820,"y":825,"wires":[["1bceb48602c17df8","3d8e1d77e158d4b5"],["8f8e542df6872488"]]},{"id":"3dd532bf638759d1","type":"http request","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"request upload url","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1545,"y":818,"wires":[["21570917cab492d1"]]},{"id":"8f8e542df6872488","type":"function","z":"bc9878770c1350d8","name":"publish article share with title, summary and canonical URL","func":"msg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token,\n    \"X-Restli-Protocol-Version\": \"2.0.0\"\n}\n\nmsg.payload = {\n    \"author\": msg.user_urn,\n    \"lifecycleState\": \"PUBLISHED\", /* for testing DRAFT - but won't find it on LinkedIn */\n    \"specificContent\": {\n        \"com.linkedin.ugc.ShareContent\": {\n            \"shareCommentary\": {\n                \"text\": msg.blogPageDetailsForPost.title +\n                    \"\\n\\n\" + msg.blogPageDetailsForPost.summary +\n                    \"\\n\\n\" + (msg.blogPageDetailsForPost.tags || \"node-red,visualweb\").split(\",\").map(function (d) { return \"#\" + d; }).join(\",\") +\n                    \"\\n\\n\" + \"Great article would scan it again in an instance -- ChatGPT.\"\n            },\n            \"shareMediaCategory\": \"ARTICLE\",\n            \"media\": [\n                {\n                    \"status\": \"READY\",\n                    \"description\": {\n                        \"text\": msg.blogPageDetailsForPost.summary\n                    },\n                    \"originalUrl\": msg.pageData.curl, /* + \"?cb=\" + RED.util.generateId(), */\n                    \"title\": {\n                        \"text\": msg.blogPageDetailsForPost.title\n                    },\n                }\n            ]\n        }\n    },\n    \"visibility\": {\n        \"com.linkedin.ugc.MemberNetworkVisibility\": \"PUBLIC\"\n    }\n};\n\nif (msg.image_urn) {\n    msg.payload.specificContent[\"com.linkedin.ugc.ShareContent\"].media[0][\"media\"] = msg.image_urn;\n    msg.payload.specificContent[\"com.linkedin.ugc.ShareContent\"].shareMediaCategory = \"IMAGE\";\n\n    msg.payload.specificContent[\"com.linkedin.ugc.ShareContent\"].shareCommentary.text = (\n        msg.blogPageDetailsForPost.title +\n        \"\\n\\n\" + msg.blogPageDetailsForPost.summary +\n        \"\\n\\n\" + \"Link to Post: \" + msg.pageData.curl +\n        \"\\n\\n\" + (msg.blogPageDetailsForPost.tags || \"node-red,visualweb\").split(\",\").map(function (d) { return \"#\" + d; }).join(\",\") +\n        \"\\n\\n\" + \"Great article would scan it again in an instance -- ChatGPT.\"\n    );\n}\n\nmsg.url = \"https://api.linkedin.com/v2/ugcPosts\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1429,"y":986,"wires":[["c970ae1048092f75"]]},{"id":"1bceb48602c17df8","type":"function","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"prepare request to obtain uploadURL","func":"msg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token,\n    \"X-Restli-Protocol-Version\": \"2.0.0\",\n    \"LinkedIn-Version\": \"202308\"\n}\n\nmsg.url = \"https://api.linkedin.com/v2/assets?action=registerUpload\";\n\nmsg.payload = {\n    \"registerUploadRequest\": {\n        \"recipes\": [\n            \"urn:li:digitalmediaRecipe:feedshare-image\"\n        ],\n        \"owner\": msg.user_urn,\n        \"serviceRelationships\": [\n            {\n                \"relationshipType\": \"OWNER\",\n                \"identifier\": \"urn:li:userGeneratedContent\"\n            }\n        ]\n    }\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1250,"y":818,"wires":[["3dd532bf638759d1"]]},{"id":"3d8e1d77e158d4b5","type":"function","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"retrieve image data","func":"msg.url = msg.blogdetails.cdn_url + \"/content/\" + msg.blogPageDetailsForPost.image;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1232,"y":762,"wires":[["f023f4a4172231f3"]]},{"id":"f023f4a4172231f3","type":"http request","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"","method":"GET","ret":"bin","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1481,"y":761,"wires":[["21570917cab492d1"]]},{"id":"21570917cab492d1","type":"join","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"15","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1779,"y":762,"wires":[["0a43fa87c4c08318"]]},{"id":"bce51bcc6c866e66","type":"function","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"buffer first","func":"msg.url = msg.payload[1].value.uploadMechanism[\"com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest\"].uploadUrl;\nmsg.image_urn = msg.payload[1].value.asset;\n\nmsg.headers = {\n   ...msg.payload[1].value.uploadMechanism[\"com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest\"].headers,\n   \"Authorization\": \"Bearer \" + msg.access_token\n}\n\nmsg.payload = msg.payload[0];\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2088,"y":732,"wires":[["f14fc04057c02c98"]]},{"id":"f14fc04057c02c98","type":"http request","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":2281,"y":893,"wires":[["8f8e542df6872488"]]},{"id":"0a43fa87c4c08318","type":"switch","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"","property":"payload[0]","propertyType":"msg","rules":[{"t":"istype","v":"buffer","vt":"buffer"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1927,"y":762,"wires":[["bce51bcc6c866e66"],["48cdd02b54fb5087"]]},{"id":"48cdd02b54fb5087","type":"function","z":"bc9878770c1350d8","g":"57903d257285b7a0","name":"object first","func":"msg.url = msg.payload[0].value.uploadMechanism[\"com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest\"].uploadUrl;\nmsg.image_urn = msg.payload[0].value.asset;\n\nmsg.headers = {\n   ...msg.payload[0].value.uploadMechanism[\"com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest\"].headers,\n   \"Authorization\": \"Bearer \" + msg.access_token\n}\n\nmsg.payload = msg.payload[1];\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2063,"y":793,"wires":[["f14fc04057c02c98"]]}]