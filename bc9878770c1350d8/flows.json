[{"id":"bc9878770c1350d8","type":"tab","label":"[LinkedIn] Create post","disabled":false,"info":"This is a continuation of the [LinkedIn OAuth flow](https://flowhub.org/f/fafd7c807c192d4a). Once the user has accepted, this flow obtains an `access_token` using the `linked-code` provided by the [previous flow](https://flowhub.org/f/fafd7c807c192d4a). The flow then creates a post in the users feed.\n\nThis flows uses the `BlogPages` node that provides details on the page to be posted in the users feed. This provides the title, summary and image for the blog page. These are added to the post on LinkedIn.\n\nEnvironment variables:\n\n- `LINKEDIN_CLIENT_ID` which is the client id of the application defined at LinkedIn\n- `LINKEDIN_OAUTH_REDIRECT_URL` is the authentication redirect URL set in the application\n- `LINKEDIN_CLIENT_SECRET` this is the secret is set as part of the definition of the LinkedIn application\n\n\n```mermaid\nsequenceDiagram\n    OMM->>OMM: Obtain blog page details\n    OMM->>LinkedIn (oauth): provide access_token for linkedin code\n    LinkedIn (oauth)->>OMM: access_token for user\n    OMM->>OMM: store access_token and prepare to obtain user_id\n    OMM->>LinkedIn (api): provide user_id\n    LinkedIn (api)->>OMM: user_id\n    OMM->>OMM: prepare details for automatic post for LinkedIn\n    OMM->>LinkedIn (api): post share with page details on users feed\n```\n\nVersions:\n\n- 31/07: clarification that two different linkedin servers are involved\n- 31/07: updated documentation\n- added initial documentation\n","env":[]},{"id":"e97c8686cc868af5","type":"group","z":"bc9878770c1350d8","name":"Obtain user access token to create a post in name of the user","style":{"label":true,"label-position":"sw"},"nodes":["b4b4245da2a27e4d","a359c3e8adc3a5bd","b93c3fb8dd7543c6","251d2e9c879669f7","14fda90faedd4962","4f168abc1486eb3b","c970ae1048092f75","8d25f069742ef57e","704a67a823cf9701","e534b9b4141e8063","f9e3f4bf655bb434","a9c228c644fe7151","a7ceef65726d2bce","33696d8422ca8eaf"],"x":445,"y":205,"w":996,"h":611},{"id":"b4b4245da2a27e4d","type":"function","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"setup request for access token","func":"var data = {\n    \"client_id\":     process.env.LINKEDIN_CLIENT_ID,\n    \"code\":          msg.lnkdCode,\n    \"client_secret\": process.env.LINKEDIN_CLIENT_SECRET,\n    \"grant_type\":    \"authorization_code\",\n    \"redirect_uri\":  process.env.LINKEDIN_OAUTH_REDIRECT_URL,\n};\n\nmsg.payload = querystring.stringify(data);\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":893,"y":246,"wires":[["a359c3e8adc3a5bd"]]},{"id":"a359c3e8adc3a5bd","type":"http request","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"obtain access token","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://www.linkedin.com/oauth/v2/accessToken","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"Content-Type","keyValue":"","valueType":"other","valueValue":"application/x-www-form-urlencoded"}],"x":1195,"y":246,"wires":[["b93c3fb8dd7543c6"]]},{"id":"b93c3fb8dd7543c6","type":"switch","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"did we get an access_token?","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1195,"y":311.125,"wires":[["14fda90faedd4962"]]},{"id":"251d2e9c879669f7","type":"http request","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.linkedin.com/v2/me","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1195,"y":441.375,"wires":[["a9c228c644fe7151"]]},{"id":"14fda90faedd4962","type":"function","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"obtain user_id for the urn","func":"\nmsg.access_token = msg.payload.access_token;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1195,"y":376.25,"wires":[["251d2e9c879669f7"]]},{"id":"4f168abc1486eb3b","type":"function","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"set msg.user_urn and msg.headers","func":"msg.user_id = msg.payload.id;\nmsg.user_urn = \"urn:li:person:\" + msg.user_id;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1195,"y":571.625,"wires":[["e534b9b4141e8063"]]},{"id":"c970ae1048092f75","type":"http request","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://api.linkedin.com/v2/ugcPosts","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"other","keyValue":"X-Restli-Protocol-Version","valueType":"other","valueValue":"2.0.0"}],"x":1195,"y":767,"wires":[[]]},{"id":"8d25f069742ef57e","type":"BlogPages","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"","x":541,"y":355,"wires":[["704a67a823cf9701"]]},{"id":"704a67a823cf9701","type":"function","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"find blogpage details","func":"msg.blogPageDetailsForPost = undefined;\n\nmsg.blogpages.forEach( function(dtls){\n    if ( dtls.path == msg.pageData.path ) {\n        msg.blogPageDetailsForPost = dtls;\n    }\n})\n\nif (msg.blogPageDetailsForPost ) { \n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":584,"y":431,"wires":[["a7ceef65726d2bce"]]},{"id":"e534b9b4141e8063","type":"switch","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"do we have blog page details?","property":"blogPageDetailsForPost","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":1195,"y":636.75,"wires":[["f9e3f4bf655bb434"],[]]},{"id":"f9e3f4bf655bb434","type":"function","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"publish article share with title, summary and canonical URL","func":"msg.payload = {\n    \"author\": msg.user_urn,\n        \"lifecycleState\": \"PUBLISHED\", /* for testing DRAFT - but won't find it on LinkedIn */\n            \"specificContent\": {\n        \"com.linkedin.ugc.ShareContent\": {\n            \"shareCommentary\": {\n                \"text\": msg.blogPageDetailsForPost.title + \n                   \"\\n\\n\" + msg.blogPageDetailsForPost.summary + \n                   \"\\n\\n\" + (msg.blogPageDetailsForPost.tags || \"node-red,visualweb\").split(\",\").map(function (d) { return \"#\" + d; }).join(\",\") + \n                   \"\\n\\n\" + \"Great article would scan it again in an instance -- ChatGPT.\"\n            },\n            \"shareMediaCategory\": \"ARTICLE\",\n                \"media\": [\n                    {\n                        \"status\": \"READY\",\n                        \"description\": {\n                            \"text\": msg.blogPageDetailsForPost.summary\n                        },\n                        \"originalUrl\": msg.pageData.curl, /* + \"?cb=\" + RED.util.generateId(), */\n                        \"title\": {\n                            \"text\": msg.blogPageDetailsForPost.title\n                        }, \n                    }\n                ]\n        }\n    },\n    \"visibility\": {\n        \"com.linkedin.ugc.MemberNetworkVisibility\": \"PUBLIC\"\n    }\n};\n\nif (msg.blogPageDetailsForPost.image) {\n    msg.payload.specificContent[\"com.linkedin.ugc.ShareContent\"].media[0][\"media\"] = msg.blogdetails.cdn_url + \"/content/\" + msg.blogPageDetailsForPost.image;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1195,"y":701.875,"wires":[["c970ae1048092f75"]]},{"id":"a9c228c644fe7151","type":"switch","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"was response status 200?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1195,"y":506.5,"wires":[["4f168abc1486eb3b"]]},{"id":"a7ceef65726d2bce","type":"link call","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"","links":["66b4e598cb114802"],"linkType":"static","timeout":"30","x":631,"y":509,"wires":[["b4b4245da2a27e4d"]]},{"id":"33696d8422ca8eaf","type":"link in","z":"bc9878770c1350d8","g":"e97c8686cc868af5","name":"[linkedin] create share with page details","links":["28a8bf2eb4990d81"],"x":500,"y":250,"wires":[["8d25f069742ef57e"]]}]