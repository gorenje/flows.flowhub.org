[{"id":"291e3f0b7f652839","type":"tab","label":"[Experimental] Auto-layout using Elkjs","disabled":false,"info":"::: aim\n\nAim is to do autolayout in Node-RED. In this case, using [elkjs](https://github.com/kieler/elkjs)\n\n:::\n\n::: warning\n\nThis does script injecting including a [javascript](https://cdn.openmindmap.org/thirdparty/elk.bundled.js) from cdn.openmindmap.org -- if this is not your thing, don't press the button.\n\n:::\n\n::: explanation\n\nAlways remember: undo works - ctrl/cmd-Z is your friend!\n\nPress the <a class=\"ahl-node-only\" data-ids=\"2f815def5c9ceee8\">button</a> and all the nodes will be layed out.\n\nThe <a class=\"ahl-node-only\" data-ids=\"38e96bc44d6425fe\">client code</a> contains the Javascript that controls Elkjs. Checkout the [options over at GitHub](https://github.com/kieler/elkjs#api), the current settings are just a first attempt.\n\n:::\n\n::: discussion\n\nWhy Elkjs? It seemed to be the simplest to implement from this [list](https://discourse.nodered.org/t/noisecraft-anyone-heard-of-it/79813/26?u=gregorius). I am no layout specialist but it seems to be fairly well used and also have many options.\n\n:::","env":[]},{"id":"38e96bc44d6425fe","type":"ClientCode","z":"291e3f0b7f652839","name":"using elkjs - algorithm: box","clientcode":"/* \n    Source:\n    https://stackoverflow.com/questions/14644558/call-javascript-function-after-script-is-loaded\n*/\nfunction loadScript(url, callback) {\n    var script = document.createElement(\"script\")\n    script.type = \"text/javascript\";\n\n    if (script.readyState) {  // only required for IE <9\n        script.onreadystatechange = function () {\n            if (script.readyState === \"loaded\" || script.readyState === \"complete\") {\n                script.onreadystatechange = null;\n                callback();\n            }\n        };\n    } else {  //Others\n        script.onload = function () {\n            callback();\n        };\n    }\n\n    script.src = url;\n    document.getElementsByTagName(\"head\")[0].appendChild(script);\n}\n\nloadScript(\"https://cdn.openmindmap.org/thirdparty/elk.bundled.js\", () => {\n    var activeWorkspace = RED.workspaces.active();\n    var nodes = RED.nodes.groups(activeWorkspace);\n\n    nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));\n    nodes = nodes.concat(RED.nodes.filterNodes({ z: activeWorkspace }));\n\n    RED.nodes.eachConfig(function (n) {\n        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {\n            // Grab any config nodes scoped to this flow that don't\n            // require any flow-nodes to use them\n            nodes.push(n);\n        }\n    });\n\n    var parentNode = RED.nodes.workspace(\n        activeWorkspace\n    ) || RED.nodes.subflow(activeWorkspace);\n\n    nodes.unshift(parentNode);\n\n    // Convert nodes to flows.json format since all the wires, i.e. links, are \n    // contained in one simple json format.\n    var allnodes = RED.nodes.createExportableNodeSet(nodes).filter( (n) => {\n        return n.type != \"tab\" && n.type != 'subflow' && n.type != \"group\"\n    });\n\n    var alledges = [];\n    allnodes.forEach((n) => {\n        for ( var widx = 0; widx < n.wires.length; widx++ ) {\n            for (var xidx = 0; xidx < n.wires[widx].length; xidx++) {\n                alledges.push({\n                    id: n.id + n.wires[widx][xidx],\n                    sources: [n.id],\n                    targets: [n.wires[widx][xidx]]\n                });\n            }\n        }\n    })\n\n    allnodes = allnodes.map( (n) => {\n        var bse = {}\n        if (n.id == \"c320cb70c5bfbe4a\") {\n            bse.x = n.x;\n            bse.y = n.y;\n        } \n        \n        return {\n            ...bse,\n            id: n.id,\n            width: document.getElementById(n.id).getBBox().width + 3,\n            height: document.getElementById(n.id).getBBox().height + 3,\n        }\n    });\n\n    // see https://github.com/kieler/elkjs#api for more details\n    var graph = {\n        id: \"root\",\n        layoutOptions: { \n            'algorithm': 'box' ,\n            'childAreaHeight': 4500,\n            'childAreaWidth': 4500,\n        },\n        children: allnodes,\n        edges: alledges\n    };\n\n    const elk = new ELK();\n\n    elk.layout(graph)\n        .then((g) => { \n            var changedNodes = [];\n            \n            g.children.forEach( (c) => {\n                var nd = RED.nodes.node(c.id);\n\n                changedNodes.push({\n                    n: nd,\n                    ox: nd.x,\n                    oy: nd.y,\n                    moved: nd.moved\n                });\n\n                nd.x = c.x;\n                nd.y = c.y;\n                nd.dirty = true;\n            });\n            \n            RED.history.push({ t: \"move\", nodes: changedNodes, dirty: RED.nodes.dirty() });\n            RED.nodes.dirty(true);\n            RED.view.redraw(true);\n            \n            node.send({ type: \"ok\", payload: g})\n        })\n        .catch((g) => { node.send({ type: \"error\", payload: g }) });\n})\n","format":"javascript","x":467,"y":230,"wires":[["fdd29440a0cd8efa"]]},{"id":"2f815def5c9ceee8","type":"inject","z":"291e3f0b7f652839","name":"2. press me","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":259,"y":144,"wires":[["38e96bc44d6425fe"]]},{"id":"fdd29440a0cd8efa","type":"debug","z":"291e3f0b7f652839","name":"debug 26","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":577,"y":305,"wires":[]},{"id":"05534e3b006dad20","type":"inject","z":"291e3f0b7f652839","name":"set RSS url","props":[{"p":"url","v":"https://flows.flowhub.org/feed.xml","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":1101.25,"y":905,"wires":[["3e4f153eee015ca8"]]},{"id":"3e4f153eee015ca8","type":"http request","z":"291e3f0b7f652839","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1087.25,"y":751,"wires":[["80878b57a4a7b987"]]},{"id":"80878b57a4a7b987","type":"xml","z":"291e3f0b7f652839","name":"parse feed.xml","property":"payload","attr":"","chr":"","x":946.25,"y":904,"wires":[["d09f478e227e15cb"]]},{"id":"d9dbc40774430342","type":"split","z":"291e3f0b7f652839","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1183.25,"y":870,"wires":[["df39eeb7ede52617"]]},{"id":"d09f478e227e15cb","type":"change","z":"291e3f0b7f652839","name":"set payload and define fake tab Z id","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.feed.entry","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":941.2499999999999,"y":821,"wires":[["d9dbc40774430342"]]},{"id":"df39eeb7ede52617","type":"function","z":"291e3f0b7f652839","name":"convert xml object to flow object","func":"msg.payload = {\n    \"id\": msg.payload.id[0].match(/.{16}$/)[0],\n    \"type\": \"comment\",\n    \"name\": msg.payload.title[0][\"_\"],\n    \"info\": msg.payload.id[0],\n    \"x\": 801 * Math.random(),\n    \"y\": 699 * Math.random(),\n    \"wires\": [\n    ]\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210.25,"y":957,"wires":[["f904e5d7dfd0929c"]]},{"id":"f904e5d7dfd0929c","type":"join","z":"291e3f0b7f652839","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1022.25,"y":957,"wires":[["c6d8a513b8218670"]]},{"id":"c6d8a513b8218670","type":"function","z":"291e3f0b7f652839","name":"prepend the subflow to the nodes array","func":"msg.payload = {\n    flowContent: msg.payload,\n    removeduplicates: true,\n    autoimport: false\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1251.25,"y":875,"wires":[["0c8bccda071ba88a"]]},{"id":"0c8bccda071ba88a","type":"ClientCode","z":"291e3f0b7f652839","name":"Open import dialog","clientcode":"function doIt() {\n  var content = payload.flowContent;\n\n  if (payload.removeduplicates) {\n    content = content.filter((elem) => {\n      return RED.nodes.node(elem.id) == undefined\n    });\n  }\n\n  if (content.length == 0) {\n    RED.notify(\"No new content\", {\n      type: \"ok\",\n      id: \"TriggerImport\",\n      timeout: 2000\n    });\n    return;\n  }\n  RED.clipboard.import();\n\n  setTimeout(() => {\n    $('#red-ui-clipboard-dialog-import-text').val(\n      JSON.stringify(content)\n    ).trigger(\"paste\");\n\n    if (payload.autoimport) {\n      setTimeout(() => {\n        $('#red-ui-clipboard-dialog-ok').trigger('click');\n      }, 435);\n    }\n  }, 300);\n};\n\ndoIt();\n","format":"javascript","x":1353,"y":950.20849609375,"wires":[[]]},{"id":"c320cb70c5bfbe4a","type":"inject","z":"291e3f0b7f652839","name":"1. select me!","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":398.999948501587,"y":1244.000147819519,"wires":[["bfe94f70f628c689"]]},{"id":"bfe94f70f628c689","type":"switch","z":"291e3f0b7f652839","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":521.8570747375489,"y":1205.4287366867065,"wires":[["f40c37c12f099df4","2fafc08fdbb02db8","6bd42b145ad99bb1"]]},{"id":"f40c37c12f099df4","type":"change","z":"291e3f0b7f652839","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":594.7142562866212,"y":1266.857343673706,"wires":[["f780d1657f149243","b946dcd1a11d761a"]]},{"id":"2fafc08fdbb02db8","type":"debug","z":"291e3f0b7f652839","name":"debug 23","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":556.1427841186525,"y":1175.4286661148071,"wires":[]},{"id":"f780d1657f149243","type":"switch","z":"291e3f0b7f652839","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":604.7142066955568,"y":1219.7144513130188,"wires":[["33807c37c1f6faea"]]},{"id":"6bd42b145ad99bb1","type":"link out","z":"291e3f0b7f652839","name":"link out 1","mode":"link","links":[],"x":648.999933242798,"y":1218.2858428955078,"wires":[]},{"id":"b946dcd1a11d761a","type":"debug","z":"291e3f0b7f652839","name":"debug 24","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":601.8571014404298,"y":1268.2858781814575,"wires":[]},{"id":"33807c37c1f6faea","type":"template","z":"291e3f0b7f652839","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"This is the payload: {{payload}} !","output":"str","x":577.5713653564454,"y":1192.571611404419,"wires":[[]]},{"id":"821ed929c72480b8","type":"ClientCode","z":"291e3f0b7f652839","name":"load elkjs","clientcode":"/* \n    Source:\n    https://stackoverflow.com/questions/14644558/call-javascript-function-after-script-is-loaded\n*/\nfunction loadScript(url, callback) {\n    var script = document.createElement(\"script\")\n    script.type = \"text/javascript\";\n\n    if (script.readyState) {  // only required for IE <9\n        script.onreadystatechange = function () {\n            if (script.readyState === \"loaded\" || script.readyState === \"complete\") {\n                script.onreadystatechange = null;\n                callback();\n            }\n        };\n    } else {  //Others\n        script.onload = function () {\n            callback();\n        };\n    }\n\n    script.src = url;\n    document.getElementsByTagName(\"head\")[0].appendChild(script);\n}\n\nloadScript(\"https://cdn.openmindmap.org/thirdparty/elk.bundled.js\", () => {\n    node.send({\n        topic: topic,\n        payload: payload\n    })\n})\n","format":"javascript","x":300,"y":459,"wires":[["6651c4800ee8569e"]]},{"id":"a286b57446e4e2ba","type":"inject","z":"291e3f0b7f652839","name":"2. press me","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":145,"y":336,"wires":[["821ed929c72480b8"]]},{"id":"6651c4800ee8569e","type":"ClientCode","z":"291e3f0b7f652839","name":"elkjs: possible layout options","clientcode":"const elk = new ELK();\n\nelk.knownLayoutOptions().then( (pload) => {\n    node.send({\n        payload: pload\n    })\n});","format":"javascript","x":529,"y":479,"wires":[["4ba8fd83db2b2fe3"]]},{"id":"4ba8fd83db2b2fe3","type":"debug","z":"291e3f0b7f652839","name":"debug 27","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":782,"y":508,"wires":[]}]