[{"id":"fafd7c807c192d4a","type":"tab","label":"LinkedIn Share Link","disabled":false,"info":"","env":[]},{"id":"f48ded87e4acda10","type":"group","z":"fafd7c807c192d4a","name":"LinkedIn 3-legged OAuth flow for their API","style":{"label":true,"label-position":"sw"},"nodes":["b5fb5a9ce78fae0f","4988ab72d0598e7b","76a6893125fce042","55afb9b8644dc5b6","558954f850c7b0a4","300312ac02300f6b","3c2665ad0dccf564","d9bdfe90dda135a9","44db952972d39946","f86f6914caae55bf"],"x":161,"y":61,"w":1338,"h":475,"info":"This implements the following flow:\n\n![img](https://cdn.openmindmap.org/content/1687328049231_oauth-3-legged-flow_highres.png)"},{"id":"e97c8686cc868af5","type":"group","z":"fafd7c807c192d4a","name":"Use the access_token to create a post in name of the user","style":{"label":true,"label-position":"sw"},"nodes":["b4b4245da2a27e4d","a359c3e8adc3a5bd","b93c3fb8dd7543c6","251d2e9c879669f7","14fda90faedd4962","4f168abc1486eb3b","c970ae1048092f75","8d25f069742ef57e","704a67a823cf9701","e534b9b4141e8063","f9e3f4bf655bb434","a9c228c644fe7151","a7ceef65726d2bce"],"x":866,"y":773,"w":996,"h":611},{"id":"b5fb5a9ce78fae0f","type":"http response","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"Response","statusCode":"","headers":{},"x":1370,"y":202,"wires":[]},{"id":"4988ab72d0598e7b","type":"http in","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","url":"/auth/linkedin/callback","method":"get","upload":false,"swaggerDoc":"","x":308,"y":290,"wires":[["3c2665ad0dccf564"]]},{"id":"76a6893125fce042","type":"change","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"200 post will be created","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"200","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"post will be created","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":984,"y":388,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"55afb9b8644dc5b6","type":"comment","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"This implements LinkedIns 3-legged dog - https://learn.microsoft.com/en-gb/linkedin/shared/authentication/authorization-code-flow?context=linkedin%2Fconsumer%2Fcontext&tabs=HTTPS1","info":"[Link](https://learn.microsoft.com/en-gb/linkedin/shared/authentication/authorization-code-flow?context=linkedin%2Fconsumer%2Fcontext&tabs=HTTPS1)\n\nThis implements the following flow:\n\n![img](https://cdn.openmindmap.org/content/1687328049231_oauth-3-legged-flow_highres.png)","x":843,"y":102,"wires":[]},{"id":"558954f850c7b0a4","type":"http in","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","url":"/share/post-on/linkedin","method":"get","upload":false,"swaggerDoc":"","x":307,"y":202,"wires":[["300312ac02300f6b"]]},{"id":"300312ac02300f6b","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"setup link for redirect to linkedin (ensure referrer and curl match)","func":"var data = {\n    \"client_id\": process.env.LINKEDIN_CLIENT_ID,\n    \"scope\": \"w_member_social r_liteprofile r_emailaddress\",\n    \"response_type\": \"code\",\n    \"redirect_uri\": \"https://blog.openmindmap.org/auth/linkedin/callback\",\n    \"state\": RED.util.generateId()\n};\n\n/* Store the state value to compare it on the callback call */\nvar lnkdStates = context.flow.get(\"lnkdstates\") || {};\n\nif (msg.req.headers[\"referer\"] == msg.payload.curl ) {\n    lnkdStates[data.state] = {\n        state: data.state,\n        curl: msg.payload.curl,\n        path: msg.payload.p\n    }\n} else {\n    lnkdStates[data.state] = {\n        state: data.state,\n    }\n}\ncontext.flow.set(\"lnkdstates\", lnkdStates);\n\nmsg.statusCode = 302;\nmsg.headers = {\n    \"Location\": \"https://www.linkedin.com/oauth/v2/authorization?\" + querystring.stringify(data)\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":722,"y":202,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"3c2665ad0dccf564","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"check state parameter","func":"var state = (msg.payload && (typeof msg.payload == \"object\") && msg.payload.state);\nvar lnkdStates = context.flow.get(\"lnkdstates\") || {};\n\nif ( !lnkdStates[state] ) {\n    msg.reqStatus = \"invalidState\"\n} else {\n    msg.lnkdCode = msg.payload.code;\n    msg.pageData = lnkdStates[state];\n    \n    delete lnkdStates[state];\n    context.flow.set(\"lnkdstates\", lnkdStates);\n\n    if (msg.pageData[\"curl\"] ) {\n        if ( msg.pageData[\"path\"] ) {\n            msg.reqStatus = \"haveRedirectUrlAndPagePath\"\n        } else {\n            msg.reqStatus = \"haveRedirectUrl\"\n        }\n    } else {\n        msg.reqStatus = \"validStateNoRedirect\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":473,"y":371,"wires":[["d9bdfe90dda135a9"]]},{"id":"d9bdfe90dda135a9","type":"switch","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","property":"reqStatus","propertyType":"msg","rules":[{"t":"eq","v":"invalidState","vt":"str"},{"t":"eq","v":"validStateNoRedirect","vt":"str"},{"t":"eq","v":"haveRedirectUrl","vt":"str"},{"t":"eq","v":"haveRedirectUrlAndPagePath","vt":"str"}],"checkall":"false","repair":false,"outputs":4,"x":622,"y":467,"wires":[["44db952972d39946"],["76a6893125fce042","b4b4245da2a27e4d"],["f86f6914caae55bf","b4b4245da2a27e4d"],["f86f6914caae55bf","8d25f069742ef57e"]]},{"id":"44db952972d39946","type":"change","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"404 page not found","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"404","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"page not found","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":891,"y":305,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"f86f6914caae55bf","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"setup response for redirect","func":"msg.statusCode = 302;\nmsg.headers = {\n    \"Location\": msg.pageData.curl\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":1097,"y":487,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"b4b4245da2a27e4d","type":"function","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"setup request for access token","func":"var data = {\n    \"client_id\":     process.env.LINKEDIN_CLIENT_ID,\n    \"code\":          msg.lnkdCode,\n    \"client_secret\": process.env.LINKEDIN_CLIENT_SECRET,\n    \"grant_type\":    \"authorization_code\",\n    \"redirect_uri\":  \"https://blog.openmindmap.org/auth/linkedin/callback\",\n};\n\nmsg.payload = querystring.stringify(data);\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":1314,"y":814,"wires":[["a359c3e8adc3a5bd"]]},{"id":"a359c3e8adc3a5bd","type":"http request","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"obtain access token","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://www.linkedin.com/oauth/v2/accessToken","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"Content-Type","keyValue":"","valueType":"other","valueValue":"application/x-www-form-urlencoded"}],"x":1616,"y":814,"wires":[["b93c3fb8dd7543c6"]]},{"id":"b93c3fb8dd7543c6","type":"switch","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"did we get an access_token?","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1616,"y":879.125,"wires":[["14fda90faedd4962"]]},{"id":"251d2e9c879669f7","type":"http request","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.linkedin.com/v2/me","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1616,"y":1009.375,"wires":[["a9c228c644fe7151"]]},{"id":"14fda90faedd4962","type":"function","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"obtain user_id for the urn","func":"\nmsg.access_token = msg.payload.access_token;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1616,"y":944.25,"wires":[["251d2e9c879669f7"]]},{"id":"4f168abc1486eb3b","type":"function","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"set msg.user_urn and msg.headers","func":"msg.user_id = msg.payload.id;\nmsg.user_urn = \"urn:li:person:\" + msg.user_id;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.access_token\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1616,"y":1139.625,"wires":[["e534b9b4141e8063"]]},{"id":"c970ae1048092f75","type":"http request","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://api.linkedin.com/v2/ugcPosts","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"other","keyValue":"X-Restli-Protocol-Version","valueType":"other","valueValue":"2.0.0"}],"x":1616,"y":1335,"wires":[[]]},{"id":"8d25f069742ef57e","type":"BlogPages","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"","x":962,"y":923,"wires":[["704a67a823cf9701"]]},{"id":"704a67a823cf9701","type":"function","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"find blogpage details","func":"msg.blogPageDetailsForPost = undefined;\n\nmsg.blogpages.forEach( function(dtls){\n    console.log(dtls);\n    if ( dtls.path == msg.pageData.path ) {\n        msg.blogPageDetailsForPost = dtls;\n    }\n})\n\nif (msg.blogPageDetailsForPost ) { \n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1005,"y":999,"wires":[["a7ceef65726d2bce"]]},{"id":"e534b9b4141e8063","type":"switch","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"do we have blog page details?","property":"blogPageDetailsForPost","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":1616,"y":1204.75,"wires":[["f9e3f4bf655bb434"],[]]},{"id":"f9e3f4bf655bb434","type":"function","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"publish article share with title, summary and canonical URL","func":"msg.payload = {\n    \"author\": msg.user_urn,\n        \"lifecycleState\": \"PUBLISHED\", /* for testing DRAFT - but won't find it on LinkedIn */\n            \"specificContent\": {\n        \"com.linkedin.ugc.ShareContent\": {\n            \"shareCommentary\": {\n                \"text\": msg.blogPageDetailsForPost.title + \n                   \"\\n\\n\" + msg.blogPageDetailsForPost.summary + \n                   \"\\n\\n\" + (msg.blogPageDetailsForPost.tags || \"node-red,visualweb\").split(\",\").map(function (d) { return \"#\" + d; }).join(\",\") + \n                   \"\\n\\n\" + \"Great article would scan it again in an instance -- ChatGPT.\"\n            },\n            \"shareMediaCategory\": \"ARTICLE\",\n                \"media\": [\n                    {\n                        \"status\": \"READY\",\n                        \"description\": {\n                            \"text\": msg.blogPageDetailsForPost.summary\n                        },\n                        \"originalUrl\": msg.pageData.curl, /* + \"?cb=\" + RED.util.generateId(), */\n                        \"title\": {\n                            \"text\": msg.blogPageDetailsForPost.title\n                        }, \n                    }\n                ]\n        }\n    },\n    \"visibility\": {\n        \"com.linkedin.ugc.MemberNetworkVisibility\": \"PUBLIC\"\n    }\n};\n\nif (msg.blogPageDetailsForPost.image) {\n    msg.payload.specificContent[\"com.linkedin.ugc.ShareContent\"].media[0][\"media\"] = msg.blogdetails.cdn_url + \"/content/\" + msg.blogPageDetailsForPost.image;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1616,"y":1269.875,"wires":[["c970ae1048092f75"]]},{"id":"a9c228c644fe7151","type":"switch","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"was response status 200?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1616,"y":1074.5,"wires":[["4f168abc1486eb3b"]]},{"id":"a7ceef65726d2bce","type":"link call","z":"fafd7c807c192d4a","g":"e97c8686cc868af5","name":"","links":["66b4e598cb114802"],"linkType":"static","timeout":"30","x":1052,"y":1077,"wires":[["b4b4245da2a27e4d"]]}]