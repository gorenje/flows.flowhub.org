[{"id":"fafd7c807c192d4a","type":"tab","label":"[LinkedIn] OAuth Flow","disabled":false,"info":"This flow implements the [three legged LinkedIn OAuth flow](https://learn.microsoft.com/en-us/linkedin/shared/authentication/authorization-code-flow?tabs=HTTPS1).\n\nThis flow represents the OAuth flow for LinkedIn using an LinkedIn application. This flow assumes that an application has been created at [developer LinkedIn](https://developer.linkedin.com/). Developer app creation is generally not a problem but your mileage might vary.\n\nThe application needs to be configured to have a OAuth 2.0 *Authorized redirect URLs for your app* which points to the Node-RED instance.\n\nOAuth scopes configured for the app:\n\n- `r_emailaddress`\n- `r_liteprofile`\n- `w_member_social`\n\nThis flow assumes that these scopes have been set for the application.\n\nEnvironment variables:\n\n- `LINKEDIN_CLIENT_ID` which is the client id of the application defined at LinkedIn\n- `LINKEDIN_OAUTH_REDIRECT_URL` is the redirect URL\n\n```mermaid\nsequenceDiagram\n    actor Reader\n    participant OMM\n    participant LinkedIn\n    note left of LinkedIn: 3-legged OAuth linkedIn flow\n    Reader->>OMM: Click on share button\n    OMM->>OMM: Store state into flow context\n    OMM->>Reader: Redirect to LinkedIn authorisation, including state code\n    Reader->>LinkedIn: Application accept dialog\n    LinkedIn->>LinkedIn: User allows the app to access their data\n    LinkedIn->>OMM: User Accepted, state code and linkedin-code\n    activate OMM\n    OMM->>OMM: Check state and Reader details from flow context\n    OMM->>LinkedIn: User redirect page \n    LinkedIn->>Reader: Redirect Reader to original page\n```\n\nAbbreviation `OMM` in the sequence diagram is OpenMindMap.org, where this flow is implemented. \n\nVersion Update:\n\n- 31/07: Added app scope definitions\n- 31/07: Extended documentation\n- added sequence diagram\n","env":[]},{"id":"f48ded87e4acda10","type":"group","z":"fafd7c807c192d4a","name":"LinkedIn 3-legged OAuth flow for their API","style":{"label":true,"label-position":"sw"},"nodes":["b5fb5a9ce78fae0f","4988ab72d0598e7b","76a6893125fce042","55afb9b8644dc5b6","558954f850c7b0a4","300312ac02300f6b","3c2665ad0dccf564","d9bdfe90dda135a9","44db952972d39946","f86f6914caae55bf"],"x":151,"y":59,"w":1312,"h":477,"info":"This implements the following flow:\n\n![img](https://cdn.openmindmap.org/content/1687328049231_oauth-3-legged-flow_highres.png)"},{"id":"b5fb5a9ce78fae0f","type":"http response","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"Response","statusCode":"","headers":{},"x":1370,"y":202,"wires":[]},{"id":"4988ab72d0598e7b","type":"http in","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","url":"/auth/linkedin/callback","method":"get","upload":false,"swaggerDoc":"","x":308,"y":290,"wires":[["3c2665ad0dccf564"]]},{"id":"76a6893125fce042","type":"change","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"200 post will be created","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"200","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"post will be created","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":984,"y":388,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"55afb9b8644dc5b6","type":"comment","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"This implements LinkedIns 3-legged dog - https://learn.microsoft.com/en-gb/linkedin/shared/authentication/authorization-code-flow?context=linkedin%2Fconsumer%2Fcontext&tabs=HTTPS1","info":"[Link](https://learn.microsoft.com/en-gb/linkedin/shared/authentication/authorization-code-flow?context=linkedin%2Fconsumer%2Fcontext&tabs=HTTPS1)\n\nThis implements the following flow:\n\n![img](https://cdn.openmindmap.org/content/1687328049231_oauth-3-legged-flow_highres.png)","x":807,"y":100,"wires":[]},{"id":"558954f850c7b0a4","type":"http in","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","url":"/share/post-on/linkedin","method":"get","upload":false,"swaggerDoc":"","x":307,"y":202,"wires":[["300312ac02300f6b"]]},{"id":"300312ac02300f6b","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"setup link for redirect to linkedin (ensure referrer and curl match)","func":"var data = {\n    \"client_id\": process.env.LINKEDIN_CLIENT_ID,\n    \"scope\": \"w_member_social r_liteprofile r_emailaddress\",\n    \"response_type\": \"code\",\n    \"redirect_uri\": process.env.LINKEDIN_OAUTH_REDIRECT_URL,\n    \"state\": RED.util.generateId()\n};\n\n/* Store the state value to compare it on the callback call */\nvar lnkdStates = context.flow.get(\"lnkdstates\") || {};\n\nif (msg.req.headers[\"referer\"] == msg.payload.curl ) {\n    lnkdStates[data.state] = {\n        state: data.state,\n        curl: msg.payload.curl,\n        path: msg.payload.p\n    }\n} else {\n    lnkdStates[data.state] = {\n        state: data.state,\n    }\n}\ncontext.flow.set(\"lnkdstates\", lnkdStates);\n\nmsg.statusCode = 302;\nmsg.headers = {\n    \"Location\": \"https://www.linkedin.com/oauth/v2/authorization?\" + querystring.stringify(data)\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":794,"y":202,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"3c2665ad0dccf564","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"check state parameter","func":"var state = (msg.payload && (typeof msg.payload == \"object\") && msg.payload.state);\nvar lnkdStates = context.flow.get(\"lnkdstates\") || {};\n\nif ( !lnkdStates[state] ) {\n    msg.reqStatus = \"invalidState\"\n} else {\n    msg.lnkdCode = msg.payload.code;\n    msg.pageData = lnkdStates[state];\n    \n    delete lnkdStates[state];\n    context.flow.set(\"lnkdstates\", lnkdStates);\n\n    if (msg.pageData[\"curl\"] ) {\n        if ( msg.pageData[\"path\"] ) {\n            msg.reqStatus = \"haveRedirectUrlAndPagePath\"\n        } else {\n            msg.reqStatus = \"haveRedirectUrl\"\n        }\n    } else {\n        msg.reqStatus = \"validStateNoRedirect\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":398,"y":467,"wires":[["d9bdfe90dda135a9"]]},{"id":"d9bdfe90dda135a9","type":"switch","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"","property":"reqStatus","propertyType":"msg","rules":[{"t":"eq","v":"invalidState","vt":"str"},{"t":"eq","v":"validStateNoRedirect","vt":"str"},{"t":"eq","v":"haveRedirectUrl","vt":"str"},{"t":"eq","v":"haveRedirectUrlAndPagePath","vt":"str"}],"checkall":"false","repair":false,"outputs":4,"x":622,"y":467,"wires":[["44db952972d39946"],["76a6893125fce042"],["f86f6914caae55bf"],["f86f6914caae55bf","28a8bf2eb4990d81"]]},{"id":"44db952972d39946","type":"change","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"404 page not found","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"404","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"page not found","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":891,"y":305,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"f86f6914caae55bf","type":"function","z":"fafd7c807c192d4a","g":"f48ded87e4acda10","name":"setup response for redirect","func":"msg.statusCode = 302;\nmsg.headers = {\n    \"Location\": msg.pageData.curl\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"querystring","module":"querystring"},{"var":"process","module":"process"}],"x":1097,"y":487,"wires":[["b5fb5a9ce78fae0f"]]},{"id":"28a8bf2eb4990d81","type":"link out","z":"fafd7c807c192d4a","name":"[linkedin] have page details","mode":"link","links":["33696d8422ca8eaf"],"x":761,"y":623,"wires":[]}]