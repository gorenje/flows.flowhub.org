[{"id":"38021e5e2266e7e5","type":"tab","label":"OSC to I2C bridge","disabled":false,"info":"::: aim\n\nConstruct a bridge between [Open Sound Control](https://en.wikipedia.org/wiki/Open_Sound_Control) (OSC) protocol and the I2C protocol.\n\n:::\n\n::: palette\n\n- [Open Sound Control (OSC)](https://flows.nodered.org/node/node-red-contrib-osc)\n\n:::\n\n### Explanation\n\nThis is a bridge between two different projects, one is the [Scroll pHAT](https://flowhub.org/f/be2109bba90b6c5a) attached to a Raspberry PI. The other is a sound/music project that I created using [Supercollider](https://supercollider.github.io/).\n\n[Sounds from the Scape](https://github.com/gorenje/sfts) is a samples based soundscape generator using eight effects per channel with up to sixteen channels being possible. Each channel is a WAV sample. That application can generate [OSC](https://en.wikipedia.org/wiki/Open_Sound_Control) packets that this flow can interpret.\n\nI can also hook up a MIDI device to control the application, in this case an [*Arturia - MiniLab MkII*](https://www.musicradar.com/reviews/arturia-minilab-mkii).\n\n### Related flows\n\n- [I2C interface to Scoll pHAT](https://flowhub.org/f/be2109bba90b6c5a)\n\n","env":[]},{"id":"4ba9ba6e3ac414e2","type":"group","z":"38021e5e2266e7e5","name":"Required to connect to Scroll pHAT LED display","style":{"label":true},"nodes":["72a17d57e00c033d"],"x":205,"y":249,"w":307,"h":82},{"id":"15ec57e0989c6d95","type":"group","z":"38021e5e2266e7e5","name":"prevent flickering by preventing jumps in brightness","style":{"label":true},"nodes":["39aaaf7014faa3be","adb7926ec9bbbba9","13662aede2f3b914"],"x":1357,"y":1419,"w":678,"h":154},{"id":"cc421de8934d4d2d","type":"group","z":"38021e5e2266e7e5","name":"output","style":{"label":true},"nodes":["8b08210b834ce6b6","daee54b7210802d7","621639501d0b93ea"],"x":2132.5,"y":1247,"w":82,"h":370},{"id":"b97c872c3cc6fa3c","type":"group","z":"38021e5e2266e7e5","name":"network receiver","style":{"label":true},"nodes":["38a22678.b804ca"],"x":581,"y":626,"w":172,"h":82},{"id":"72a17d57e00c033d","type":"FlowHubPull","z":"38021e5e2266e7e5","g":"4ba9ba6e3ac414e2","name":"","notab":false,"flowid":"be2109bba90b6c5a","flowname":"[I2C] Scroll pHAT","flowrevision":"","x":321,"y":290,"wires":[[]]},{"id":"38a22678.b804ca","type":"udp in","z":"38021e5e2266e7e5","g":"b97c872c3cc6fa3c","name":"","iface":"","port":"12345","ipv":"udp6","multicast":"false","group":"","datatype":"buffer","x":667,"y":667,"wires":[["aa5581d1.cabc"]]},{"id":"aa5581d1.cabc","type":"osc","z":"38021e5e2266e7e5","name":"","path":"","metadata":true,"x":833,"y":836,"wires":[["cb9ab6044e098095","ba4253ee0c429245"]]},{"id":"253a731f0f754f5f","type":"link out","z":"38021e5e2266e7e5","name":"link to I2C [scrollphat] set single pixel on or off","mode":"link","links":["377893b3eb85798d"],"x":2216,"y":849,"wires":[]},{"id":"f9bdc02cc3d0f121","type":"change","z":"38021e5e2266e7e5","name":"col = 1","rules":[{"t":"set","p":"col","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":468,"wires":[["b15ded91d247ea80"]]},{"id":"afc773facd1e0eb4","type":"change","z":"38021e5e2266e7e5","name":"col = 2","rules":[{"t":"set","p":"col","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":519.0666666666666,"wires":[["b15ded91d247ea80"]]},{"id":"841ade1d3e6e809f","type":"change","z":"38021e5e2266e7e5","name":"col = 3","rules":[{"t":"set","p":"col","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":570.1333333333333,"wires":[["b15ded91d247ea80"]]},{"id":"0187b3643fc9827a","type":"change","z":"38021e5e2266e7e5","name":"col = 4","rules":[{"t":"set","p":"col","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":621.2,"wires":[["b15ded91d247ea80"]]},{"id":"b15ded91d247ea80","type":"change","z":"38021e5e2266e7e5","name":"row = 1","rules":[{"t":"set","p":"row","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1603.5,"y":542,"wires":[["f40e1f34948bc305"]]},{"id":"f40e1f34948bc305","type":"function","z":"38021e5e2266e7e5","name":"function 31","func":"// handle rate value\nlet p = msg.payload[3].value > 0.5\n\nnode.send({\n    ...msg,\n    payload: p\n})\n\n// handle frequency\np = msg.payload[5].value > 0.5\n\nnode.send({\n    ...msg,\n    col: msg.col + 5,\n    payload: p\n})\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1889,"y":849,"wires":[["253a731f0f754f5f"]]},{"id":"2deada9669881f66","type":"change","z":"38021e5e2266e7e5","name":"row = 2","rules":[{"t":"set","p":"row","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1603.5,"y":749.6666666666666,"wires":[["f40e1f34948bc305"]]},{"id":"5641d6746e122087","type":"change","z":"38021e5e2266e7e5","name":"col = 5","rules":[{"t":"set","p":"col","pt":"msg","to":"5","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":643,"y":945,"wires":[[]]},{"id":"1d2e411f0fc1a95a","type":"change","z":"38021e5e2266e7e5","name":"col = 6","rules":[{"t":"set","p":"col","pt":"msg","to":"6","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":648,"y":996,"wires":[[]]},{"id":"13e83f4fc86e4aee","type":"change","z":"38021e5e2266e7e5","name":"col = 7","rules":[{"t":"set","p":"col","pt":"msg","to":"7","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":642,"y":1042,"wires":[[]]},{"id":"25c198cb60f8ddbb","type":"change","z":"38021e5e2266e7e5","name":"col = 8","rules":[{"t":"set","p":"col","pt":"msg","to":"8","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":645,"y":1098,"wires":[[]]},{"id":"c2cc566b1fcce68b","type":"change","z":"38021e5e2266e7e5","name":"col = 1","rules":[{"t":"set","p":"col","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":672.2666666666668,"wires":[["2deada9669881f66"]]},{"id":"5b67c6cb04d7db87","type":"change","z":"38021e5e2266e7e5","name":"col = 2","rules":[{"t":"set","p":"col","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":723.3333333333335,"wires":[["2deada9669881f66"]]},{"id":"040863e1de95075a","type":"change","z":"38021e5e2266e7e5","name":"col = 3","rules":[{"t":"set","p":"col","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":774.4000000000002,"wires":[["2deada9669881f66"]]},{"id":"eb482e69b9f16774","type":"change","z":"38021e5e2266e7e5","name":"col = 4","rules":[{"t":"set","p":"col","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":825.4666666666669,"wires":[["2deada9669881f66"]]},{"id":"31a6427462e7c9e2","type":"change","z":"38021e5e2266e7e5","name":"col = 1","rules":[{"t":"set","p":"col","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":876.5333333333336,"wires":[["4894120ca27d04aa"]]},{"id":"c2229bb2b73bce20","type":"change","z":"38021e5e2266e7e5","name":"col = 2","rules":[{"t":"set","p":"col","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":927.6000000000004,"wires":[["4894120ca27d04aa"]]},{"id":"37b783adca5296b4","type":"change","z":"38021e5e2266e7e5","name":"col = 3","rules":[{"t":"set","p":"col","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":978.6666666666671,"wires":[["4894120ca27d04aa"]]},{"id":"f36888e0337ebac1","type":"change","z":"38021e5e2266e7e5","name":"col = 4","rules":[{"t":"set","p":"col","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":1029.7333333333338,"wires":[["4894120ca27d04aa"]]},{"id":"2976908af5519e30","type":"change","z":"38021e5e2266e7e5","name":"col = 1","rules":[{"t":"set","p":"col","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":1080.8000000000004,"wires":[["aea72740f8212f2b"]]},{"id":"5c268149b1f57072","type":"change","z":"38021e5e2266e7e5","name":"col = 2","rules":[{"t":"set","p":"col","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":1131.866666666667,"wires":[["aea72740f8212f2b"]]},{"id":"3f184da60643a821","type":"change","z":"38021e5e2266e7e5","name":"col = 3","rules":[{"t":"set","p":"col","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":1182.9333333333336,"wires":[["aea72740f8212f2b"]]},{"id":"5f4c2ffc882e530b","type":"change","z":"38021e5e2266e7e5","name":"col = 4","rules":[{"t":"set","p":"col","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1394,"y":1234,"wires":[["aea72740f8212f2b"]]},{"id":"4894120ca27d04aa","type":"change","z":"38021e5e2266e7e5","name":"row = 3","rules":[{"t":"set","p":"row","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1603.5,"y":957.3333333333333,"wires":[["f40e1f34948bc305"]]},{"id":"aea72740f8212f2b","type":"change","z":"38021e5e2266e7e5","name":"row = 4","rules":[{"t":"set","p":"row","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1603.5,"y":1165,"wires":[["f40e1f34948bc305"]]},{"id":"39aaaf7014faa3be","type":"function","z":"38021e5e2266e7e5","g":"15ec57e0989c6d95","name":"set brightness as a average of all volume values","func":"let pads = msg.payload.filter( d => {\n    return d[0].value > 0\n})\n\nif ( pads.length > 0 ) {\n    let b = 0;\n    \n    pads.forEach(function(element) {\n        b += element[1].value\n    });\n\n    b = Math.ceil((b / pads.length) * 127)\n    if ( msg.curr_b ) {\n        if (b > msg.curr_b) b = msg.curr_b + 1\n        if (b < msg.curr_b) b = msg.curr_b - 1\n    }\n    \n    return {\n        ...msg,\n        payload: b\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1696,"y":1460,"wires":[["13662aede2f3b914"]]},{"id":"68077b735b750d9a","type":"join","z":"38021e5e2266e7e5","name":"collect for 1 second","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1191,"y":1341,"wires":[["adb7926ec9bbbba9","a57b9fd8f7ed03ae"]]},{"id":"cb9ab6044e098095","type":"switch","z":"38021e5e2266e7e5","name":"only pad updates","property":"topic","propertyType":"msg","rules":[{"t":"cont","v":"/pad","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1013,"y":1136,"wires":[["68077b735b750d9a"]]},{"id":"8b08210b834ce6b6","type":"link out","z":"38021e5e2266e7e5","g":"cc421de8934d4d2d","name":"link to I2C - set brightness","mode":"link","links":["f5d674b8bf337831"],"x":2173.5,"y":1576,"wires":[]},{"id":"adb7926ec9bbbba9","type":"change","z":"38021e5e2266e7e5","g":"15ec57e0989c6d95","name":"","rules":[{"t":"set","p":"curr_b","pt":"msg","to":"brightness","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1463,"y":1532,"wires":[["39aaaf7014faa3be"]]},{"id":"13662aede2f3b914","type":"change","z":"38021e5e2266e7e5","g":"15ec57e0989c6d95","name":"","rules":[{"t":"set","p":"brightness","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1919,"y":1529,"wires":[["8b08210b834ce6b6"]]},{"id":"ba4253ee0c429245","type":"switch","z":"38021e5e2266e7e5","d":true,"name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"/pad0","vt":"str"},{"t":"eq","v":"/pad1","vt":"str"},{"t":"eq","v":"/pad2","vt":"str"},{"t":"eq","v":"/pad3","vt":"str"},{"t":"eq","v":"/pad4","vt":"str"},{"t":"eq","v":"/pad5","vt":"str"},{"t":"eq","v":"/pad6","vt":"str"},{"t":"eq","v":"/pad7","vt":"str"},{"t":"eq","v":"/pad8","vt":"str"},{"t":"eq","v":"/pad9","vt":"str"},{"t":"eq","v":"/pad10","vt":"str"},{"t":"eq","v":"/pad11","vt":"str"},{"t":"eq","v":"/pad12","vt":"str"},{"t":"eq","v":"/pad13","vt":"str"},{"t":"eq","v":"/pad14","vt":"str"},{"t":"eq","v":"/pad15","vt":"str"}],"checkall":"false","repair":false,"outputs":16,"x":1125,"y":833,"wires":[["f9bdc02cc3d0f121"],["afc773facd1e0eb4"],["841ade1d3e6e809f"],["0187b3643fc9827a"],["c2cc566b1fcce68b"],["5b67c6cb04d7db87"],["040863e1de95075a"],["eb482e69b9f16774"],["31a6427462e7c9e2"],["c2229bb2b73bce20"],["37b783adca5296b4"],["f36888e0337ebac1"],["2976908af5519e30"],["5c268149b1f57072"],["3f184da60643a821"],["5f4c2ffc882e530b"]]},{"id":"a57b9fd8f7ed03ae","type":"function","z":"38021e5e2266e7e5","name":"take first 55 non-zero values and set the leds accordingly","func":"let pads = msg.payload.filter( d => {\n    return d[0].value > 0\n})\n\nfunction sendOff( cnt, val ) {\n    let col = Math.floor(cnt / 11) + 1\n    let row = (cnt % 5) + 1\n\n    node.send([{\n        ...msg,\n        col: col,\n        row: row,\n        payload: val > 0.5\n    }, undefined])\n}\n\nif ( pads.length > 0 ) {\n    let cnt = 0;\n    \n    pads.forEach(function(element) {\n        for ( var idx = 1; idx < 9; idx++ ) {\n            sendOff(cnt, element[idx].value )\n            cnt += 1\n        }\n    });\n\n    for ( ; cnt < 56 ; cnt++) {\n        sendOff(cnt, 0)\n    }\n} else {\n    return [undefined, msg]\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1698,"y":1341,"wires":[["621639501d0b93ea"],["daee54b7210802d7"]]},{"id":"daee54b7210802d7","type":"link out","z":"38021e5e2266e7e5","g":"cc421de8934d4d2d","name":"link to I2C - set brightness","mode":"link","links":["eb8120418935f394"],"x":2173.5,"y":1406,"wires":[]},{"id":"621639501d0b93ea","type":"link out","z":"38021e5e2266e7e5","g":"cc421de8934d4d2d","name":"link to I2C [scrollphat] set single pixel on or off","mode":"link","links":["377893b3eb85798d"],"x":2173.5,"y":1288,"wires":[]}]