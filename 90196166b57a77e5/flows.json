[{"id":"90196166b57a77e5","type":"tab","label":"[Jmap] Email over Json","disabled":false,"info":"::: aim\n\nFastmail JMAP interaction. See this [article](https://blog.openmindmap.org/blog/jmap-send-email-flow) for more details on the background of JMAP.\n\n:::\n\n::: requirements\n\n- Requires the [zip](https://flows.nodered.org/node/node-red-contrib-zip) node\n- Requires that `FASTMAIL_API_TOKEN` is defined in the environment.\n\n:::\n\n### msg contents\n\nThese flows assume the definition of the email attribute on the message object. The structure of the email object must be:\n\n```javascript\nmsg.email = {\n    /* addresses */\n    from: \"sender@example.org\",\n    from_name: \"Example Robot\",\n    to: \"recipient@example.org\",\n    cc: false,\n    bcc: false,\n\n    /* content */\n    subject: \"[Prefix] Subject of Email\",\n    text: \"Text content can differ from html content.\\n\",\n    html: \"<h1>HTML</h1> <br><b>Html</b> is a lot of fun<br>\",\n\n    /* attachments */\n    attachments: [\n        {\n            payload: JSON.stringify(msg),\n            filename: \"msg.json\"\n        }\n    ]\n}\n```\n\nThis structure is validated by <a class=\"ahl-group-only\" data-ids=\"0685abf61dd56bf7\">JSON-Schema validation group</a>.\n\n### Sequence diagrams\n\nSequence diagram for <a class=\"ahl-group-only\" data-ids=\"2baec5f863a37d04\">`[fm] init - v1`</a>:\n\n```mermaid\nsequenceDiagram\n    Flow->>Fastmail (WellKnown): Please provide Account details\n    Fastmail (WellKnown)->>Flow: account_id & uploadUrl for FASTMAIL_API token\n    Flow->>Flow: Append account Id to `msg`\n    Flow->>Flow: Append upload URL to `msg`\n    Flow->>Fastmail (API): Send Draft folder id\n    Fastmail (API)->>Flow: draft folder id\n    Flow->>Flow: Store draft folder id on `msg` object\n    Flow->>Fastmail (API): Provide a list of registered sender emails\n    Fastmail (API)->>Flow: Mapping of from email to ID\n    Flow->>Flow: Store mapping on `msg` object\n```\n\nSequence diagram for <a class=\"ahl-group-only\" data-ids=\"1dc237a9d33d5ed3\">`[fm] init - v2`</a>:\n\n```mermaid\nsequenceDiagram\n    Flow->>Fastmail (WellKnown): Please provide Account details\n    Fastmail (WellKnown)->>Flow: account_id for FASTMAIL_API token\n    Flow->>Flow: Append account Id to `msg`\n    Flow->>Flow: upload URL to `msg`\n    Flow->>Fastmail (API): Send Draft folder id & list of registered sender emails\n    Fastmail (API)->>Flow: draft folder id & registered emails\n    Flow->>Flow: Store draft folder id on `msg` object\n    Flow->>Flow: Store sender email mapping on `msg` object\n```\n\nSending emails <a class=\"ahl-group-only\" data-ids=\"913082e616d84dfa\">`[fm] send email`</a>:\n\n```mermaid\nsequenceDiagram\n    Flow->>Flow: Initialise Fastmail\n    Flow->>Flow: Construct email object\n    Flow->>Fastmail (API): Create draft email in draft folder & send email from there\n    Fastmail (API)->>Flow: email sent\n```\n\nSending emails with attachment, <a class=\"ahl-group-only\" data-ids=\"e6f09bcaca0642ce\">`[fm] send email with attachments`</a>:\n\n```mermaid\nsequenceDiagram\n    Flow->>Flow: [fm] init - v2\n    Flow->>Flow: Construct zip containing original payload\n    Flow->>Fastmail (UploadURL): Upload Zip and obtain blobId\n    Fastmail (UploadURL)->>Flow: blobId of Zip file\n    Flow->>Flow: Create email including attachment details\n    Flow->>Flow: [fm] send email (no warmup)\n```\n","env":[]},{"id":"2baec5f863a37d04","type":"group","z":"90196166b57a77e5","name":"[fm] init - v1","style":{"label":true},"nodes":["ec76c338b8557196","13730bd6088ebd5c","6b5447389835315d","8cd65ac22eed3123","7ffcc73c52c06f52","2e0d64da4844738a","b87b4a0317bf4065","be5add6bef62b488","2a39ebb7b2c86d94","74b92df3cbe129f9","adb3070af26d5241"],"x":485,"y":91,"w":610,"h":412},{"id":"913082e616d84dfa","type":"group","z":"90196166b57a77e5","name":"[fm] send email","style":{"label":true},"nodes":["78152de1e45c8c18","84adc7ab61115326","7f5f8e8f9041be65","093e9a4fc6067fbe","858a5a9948ca5ce8","ce0e6936b12cc43b","106fe2967e41dced","83cfd48ff8a8440c"],"x":472,"y":665,"w":544,"h":372},{"id":"e6f09bcaca0642ce","type":"group","z":"90196166b57a77e5","name":"[fm] send email with attachments","style":{"label":true},"nodes":["45ec84e93e723b98","f20245aba2053f83","9fe5b2e2ec45b3ef","f04c04f476e9b9c6","e1e9182cbbbb3eb9","3be4415fdf05acaf","0cea4b8a0b7b0cdc","59aaf14c3a34ee6f","a54744c362f980f7","90942be6906dc62e","c99733849359cac7"],"x":473,"y":1074,"w":1055,"h":282},{"id":"1dc237a9d33d5ed3","type":"group","z":"90196166b57a77e5","name":"[fm] init - v2","style":{"label":true},"nodes":["7d74ccf860684abe","95a22bf5e1205c02","efac3587264d74a5","bbd58f295c0e18cf","5d1059e533c2d586","dc70ab87b7721ecc","93b5e2879c7e0daf","b7a122e21273141b","739fdbcd8491e989"],"x":1477,"y":90,"w":752,"h":461},{"id":"0685abf61dd56bf7","type":"group","z":"90196166b57a77e5","name":"msg validation","style":{"label":true},"nodes":["3f402588b2462b07","9fdb7c21c58b3376","73dac43bf4779cb5","692bd71676d3de82","09f7cf96e80153ab","07a8907768caa53e","63d1d1d10a4ee4a8","55d5b086789d07da"],"x":1232,"y":665,"w":997,"h":166},{"id":"27024152aafadefa","type":"group","z":"90196166b57a77e5","name":"Entry Points","style":{"label":true},"nodes":["5202b587b5556804","414a7c88302f52db"],"x":197,"y":755,"w":84,"h":218},{"id":"ec76c338b8557196","type":"http request","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"Fastmail (WellKnown)","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":969,"y":254,"wires":[["13730bd6088ebd5c"]]},{"id":"13730bd6088ebd5c","type":"function","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"get account_id","func":"msg.fastmail = {\n    ...msg.fastmail,\n    account: msg.payload.accounts,\n    account_id: Object.keys(msg.payload.accounts)[0]\n};\n\nmsg.fastmail[\"uploadUrl\"] = msg.payload.uploadUrl.replace( \"{accountId}\", msg.fastmail.account_id );\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\nmsg.url = \"https://api.fastmail.com/jmap/api\"\n\nmsg.payload = {\n        \"using\": [\n            \"urn:ietf:params:jmap:core\",\n            \"urn:ietf:params:jmap:mail\"\n        ],\n        \"methodCalls\": [\n            [\n                \"Mailbox/query\",\n                {\n                    \"accountId\": msg.fastmail.account_id,\n                    \"filter\": { \n                        \"name\": \"Drafts\" \n                    }\n                },\n                \"a\",\n            ]\n        ],\n    };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":309,"wires":[["6b5447389835315d"]]},{"id":"6b5447389835315d","type":"http request","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"Fastmail (API)","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":949,"y":309,"wires":[["8cd65ac22eed3123"]]},{"id":"8cd65ac22eed3123","type":"function","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"get draft mailbox id","func":"msg.fastmail = {\n    ...msg.fastmail,\n    draft_mailbox_id: msg.payload[\"methodResponses\"][0][1][\"ids\"][0]\n};\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\n\nmsg.url = \"https://api.fastmail.com/jmap/api\"\n\nmsg.payload = {\n    \"using\": [\n        \"urn:ietf:params:jmap:core\",\n        \"urn:ietf:params:jmap:mail\",\n        \"urn:ietf:params:jmap:submission\",\n    ],\n    \"methodCalls\": [\n        [\n            \"Identity/get\",\n            {\n                \"accountId\": msg.fastmail.account_id,\n            },\n            \"pluckaduck\"\n        ]\n    ]\n};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":370,"wires":[["7ffcc73c52c06f52"]]},{"id":"7ffcc73c52c06f52","type":"http request","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"Fastmail (API)","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":949,"y":370,"wires":[["2e0d64da4844738a"]]},{"id":"2e0d64da4844738a","type":"function","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"email aliases to ids","func":"var emailToId = {};\nvar lst = msg.payload[\"methodResponses\"][0][1]['list'];\n\nfor ( var idx = 0 ; idx < lst.length ; idx++ ) {\n    var dt = lst[idx];\n    emailToId[dt.email] = dt.id;\n}\n\nmsg.fastmail = {\n    ...msg.fastmail,\n    emailsToIds: emailToId\n};\n\ndelete msg.payload;\n\nreturn msg; \n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":836.0001220703125,"y":434,"wires":[["adb3070af26d5241"]]},{"id":"b87b4a0317bf4065","type":"function","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"init request","func":"msg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\nmsg.url = \"https://api.fastmail.com/.well-known/jmap\"\n\nmsg.fastmail = {}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":254,"wires":[["ec76c338b8557196"]]},{"id":"be5add6bef62b488","type":"catch","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"","scope":["ec76c338b8557196","13730bd6088ebd5c","6b5447389835315d","8cd65ac22eed3123","7ffcc73c52c06f52","2e0d64da4844738a","b87b4a0317bf4065"],"uncaught":false,"x":742,"y":132,"wires":[["2a39ebb7b2c86d94"]]},{"id":"2a39ebb7b2c86d94","type":"debug","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"debug 14","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":946,"y":133,"wires":[]},{"id":"74b92df3cbe129f9","type":"link in","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"[fm] init","links":[],"x":526,"y":215,"wires":[["b87b4a0317bf4065"]]},{"id":"adb3070af26d5241","type":"link out","z":"90196166b57a77e5","g":"2baec5f863a37d04","name":"link out 71","mode":"return","links":[],"x":1043,"y":462,"wires":[]},{"id":"78152de1e45c8c18","type":"function","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"send email","func":"var to_email   = msg.email.to;\nvar cc_email   = msg.email.cc;\nvar from_email = msg.email.from || env.get(\"SNDML_FROM_EMAIL\");\nvar bcc_email  = msg.email.bcc || env.get(\"SNDML_BCC_EMAIL\");\n\nif ( !from_email ) {\n    throw \"Missing from email when sending email\";\n}\n\nvar draft_id = \"draft_\" + RED.util.generateId();\n\nvar draft = {\n    \"from\": [\n        { \n            \"email\": from_email, \n            \"name\": msg.email.from_name || from_email\n        }\n    ],\n    \"to\": [\n        { \n            \"email\": to_email \n        }\n    ],\n    \"subject\": msg.email.subject,\n    \"keywords\": { \"$draft\": true },\n    \"mailboxIds\": {  },\n    \"bodyValues\": {\n        \"body\": { \"value\": msg.email.text, \"charset\": \"utf-8\" },\n        \"bodyHTML\": { \"value\": msg.email.html, \"charset\": \"utf-8\" }\n    },\n    \"textBody\": [{ \"partId\": \"body\", \"type\": \"text/plain\" }],\n    \"htmlBody\": [{ \"partId\": \"bodyHTML\", \"type\": \"text/html\" }],\n};\n\nvar rcptTo = [\n    {\n        \"email\": to_email,\n        \"parameters\": null\n    }\n];\n\nif ( bcc_email && (msg.email.bcc != false)) {\n    draft[\"bcc\"] = [{ \"email\": bcc_email }];\n    rcptTo.push({\n        \"email\": bcc_email,\n            \"parameters\": \"bcc\"\n    });\n}\n\nif (cc_email && (msg.email.cc != false)) {\n    draft[\"cc\"] = [{ \"email\": cc_email }];\n    rcptTo.push({\n        \"email\": cc_email,\n        \"parameters\": \"cc\"\n    });\n}\n\nif (msg.email.attachments) {\n    draft[\"attachments\"] = [];\n    msg.email.attachments.forEach(function(att){\n        draft[\"attachments\"].push({\n            \"blobId\": att.blobId,\n            \"type\": att.type,\n            \"name\": att.filename\n        });\n    });\n}\n\ndraft[\"mailboxIds\"][msg.fastmail.draft_mailbox_id] = true;\n\nvar drafty = {};\ndrafty[draft_id] = draft;\n\nmsg.payload = {\n    \"using\": [\n        \"urn:ietf:params:jmap:core\",\n        \"urn:ietf:params:jmap:mail\",\n        \"urn:ietf:params:jmap:submission\",\n    ],\n    \"methodCalls\": [\n        [\n            \"Email/set\",\n            {\n                \"accountId\": msg.fastmail.account_id,\n                \"create\": drafty\n            },\n            \"a\"\n        ],\n        [\n            \"EmailSubmission/set\",\n            {\n                \"accountId\": msg.fastmail.account_id,\n                \"onSuccessDestroyEmail\": [\"#sendIt\"],\n                \"create\": {\n                    \"sendIt\": {\n                        \"identityId\": msg.fastmail.emailsToIds[from_email],\n                        \"emailId\": \"#\" + draft_id,\n                        \"envelope\": {\n                            \"mailFrom\": {\n                                \"email\": from_email,\n                                \"parameters\": null\n                            },\n                            \"rcptTo\": rcptTo\n                        },\n                    }\n                },\n            },\n            \"b\",\n        ],\n    ],\n}\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\n\nmsg.url = \"https://api.fastmail.com/jmap/api\"\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":761,"y":902,"wires":[["7f5f8e8f9041be65"]]},{"id":"84adc7ab61115326","type":"link call","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"","links":["b7a122e21273141b"],"linkType":"static","timeout":"30","x":739,"y":795,"wires":[["83cfd48ff8a8440c"]]},{"id":"7f5f8e8f9041be65","type":"http request","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"Fastmail (API)","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":759,"y":970,"wires":[["093e9a4fc6067fbe"]]},{"id":"45ec84e93e723b98","type":"function","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"create email content","func":"if ( msg.statusCode == 200 ) {\n    msg.email.attachments = [\n        {\n            \"filename\": \"attachment.zip\",\n            \"blobId\": msg.payload.blobId,\n            \"type\": msg.payload.type\n        }\n    ]\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1250,"y":1259,"wires":[["59aaf14c3a34ee6f"]]},{"id":"f20245aba2053f83","type":"link call","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","links":["b7a122e21273141b"],"linkType":"static","timeout":"30","x":677,"y":1192,"wires":[["9fe5b2e2ec45b3ef"]]},{"id":"9fe5b2e2ec45b3ef","type":"change","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"email.attachments","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":744,"y":1266,"wires":[["f04c04f476e9b9c6"]]},{"id":"5202b587b5556804","type":"link in","z":"90196166b57a77e5","g":"27024152aafadefa","name":"[fm] send email with attachments","links":[],"x":238,"y":932,"wires":[["c99733849359cac7"]]},{"id":"e1e9182cbbbb3eb9","type":"link out","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"link out 94","mode":"return","links":[],"x":1487,"y":1315,"wires":[]},{"id":"3be4415fdf05acaf","type":"change","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"fastmail.uploadUrl","tot":"msg"},{"t":"set","p":"headers","pt":"msg","to":"{\t    \"Authorization\": \"Bearer \" & $env(\"FASTMAIL_API\")\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1214,"y":1116,"wires":[["0cea4b8a0b7b0cdc"]]},{"id":"0cea4b8a0b7b0cdc","type":"http request","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"Fastmail (uploadURL)","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1222,"y":1190,"wires":[["45ec84e93e723b98"]]},{"id":"414a7c88302f52db","type":"link in","z":"90196166b57a77e5","g":"27024152aafadefa","name":"[fm] send email","links":[],"x":238,"y":796,"wires":[["84adc7ab61115326"]]},{"id":"093e9a4fc6067fbe","type":"link out","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"link out 96","mode":"return","links":[],"x":975,"y":996,"wires":[]},{"id":"59aaf14c3a34ee6f","type":"link call","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","links":["106fe2967e41dced"],"linkType":"static","timeout":"30","x":1285,"y":1315,"wires":[["e1e9182cbbbb3eb9"]]},{"id":"858a5a9948ca5ce8","type":"catch","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"","scope":["78152de1e45c8c18","7f5f8e8f9041be65"],"uncaught":false,"x":647,"y":706,"wires":[["ce0e6936b12cc43b"]]},{"id":"a54744c362f980f7","type":"catch","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","scope":["45ec84e93e723b98","9fe5b2e2ec45b3ef","3be4415fdf05acaf","0cea4b8a0b7b0cdc","f04c04f476e9b9c6"],"uncaught":false,"x":955,"y":1260,"wires":[["90942be6906dc62e"]]},{"id":"ce0e6936b12cc43b","type":"debug","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"debug 30","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":818,"y":706,"wires":[]},{"id":"90942be6906dc62e","type":"debug","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"debug 31","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1002,"y":1314,"wires":[]},{"id":"7d74ccf860684abe","type":"http request","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"Fastmail (WellKnown)","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1984,"y":253,"wires":[["95a22bf5e1205c02"]]},{"id":"95a22bf5e1205c02","type":"function","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"store acount_id and upload URL and \\n prepare request draft and emails","func":"msg.fastmail = {\n    ...msg.fastmail,\n    account: msg.payload.accounts,\n    account_id: Object.keys(msg.payload.accounts)[0]\n};\n\nmsg.fastmail[\"uploadUrl\"] = msg.payload.uploadUrl.replace( \"{accountId}\", msg.fastmail.account_id );\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\n\nmsg.url = \"https://api.fastmail.com/jmap/api\"\n\nmsg.payload = {\n        \"using\": [\n            \"urn:ietf:params:jmap:core\",\n            \"urn:ietf:params:jmap:mail\",\n            \"urn:ietf:params:jmap:submission\",\n        ],\n        \"methodCalls\": [\n            [\n                \"Mailbox/query\",\n                {\n                    \"accountId\": msg.fastmail.account_id,\n                    \"filter\": { \n                        \"name\": \"Drafts\" \n                    }\n                },\n                \"a\",\n            ],\n            [\n                \"Identity/get\",\n                {\n                    \"accountId\": msg.fastmail.account_id,\n                },\n                \"pluckaduck\"\n            ]\n        ],\n    };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1694,"y":343,"wires":[["efac3587264d74a5"]]},{"id":"efac3587264d74a5","type":"http request","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"Fastmail (API)","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1994,"y":343,"wires":[["bbd58f295c0e18cf"]]},{"id":"bbd58f295c0e18cf","type":"function","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"store draft id and email2ids list","func":"msg.fastmail = {\n    ...msg.fastmail,\n    draft_mailbox_id: msg.payload[\"methodResponses\"][0][1][\"ids\"][0]\n};\n\nvar emailToId = {};\nvar lst = msg.payload[\"methodResponses\"][1][1]['list'];\n\nfor ( var idx = 0 ; idx < lst.length ; idx++ ) {\n    var dt = lst[idx];\n    emailToId[dt.email] = dt.id;\n}\n\nmsg.fastmail = {\n    ...msg.fastmail,\n    emailsToIds: emailToId\n};\n\ndelete msg.payload;\n\nreturn msg; \n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1717.0001220703125,"y":434,"wires":[["739fdbcd8491e989"]]},{"id":"5d1059e533c2d586","type":"function","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"init request","func":"msg.headers = {\n    \"Authorization\": \"Bearer \" + env.get(\"FASTMAIL_API\")\n}\nmsg.url = \"https://api.fastmail.com/.well-known/jmap\"\n\nmsg.fastmail = {}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1725,"y":253,"wires":[["7d74ccf860684abe"]]},{"id":"dc70ab87b7721ecc","type":"catch","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"","scope":["7d74ccf860684abe","95a22bf5e1205c02","efac3587264d74a5","bbd58f295c0e18cf","5d1059e533c2d586"],"uncaught":false,"x":1757,"y":131,"wires":[["93b5e2879c7e0daf"]]},{"id":"93b5e2879c7e0daf","type":"debug","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"debug 34","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1961,"y":132,"wires":[]},{"id":"b7a122e21273141b","type":"link in","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"[fm] init - v2","links":[],"x":1518,"y":184,"wires":[["5d1059e533c2d586"]]},{"id":"739fdbcd8491e989","type":"link out","z":"90196166b57a77e5","g":"1dc237a9d33d5ed3","name":"link out 105","mode":"return","links":[],"x":2188,"y":510,"wires":[]},{"id":"106fe2967e41dced","type":"link in","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"[fm] send email (no warmup)","links":[],"x":513,"y":851,"wires":[["83cfd48ff8a8440c"]]},{"id":"f04c04f476e9b9c6","type":"zip","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","mode":"compress","filename":"attachment.zip","compressionlevel":"9","outasstring":false,"x":980,"y":1116,"wires":[["3be4415fdf05acaf"]]},{"id":"3f402588b2462b07","type":"template","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"schema - with attachments","field":"schema","fieldType":"msg","format":"json","syntax":"plain","template":"{\n    \"$id\": \"https://blog.openmindmap.org/email-schema.json\",\n    \"title\": \"Email data required on the msg object\",\n    \"type\": \"object\",\n    \"required\": [\n        \"email\"\n    ],\n    \"$defs\": {\n        \"attachment\": {\n            \"type\": \"object\",\n            \"required\": [\n                \"payload\",\n                \"filename\"\n            ],\n            \"properties\": {\n                \"payload\": {\n                    \"type\": \"string\",\n                    \"description\": \"Content of the the attachment.\"\n                },\n                \"filename\": {\n                    \"type\": \"string\",\n                    \"description\": \"File name for the attachment in the zip\"\n                }\n            }\n        }\n    },\n    \"properties\": {\n        \"email\": {\n            \"type\": \"object\",\n            \"required\": [\n                \"to\",\n                \"from\",\n                \"subject\",\n                \"text\",\n                \"html\",\n                \"attachments\"\n            ],\n            \"properties\": {\n                \"from\": {\n                    \"type\": \"string\",\n                    \"description\": \"Sender email.\"\n                },\n                \"from_name\": {\n                    \"type\": \"string\",\n                    \"description\": \"Senders full name.\"\n                },\n                \"to\": {\n                    \"type\": \"string\",\n                    \"description\": \"Receiver email.\"\n                },\n                \"cc\": {\n                    \"type\": [\n                        \"boolean\",\n                        \"string\"\n                    ],\n                    \"description\": \"CC email or blank.\"\n                },\n                \"bcc\": {\n                    \"type\": [\n                        \"boolean\",\n                        \"string\"\n                    ],\n                    \"description\": \"BCC email or blank.\"\n                },\n                \"subject\": {\n                    \"type\": \"string\",\n                    \"description\": \"Subject Line of email\"\n                },\n                \"text\": {\n                    \"type\": \"string\",\n                    \"description\": \"Text of the email without markup\"\n                },\n                \"html\": {\n                    \"type\": \"string\",\n                    \"description\": \"HTML form of the email content containing markup\"\n                },\n                \"attachments\": {\n                    \"type\": \"array\",\n                    \"description\": \"all attachments are bundled together into a single zip file\",\n                    \"minItems\": 1,\n                    \"items\": {\n                        \"$ref\": \"#/$defs/attachment\"\n                    }\n                }\n            }\n        }\n    }\n}","output":"json","x":1472,"y":788,"wires":[["692bd71676d3de82"]]},{"id":"9fdb7c21c58b3376","type":"template","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"schema - attachments optional","field":"schema","fieldType":"msg","format":"json","syntax":"plain","template":"{\n    \"$id\": \"https://blog.openmindmap.org/email-schema.json\",\n    \"title\": \"Email data required on the msg object\",\n    \"type\": \"object\",\n    \"required\": [\n        \"email\"\n    ],\n    \"$defs\": {\n        \"attachment\": {\n            \"type\": \"object\",\n            \"required\": [\n                \"blobId\",\n                \"filename\",\n                \"type\"\n            ],\n            \"properties\": {\n                \"type\": {\n                    \"type\": \"string\",\n                    \"description\": \"Type from fastmail.\"\n                },\n                \"blobId\": {\n                    \"type\": \"string\",\n                    \"description\": \"Blob Id from Fastmail.\"\n                },\n                \"filename\": {\n                    \"type\": \"string\",\n                    \"description\": \"File name for the attachment in the zip\"\n                }\n            }\n        }\n    },\n    \"properties\": {\n        \"email\": {\n            \"type\": \"object\",\n            \"required\": [\n                \"to\",\n                \"from\",\n                \"subject\",\n                \"text\",\n                \"html\"\n            ],\n            \"properties\": {\n                \"from\": {\n                    \"type\": \"string\",\n                    \"description\": \"Sender email.\"\n                },\n                \"from_name\": {\n                    \"type\": \"string\",\n                    \"description\": \"Senders full name.\"\n                },\n                \"to\": {\n                    \"type\": \"string\",\n                    \"description\": \"Receiver email.\"\n                },\n                \"cc\": {\n                    \"type\": [\n                        \"boolean\",\n                        \"string\"\n                    ],\n                    \"description\": \"CC email or blank.\"\n                },\n                \"bcc\": {\n                    \"type\": [\n                        \"boolean\",\n                        \"string\"\n                    ],\n                    \"description\": \"BCC email or blank.\"\n                },\n                \"subject\": {\n                    \"type\": \"string\",\n                    \"description\": \"Subject Line of email\"\n                },\n                \"text\": {\n                    \"type\": \"string\",\n                    \"description\": \"Text of the email without markup\"\n                },\n                \"html\": {\n                    \"type\": \"string\",\n                    \"description\": \"HTML form of the email content containing markup\"\n                },\n                \"attachments\": {\n                    \"type\": \"array\",\n                    \"description\": \"attachments bundled together from Fastmail\",\n                    \"maxItems\": 1,\n                    \"minItems\": 0,\n                    \"items\": {\n                        \"$ref\": \"#/$defs/attachment\"\n                    }\n                }\n            }\n        }\n    }\n}","output":"json","x":1482,"y":712,"wires":[["692bd71676d3de82"]]},{"id":"73dac43bf4779cb5","type":"link in","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"[fm] [validate] with attachments","links":[],"x":1273,"y":788,"wires":[["3f402588b2462b07"]]},{"id":"692bd71676d3de82","type":"function","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"JSON Schema validator","func":"var validator = new Ajv({\n    allErrors: true,\n    messages: true\n})\n\nconst validate = validator.compile(msg.schema)\n\nconst v = validate(msg);\n\nif ( !v ) {\n    msg.errors = validate.errors;\n    return [undefined,msg]\n} else {\n    delete msg.schema;\n    return [msg,undefined];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"Ajv","module":"ajv"}],"x":1771,"y":754,"wires":[["09f7cf96e80153ab"],["07a8907768caa53e"]],"outputLabels":["ok","failed"]},{"id":"09f7cf96e80153ab","type":"link out","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"link out 113","mode":"return","links":[],"x":1959,"y":706,"wires":[]},{"id":"07a8907768caa53e","type":"debug","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"Jmap: msg.email is invalid","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2063,"y":790,"wires":[]},{"id":"63d1d1d10a4ee4a8","type":"link in","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"[fm] [validate] attachment optional","links":[],"x":1273,"y":712,"wires":[["9fdb7c21c58b3376"]]},{"id":"55d5b086789d07da","type":"catch","z":"90196166b57a77e5","g":"0685abf61dd56bf7","name":"","scope":["692bd71676d3de82"],"uncaught":false,"x":1780,"y":790,"wires":[["07a8907768caa53e"]]},{"id":"83cfd48ff8a8440c","type":"link call","z":"90196166b57a77e5","g":"913082e616d84dfa","name":"","links":["63d1d1d10a4ee4a8"],"linkType":"static","timeout":"30","x":762,"y":851,"wires":[["78152de1e45c8c18"]]},{"id":"c99733849359cac7","type":"link call","z":"90196166b57a77e5","g":"e6f09bcaca0642ce","name":"","links":["73dac43bf4779cb5"],"linkType":"static","timeout":"30","x":629,"y":1115,"wires":[["f20245aba2053f83"]]}]