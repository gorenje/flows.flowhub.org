[{"id":"d0506e991d512ace","type":"tab","label":"[Introspection] Develop Node-RED nodes in Node-RED","disabled":false,"info":"::: aim\n\nProvide a backbone for the development nodes within Node-RED.\n\n:::\n\n::: requirements\n\n- [nodedev node package](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-nodedev)\n- the [holistic JSON schema validator](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-validation-and-documentation)\n\n- For GitHub commits, the repository has to be created and one commit needs to have been done.\n- GITHUB_TOKEN set in the env, details described in the [GitHub Base functionality](https://flowhub.org/f/390ee0021ded4910)\n\n- For NPM publish, there needs to be an env variable `NPM_AUTH_TOKEN` that needs to be defined.\n- For NPM publish, authentication is assumed to be OTP (one time password) and the OTP has to be entered, the flow deployed and then the button pressed. So an OTP with longer expiry might be good.\n\n::: \n\n\n<!--\n// [] aba9a5d741241f1c [group] \"entry point\"\n// [] f3879ed58795ea91 [group] \"example message\"\n// [] 8c02f3fe5cd0a0a9 [group] \"GitHub API Functionality\"\n// [] d8867a43abe7260c [group] \"Entry points\"\n// [] 3ccaf963f1e72024 [group] \"\"\n// [] 56b55d2b5d03f424 [group] \"Node-RED local installation\"\n// [] 5d202e6481e451cb [group] \"GitHub functionality\"\n// [] 94fb93c898275493 [group] \"NPM Publish\"\n// [] 88aca7ba3d72dff1 [group] \"NPM Unpublish\"\n-->\n\n\n\n::: background\n\nThis flow provides the following functionality:\n\n- <a class=\"ahl-group-only\" data-ids=\"56b55d2b5d03f424\">Local installation</a> of node code developed using the [nodedev](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-nodedev) node package\n- <a class=\"ahl-group-only\" data-ids=\"5d202e6481e451cb\">GitHub commit</a> functionality so that all package files are committed in the correct repo structure.\n- <a class=\"ahl-group-only\" data-ids=\"94fb93c898275493\">NPM Publish</a> to bring the node package to market, and\n- <a class=\"ahl-group-only\" data-ids=\"88aca7ba3d72dff1\">NPM Unpublish</a> in cases of mistakes.\n\nValidation of the `msg` object and example of required properties are <a class=\"ahl-group-only\" data-ids=\"3ccaf963f1e72024\">also provided</a>.\n\n:::\n\n\n### Assumption\n\nThat the package name is scoped with a username, i.e. `@username/node-red-contrib-XYZ`.\n\nThe registry to publish to is assumed to be `https://registry.npmjs.org`.\n\nAlso some requirements as defined in the [creating your own node](https://nodered.org/docs/creating-nodes/packaging) have been enforced by the <a class=\"ahl-node-only\" data-ids=\"2a7132258cbcf313\">package validation node</a>.\n\n::: discussion \n\nIf I want to extend my Emacs, I don't open Vi to create my extensions, I do this in Emacs. I extend Emacs *with* Emacs.\n\nWhy should this be any different in Node-RED? This flow is part of demonstrating how that idea *could* work in Node-RED.\n\n:::\n\n### Related flows\n\n- [nodedev node package development](https://flowhub.org/f/b92be5062203ff69)\n\n### Usage examples\n\n- [Neural-Network Builder](https://flowhub.org/f/f7e009091ef2d6b0)\n- [JSON Schema Validation + Documentation](https://flowhub.org/f/a7a81bcd7159a826)\n- [Introspection package](https://flowhub.org/f/d73d76db3df96ba2)\n- [FlowHub nodes](https://flowhub.org/f/4a831589774ecb04)\n\n","env":[]},{"id":"aba9a5d741241f1c","type":"group","z":"d0506e991d512ace","name":"entry point","style":{"label":true,"fill":"#c8e7a7","fill-opacity":"0.83"},"nodes":["963dfb765b0d9849"],"x":1357.285888671875,"y":683.6216430664062,"w":82,"h":82},{"id":"3ccaf963f1e72024","type":"group","z":"d0506e991d512ace","name":"","style":{"fill":"#ffffbf","fill-opacity":"0.58","label":true},"nodes":["992dea9edfe05367","f3879ed58795ea91"],"x":853.9999771118164,"y":822.2857598236628,"w":452,"h":196.33588324274342},{"id":"56b55d2b5d03f424","type":"group","z":"d0506e991d512ace","name":"Node-RED local installation","style":{"label":true},"nodes":["2683d81e8a4b64ab","f07d2d09465ca725","3a0d53eb62336e62"],"x":1871.567626953125,"y":253,"w":212,"h":197.79378700256348},{"id":"5d202e6481e451cb","type":"group","z":"d0506e991d512ace","name":"GitHub functionality","style":{"label":true},"nodes":["8b5643cf5e2dccc4","b49254be1ffd7f40","52c9d2dbb39a90ed","b1ad2d6f00cd4476","c37193279bcb55cd","b522a5152706ad07","4de77b4ed267a790","bb3ee2c3d46386a3","29ed87438e7e6749","25f729f47986b0f8","f8774c1c32f1631d","ef98698a4b696e66","5226230f86c9c784","e68b9f9bac76350a","eea2441a833743f5","971ddff1a67a201f","732f4fa715c2fa78","255cf2c177f684a9","79b43c9ce292f151","0cb6ad0a57a95eee","bfe2775a7cf26d83","db90fad4367ba42e"],"x":2125,"y":253,"w":816,"h":1030.12158203125},{"id":"94fb93c898275493","type":"group","z":"d0506e991d512ace","name":"NPM Publish","style":{"label":true},"nodes":["0951d8657919ec86","fbe982a35d27d99b","33093265f4dfec9d","de9fefd043701d43","3884411f8afe9e4a"],"x":1491,"y":1571.264404296875,"w":292,"h":285.110595703125},{"id":"88aca7ba3d72dff1","type":"group","z":"d0506e991d512ace","name":"NPM Unpublish","style":{"label":true},"nodes":["3e9ac86aba852cdc","3f9377f9c6c4572b","3a58f10bf6055793","a923f6c1827a644a"],"x":1791.567626953125,"y":1302.6606969322477,"w":292,"h":249.71418099743983},{"id":"f3879ed58795ea91","type":"group","z":"d0506e991d512ace","g":"3ccaf963f1e72024","name":"example message","style":{"fill":"#addb7b","label":true},"nodes":["9c62729b0ebd76ad"],"x":907.5716323852539,"y":848.2857598236628,"w":332,"h":82},{"id":"db90fad4367ba42e","type":"junction","z":"d0506e991d512ace","g":"5d202e6481e451cb","x":2158.142863512039,"y":1234.428562283516,"wires":[[]]},{"id":"893f316ea815e2b1","type":"junction","z":"d0506e991d512ace","x":1371.9389214515686,"y":1232.1216430664062,"wires":[["2683d81e8a4b64ab","0951d8657919ec86","3e9ac86aba852cdc","bfe2775a7cf26d83"]]},{"id":"2683d81e8a4b64ab","type":"switch","z":"d0506e991d512ace","g":"56b55d2b5d03f424","name":"noderedinstall","property":"noderedinstall","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1977.567626953125,"y":409.7937870025635,"wires":[["3a0d53eb62336e62"]]},{"id":"8b5643cf5e2dccc4","type":"switch","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"gitcommit","property":"gitcommit","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":2546,"y":1242.12158203125,"wires":[["29ed87438e7e6749"]]},{"id":"0951d8657919ec86","type":"switch","z":"d0506e991d512ace","g":"94fb93c898275493","name":"npmpublish","property":"npmpublish","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1637,"y":1612.264404296875,"wires":[["3884411f8afe9e4a"]]},{"id":"b49254be1ffd7f40","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"prepare tree","func":"msg.payload = msg.contents.map( (elem) => {\n    var newelem = { ...elem};\n    \n    if ( elem.type != \"base64\") {\n        // @ts-ignore\n        newelem.contents = RED.util.ensureBuffer(elem.contents).toString('base64')\n    }\n\n    delete newelem.type;\n    return newelem;\n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2311,"y":764.299679026884,"wires":[["b1ad2d6f00cd4476"]]},{"id":"52c9d2dbb39a90ed","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"owner, repo, branch, author","rules":[{"t":"set","p":"owner","pt":"msg","to":"githubowner","tot":"msg"},{"t":"set","p":"repo","pt":"msg","to":"githubrepo","tot":"msg"},{"t":"set","p":"branch","pt":"msg","to":"githubbranch","tot":"msg"},{"t":"set","p":"author","pt":"msg","to":"{\t    \"name\": $$.githubauthor,\t    \"email\": $$.githubauthoremail\t}","tot":"jsonata"},{"t":"set","p":"message","pt":"msg","to":"commit_message","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2311,"y":1056.688406551585,"wires":[["f8774c1c32f1631d"]]},{"id":"b1ad2d6f00cd4476","type":"split","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2311,"y":705.8219335219437,"wires":[["c37193279bcb55cd"]]},{"id":"c37193279bcb55cd","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","rules":[{"t":"set","p":"filename","pt":"msg","to":"payload.name","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.contents","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2555,"y":705.3442005830652,"wires":[["ef98698a4b696e66"]]},{"id":"b522a5152706ad07","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"path\": $$.filename,\t    \"sha\": $$.payload\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2555,"y":588.3887095731848,"wires":[["4de77b4ed267a790"]]},{"id":"4de77b4ed267a790","type":"join","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2308,"y":540.9109497070312,"wires":[["255cf2c177f684a9"]]},{"id":"bb3ee2c3d46386a3","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","rules":[{"t":"set","p":"parent_sha","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2311,"y":939.7329155417046,"wires":[["971ddff1a67a201f"]]},{"id":"42b6d95993c54b76","type":"debug","z":"d0506e991d512ace","name":"new github commit revision","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":3117,"y":440.35968017578125,"wires":[]},{"id":"3e9ac86aba852cdc","type":"switch","z":"d0506e991d512ace","g":"88aca7ba3d72dff1","name":"npmunpublish","property":"npmunpublish","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1937.567626953125,"y":1343.6606969322477,"wires":[["a923f6c1827a644a"]]},{"id":"1ee5da0dca96b684","type":"debug","z":"d0506e991d512ace","name":"result of npm unpublish","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3107,"y":1511.3748779296875,"wires":[]},{"id":"2a7132258cbcf313","type":"function","z":"d0506e991d512ace","name":"Package.json validator","func":"/* must have a package.json */\n\nvar pkgjson = msg.contents.filter((d) => {\n    return d.name == \"package.json\"\n});\n\nif ( pkgjson.length != 1 ) {\n    if ( pkgjson.length > 1 ) {\n      node.error(\"multiple package.json files found\", msg)\n    } else {\n      node.error(\"no package.json file found\", msg)\n    }\n    node.done();\n    return;\n}\n\n/* name must be scoped */\n\nvar manifest = JSON.parse(pkgjson[0].contents);\n\nvar pdetails = manifest.name.split(\"/\")\n\nif (pdetails.length < 2 || pdetails[0][0] != '@') {\n    node.error(\"package name not scoped: \" + manifest.name, msg)\n    node.done();\n    return\n}\n\n/* need to provide an node-red supported engine version */\n\nif ( !manifest[\"node-red\"] || !manifest[\"node-red\"].version ) {\n    msg.error = {\n      message: \"Node-RED supported version missing in package.json, see https://nodered.org/docs/creating-nodes/packaging for more details\"\n    }\n    node.error(\"Node-RED supported engine version not supplied in package.json\", msg)\n    node.done();\n    return\n}\n\n/* also ensure there is an nodejs engine supported version salvo */\n\nif ( !manifest.engines || !manifest.engines.node ) {\n    msg.error = {\n      message: \"Nodejs supported version missing in package.json, see https://docs.npmjs.com/cli/v7/configuring-npm/package-json#engines for more details\"\n    }\n    node.error(\"Nodejs supported engine version not supplied in package.json\", msg)\n    node.done();\n    return\n}\n\n/* ensure contents is not empty */\n\nmsg.contents.forEach( (d) => {\n  if ( !d.contents || d.contents.trim() == \"\" ) {\n    node.error(\"file empty: \" + d.name, msg)\n    node.done();\n    return\n  }\n});\n\n\n/* ensure that the homepage points to an existing file */\n\nvar hsh = (Url.parse(manifest.homepage).hash || \"\").substr(1)\nvar rdme = msg.contents.filter((d) => { return d.name == hsh || d.name.replace(/\\.md$/i, '').toLowerCase() == hsh })\n\nif (rdme.length == 0) {\n  msg.error = {\n    message: \"Package.json homepage url does not link to a file in this package, this needs to be the case for nodered.org.\"\n  }\n  node.error(\"Package.json homepage url does not link to a file in this package, this needs to be the case for nodered.org.\", msg)\n  node.done();\n  return\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"Ajv","module":"ajv"},{"var":"Url","module":"url"}],"x":1066.14306640625,"y":1232.1216430664062,"wires":[["893f316ea815e2b1"]],"outputLabels":["ok"]},{"id":"8d90825de93a4fa0","type":"catch","z":"d0506e991d512ace","name":"","scope":null,"uncaught":false,"x":2880.7142944335938,"y":1396.285659790039,"wires":[["750dfdf64f5d1216"]]},{"id":"750dfdf64f5d1216","type":"debug","z":"d0506e991d512ace","name":"Exceptions Will Happen","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3107,"y":1396.285659790039,"wires":[]},{"id":"9c62729b0ebd76ad","type":"inject","z":"d0506e991d512ace","g":"f3879ed58795ea91","name":"example contents for message","props":[{"p":"pname","v":"@gregoriusrippenstein/node-red-contrib-nodedev","vt":"str"},{"p":"pversion","v":"0.0.3","vt":"str"},{"p":"noderedinstall","v":"true","vt":"bool"},{"p":"gitcommit","v":"false","vt":"bool"},{"p":"githubowner","v":"gorenje","vt":"str"},{"p":"githubrepo","v":"node-red-contrib-nodedev","vt":"str"},{"p":"githubbranch","v":"main","vt":"str"},{"p":"commit_message","v":"nice commit message","vt":"str"},{"p":"githubauthor","v":"Gerrit Riessen","vt":"str"},{"p":"githubauthoremail","v":"gerrit@openmindmap.org","vt":"str"},{"p":"npmpublish","v":"false","vt":"bool"},{"p":"npmunpublish","v":"false","vt":"bool"},{"p":"npmotp","v":"123456","vt":"str"},{"p":"contents","v":"{}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":1083.571632385254,"y":889.2857598236628,"wires":[[]]},{"id":"f07d2d09465ca725","type":"NodeRedInstall","z":"d0506e991d512ace","g":"56b55d2b5d03f424","name":"","x":1974.71044921875,"y":294,"wires":[[]]},{"id":"3a0d53eb62336e62","type":"NpmTarBall","z":"d0506e991d512ace","g":"56b55d2b5d03f424","name":"","x":1974.71044921875,"y":354.3969020843506,"wires":[["f07d2d09465ca725"]]},{"id":"fbe982a35d27d99b","type":"NpmTarBall","z":"d0506e991d512ace","g":"94fb93c898275493","name":"","x":1637,"y":1764.5973510742188,"wires":[["33093265f4dfec9d"]]},{"id":"33093265f4dfec9d","type":"NpmPublish","z":"d0506e991d512ace","g":"94fb93c898275493","name":"","otp":"","action":"publish","authToken":"NPM_AUTH_TOKEN","authTokenType":"env","x":1637,"y":1815.375,"wires":[["2f4b14f27919dfab"]]},{"id":"2f4b14f27919dfab","type":"debug","z":"d0506e991d512ace","name":"result of npm publish","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3097,"y":1815.375,"wires":[]},{"id":"3f9377f9c6c4572b","type":"NpmPublish","z":"d0506e991d512ace","g":"88aca7ba3d72dff1","name":"Npm Unpublish","otp":"","action":"unpublish","authToken":"NPM_AUTH_TOKEN","authTokenType":"env","x":1937.567626953125,"y":1511.3748779296875,"wires":[["1ee5da0dca96b684"]]},{"id":"29ed87438e7e6749","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","property":"","propertyType":"env","checkentireobject":true,"func":"{\n    \"title\": \"Environment check for GitHub\",\n    \"type\": \"object\",\n    \"required\": [\n        \"GITHUB_TOKEN\"\n    ],\n    \"properties\": {\n        \"GITHUB_TOKEN\": {\n            \"type\": \"string\",\n            \"description\": \"GitHub authentication token.\"\n        }\n    }\n}","schematitle":"Environment check for GitHub","x":2311,"y":1173.6438975614656,"wires":[["25f729f47986b0f8"]],"info":"## Environment check for GitHub Type\n\n`object` ([Environment check for GitHub](definition.md))\n\n# Environment check for GitHub Properties\n\n| Property                       | Type     | Required | Nullable       | Defined by                                                                                                 |\n| :----------------------------- | :------- | :------- | :------------- | :--------------------------------------------------------------------------------------------------------- |\n| [GITHUB\\_TOKEN](#github_token) | `string` | Required | cannot be null | [Environment check for GitHub](definition-properties-github_token.md \"undefined#/properties/GITHUB_TOKEN\") |\n\n## GITHUB\\_TOKEN\n\nGitHub authentication token.\n\n`GITHUB_TOKEN`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Environment check for GitHub](definition-properties-github_token.md \"undefined#/properties/GITHUB_TOKEN\")\n\n### GITHUB\\_TOKEN Type\n\n`string`\n\n---\n## GITHUB\\_TOKEN Type\n\n`string`\n"},{"id":"a923f6c1827a644a","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"88aca7ba3d72dff1","name":"","property":"","propertyType":"env","checkentireobject":true,"func":"{\n    \"title\": \"Environment check for NPM\",\n    \"type\": \"object\",\n    \"required\": [\n        \"NPM_AUTH_TOKEN\"\n    ],\n    \"properties\": {\n        \"NPM_AUTH_TOKEN\": {\n            \"type\": \"string\",\n            \"description\": \"NPM authentication token.\"\n        }\n    }\n}","schematitle":"Environment check for NPM","x":1937.567626953125,"y":1399.5654239313942,"wires":[["3a58f10bf6055793"]],"info":"## Environment check for NPM Type\n\n`object` ([Environment check for NPM](definition.md))\n\n# Environment check for NPM Properties\n\n| Property                            | Type     | Required | Nullable       | Defined by                                                                                                  |\n| :---------------------------------- | :------- | :------- | :------------- | :---------------------------------------------------------------------------------------------------------- |\n| [NPM\\_AUTH\\_TOKEN](#npm_auth_token) | `string` | Required | cannot be null | [Environment check for NPM](definition-properties-npm_auth_token.md \"undefined#/properties/NPM_AUTH_TOKEN\") |\n\n## NPM\\_AUTH\\_TOKEN\n\nNPM authentication token.\n\n`NPM_AUTH_TOKEN`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Environment check for NPM](definition-properties-npm_auth_token.md \"undefined#/properties/NPM_AUTH_TOKEN\")\n\n### NPM\\_AUTH\\_TOKEN Type\n\n`string`\n\n---\n## NPM\\_AUTH\\_TOKEN Type\n\n`string`\n"},{"id":"3884411f8afe9e4a","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"94fb93c898275493","name":"","property":"","propertyType":"env","checkentireobject":true,"func":"{\n    \"title\": \"Environment check for NPM\",\n    \"type\": \"object\",\n    \"required\": [\n        \"NPM_AUTH_TOKEN\"\n    ],\n    \"properties\": {\n        \"NPM_AUTH_TOKEN\": {\n            \"type\": \"string\",\n            \"description\": \"NPM authentication token.\"\n        }\n    }\n}","schematitle":"Environment check for NPM","x":1637,"y":1663.0420532226562,"wires":[["de9fefd043701d43"]],"info":"## Environment check for NPM Type\n\n`object` ([Environment check for NPM](definition.md))\n\n# Environment check for NPM Properties\n\n| Property                            | Type     | Required | Nullable       | Defined by                                                                                                  |\n| :---------------------------------- | :------- | :------- | :------------- | :---------------------------------------------------------------------------------------------------------- |\n| [NPM\\_AUTH\\_TOKEN](#npm_auth_token) | `string` | Required | cannot be null | [Environment check for NPM](definition-properties-npm_auth_token.md \"undefined#/properties/NPM_AUTH_TOKEN\") |\n\n## NPM\\_AUTH\\_TOKEN\n\nNPM authentication token.\n\n`NPM_AUTH_TOKEN`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Environment check for NPM](definition-properties-npm_auth_token.md \"undefined#/properties/NPM_AUTH_TOKEN\")\n\n### NPM\\_AUTH\\_TOKEN Type\n\n`string`\n\n---\n## NPM\\_AUTH\\_TOKEN Type\n\n`string`\n"},{"id":"3a58f10bf6055793","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"88aca7ba3d72dff1","name":"","property":"","propertyType":"msg","checkentireobject":true,"func":"{\n    \"title\": \"Check `msg` for NPM publish\",\n    \"type\": \"object\",\n    \"required\": [\n        \"npmotp\"\n    ],\n    \"properties\": {\n        \"npmotp\": {\n            \"type\": \"string\",\n            \"description\": \"One Time Password for NPM.\"\n        }\n    }\n}","schematitle":"Check `msg` for NPM publish","x":1937.567626953125,"y":1455.4701509305407,"wires":[["3f9377f9c6c4572b"]],"info":"## Check \\`msg\\` for NPM publish Type\n\n`object` ([Check \\`msg\\` for NPM publish](definition.md))\n\n# Check \\`msg\\` for NPM publish Properties\n\n| Property          | Type     | Required | Nullable       | Defined by                                                                                      |\n| :---------------- | :------- | :------- | :------------- | :---------------------------------------------------------------------------------------------- |\n| [npmotp](#npmotp) | `string` | Required | cannot be null | [Check \\`msg\\` for NPM publish](definition-properties-npmotp.md \"undefined#/properties/npmotp\") |\n\n## npmotp\n\nOne Time Password for NPM.\n\n`npmotp`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` for NPM publish](definition-properties-npmotp.md \"undefined#/properties/npmotp\")\n\n### npmotp Type\n\n`string`\n\n---\n## npmotp Type\n\n`string`\n"},{"id":"25f729f47986b0f8","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","property":"","propertyType":"msg","checkentireobject":true,"func":"{\n    \"title\": \"Check `msg` object for GitHub commit.\",\n    \"type\": \"object\",\n    \"required\": [\n        \"commit_message\",\n        \"githubowner\",\n        \"githubrepo\",\n        \"githubbranch\",\n        \"githubauthor\",\n        \"githubauthoremail\"\n    ],\n    \"properties\": {\n        \"commit_message\": {\n            \"type\": \"string\",\n            \"description\": \"Message for the commit.\"\n        },\n        \"githubowner\": {\n            \"type\": \"string\",\n            \"description\": \"GitHub username.\"\n        },\n        \"githubrepo\": {\n            \"type\": \"string\",\n            \"description\": \"Repository upon which we are acting.\"\n        },\n        \"githubbranch\": {\n            \"type\": \"string\",\n            \"description\": \"The branch on which the commit should be done.\"\n        },\n        \"githubauthor\": {\n            \"type\": \"string\",\n            \"description\": \"Full name of the author of the commit.\"\n        },\n        \"githubauthoremail\": {\n            \"type\": \"string\",\n            \"description\": \"Email of the author for the commit message.\"\n        },\n        \"gitcheckforchange\": {\n            \"type\": \"boolean\",\n            \"description\": \"Do not commit just check whether there are changes.\"\n        }\n    }\n}\n","schematitle":"Check `msg` object for GitHub commit.","x":2311,"y":1115.1661520565253,"wires":[["52c9d2dbb39a90ed"]],"info":"## Check \\`msg\\` object for GitHub commit. Type\n\n`object` ([Check \\`msg\\` object for GitHub commit.](definition.md))\n\n# Check \\`msg\\` object for GitHub commit. Properties\n\n| Property                                | Type      | Required | Nullable       | Defined by                                                                                                                      |\n| :-------------------------------------- | :-------- | :------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------ |\n| [commit\\_message](#commit_message)      | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-commit_message.md \"undefined#/properties/commit_message\")       |\n| [githubowner](#githubowner)             | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-githubowner.md \"undefined#/properties/githubowner\")             |\n| [githubrepo](#githubrepo)               | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-githubrepo.md \"undefined#/properties/githubrepo\")               |\n| [githubbranch](#githubbranch)           | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-githubbranch.md \"undefined#/properties/githubbranch\")           |\n| [githubauthor](#githubauthor)           | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-githubauthor.md \"undefined#/properties/githubauthor\")           |\n| [githubauthoremail](#githubauthoremail) | `string`  | Required | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-githubauthoremail.md \"undefined#/properties/githubauthoremail\") |\n| [gitcheckforchange](#gitcheckforchange) | `boolean` | Optional | cannot be null | [Check \\`msg\\` object for GitHub commit.](definition-properties-gitcheckforchange.md \"undefined#/properties/gitcheckforchange\") |\n\n## commit\\_message\n\nMessage for the commit.\n\n`commit_message`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-commit_message.md \"undefined#/properties/commit_message\")\n\n### commit\\_message Type\n\n`string`\n\n## githubowner\n\nGitHub username.\n\n`githubowner`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-githubowner.md \"undefined#/properties/githubowner\")\n\n### githubowner Type\n\n`string`\n\n## githubrepo\n\nRepository upon which we are acting.\n\n`githubrepo`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-githubrepo.md \"undefined#/properties/githubrepo\")\n\n### githubrepo Type\n\n`string`\n\n## githubbranch\n\nThe branch on which the commit should be done.\n\n`githubbranch`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-githubbranch.md \"undefined#/properties/githubbranch\")\n\n### githubbranch Type\n\n`string`\n\n## githubauthor\n\nFull name of the author of the commit.\n\n`githubauthor`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-githubauthor.md \"undefined#/properties/githubauthor\")\n\n### githubauthor Type\n\n`string`\n\n## githubauthoremail\n\nEmail of the author for the commit message.\n\n`githubauthoremail`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-githubauthoremail.md \"undefined#/properties/githubauthoremail\")\n\n### githubauthoremail Type\n\n`string`\n\n## gitcheckforchange\n\nDo not commit just check whether there are changes.\n\n`gitcheckforchange`\n\n*   is optional\n\n*   Type: `boolean`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` object for GitHub commit.](definition-properties-gitcheckforchange.md \"undefined#/properties/gitcheckforchange\")\n\n### gitcheckforchange Type\n\n`boolean`\n\n---\n## commit\\_message Type\n\n`string`\n\n---\n## githubowner Type\n\n`string`\n\n---\n## githubrepo Type\n\n`string`\n\n---\n## githubbranch Type\n\n`string`\n\n---\n## githubauthor Type\n\n`string`\n\n---\n## githubauthoremail Type\n\n`string`\n\n---\n## gitcheckforchange Type\n\n`boolean`\n"},{"id":"992dea9edfe05367","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"3ccaf963f1e72024","name":"","property":"","propertyType":"msg","checkentireobject":true,"func":"{\n    \"title\": \"Basic requirements for `msg` object to utilise this flow.\",\n    \"$id\": \"docid\",\n    \"type\": \"object\",\n    \"required\": [\n        \"noderedinstall\",\n        \"gitcommit\",\n        \"npmpublish\",\n        \"npmunpublish\",\n        \"contents\"\n    ],\n    \"$defs\": {\n        \"content\": {\n            \"type\": \"object\",\n            \"required\": [\n                \"name\",\n                \"contents\"\n            ],\n            \"properties\": {\n                \"name\": {\n                    \"type\": \"string\",\n                    \"description\": \"Name of the file to be included in the package.\"\n                },\n                \"contents\": {\n                    \"type\": \"string\",\n                    \"description\": \"Contents of the file to be included in the package. Binary data should be encoded in base64.\"\n                },\n                \"type\": {\n                    \"type\": \"string\",\n                    \"description\": \"Value describes the type of the content, default is utf-8.\",\n                    \"enum\": [\n                        \"text\",\n                        \"utf-8\",\n                        \"html\",\n                        \"javascript\",\n                        \"markdown\",\n                        \"json\",\n                        \"base64\"\n                    ]\n                }\n            }\n        }\n    },\n    \"properties\": {\n        \"noderedinstall\": {\n            \"type\": \"boolean\",\n            \"description\": \"Install the node into Node-RED.\"\n        },\n        \"gitcommit\": {\n            \"type\": \"boolean\",\n            \"description\": \"Perform a GitHub commit with the package files.\"\n        },\n        \"npmpublish\": {\n            \"type\": \"boolean\",\n            \"description\": \"Publish package to NPM.\"\n        },\n        \"npmunpublish\": {\n            \"type\": \"boolean\",\n            \"description\": \"Unpublish package to NPM.\"\n        },\n        \"contents\": {\n            \"type\": \"array\",\n            \"description\": \"Contents of the package, all names should be prefixed with package/. Minimum: LICENSE, README and package.json --> 3.\",\n            \"minItems\": 3,\n            \"items\": {\n                \"$ref\": \"docid#/$defs/content\"\n            }\n        }\n    }\n}","schematitle":"Basic requirements for `msg` object to utilise this flow.","x":1079.9999771118164,"y":977.6216430664062,"wires":[["d485bbfece99d118"]],"info":"## Basic requirements for \\`msg\\` object to utilise this flow. Type\n\n`object` ([Basic requirements for \\`msg\\` object to utilise this flow.](definition.md))\n\n# Basic requirements for \\`msg\\` object to utilise this flow. Properties\n\n| Property                          | Type      | Required | Nullable       | Defined by                                                                                                                                |\n| :-------------------------------- | :-------- | :------- | :------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |\n| [noderedinstall](#noderedinstall) | `boolean` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-noderedinstall.md \"docid#/properties/noderedinstall\") |\n| [gitcommit](#gitcommit)           | `boolean` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-gitcommit.md \"docid#/properties/gitcommit\")           |\n| [npmpublish](#npmpublish)         | `boolean` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-npmpublish.md \"docid#/properties/npmpublish\")         |\n| [npmunpublish](#npmunpublish)     | `boolean` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-npmunpublish.md \"docid#/properties/npmunpublish\")     |\n| [contents](#contents)             | `array`   | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-contents.md \"docid#/properties/contents\")             |\n\n## noderedinstall\n\nInstall the node into Node-RED.\n\n`noderedinstall`\n\n*   is required\n\n*   Type: `boolean`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-noderedinstall.md \"docid#/properties/noderedinstall\")\n\n### noderedinstall Type\n\n`boolean`\n\n## gitcommit\n\nPerform a GitHub commit with the package files.\n\n`gitcommit`\n\n*   is required\n\n*   Type: `boolean`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-gitcommit.md \"docid#/properties/gitcommit\")\n\n### gitcommit Type\n\n`boolean`\n\n## npmpublish\n\nPublish package to NPM.\n\n`npmpublish`\n\n*   is required\n\n*   Type: `boolean`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-npmpublish.md \"docid#/properties/npmpublish\")\n\n### npmpublish Type\n\n`boolean`\n\n## npmunpublish\n\nUnpublish package to NPM.\n\n`npmunpublish`\n\n*   is required\n\n*   Type: `boolean`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-npmunpublish.md \"docid#/properties/npmunpublish\")\n\n### npmunpublish Type\n\n`boolean`\n\n## contents\n\nContents of the package, all names should be prefixed with package/. Minimum: LICENSE, README and package.json --> 3.\n\n`contents`\n\n*   is required\n\n*   Type: `object[]` ([Details](definition-properties-contents-items.md))\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-properties-contents.md \"docid#/properties/contents\")\n\n### contents Type\n\n`object[]` ([Details](definition-properties-contents-items.md))\n\n### contents Constraints\n\n**minimum number of items**: the minimum number of items for this array is: `3`\n\n# Basic requirements for \\`msg\\` object to utilise this flow. Definitions\n\n## Definitions group content\n\nReference this group by using\n\n```json\n{\"$ref\":\"docid#/$defs/content\"}\n```\n\n| Property                | Type     | Required | Nullable       | Defined by                                                                                                                                               |\n| :---------------------- | :------- | :------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| [name](#name)           | `string` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-name.md \"docid#/$defs/content/properties/name\")         |\n| [contents](#contents-1) | `string` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-contents.md \"docid#/$defs/content/properties/contents\") |\n| [type](#type)           | `string` | Optional | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-type.md \"docid#/$defs/content/properties/type\")         |\n\n### name\n\nName of the file to be included in the package.\n\n`name`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-name.md \"docid#/$defs/content/properties/name\")\n\n#### name Type\n\n`string`\n\n### contents\n\nContents of the file to be included in the package. Binary data should be encoded in base64.\n\n`contents`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-contents.md \"docid#/$defs/content/properties/contents\")\n\n#### contents Type\n\n`string`\n\n### type\n\nValue describes the type of the content, default is utf-8.\n\n`type`\n\n*   is optional\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-type.md \"docid#/$defs/content/properties/type\")\n\n#### type Type\n\n`string`\n\n#### type Constraints\n\n**enum**: the value of this property must be equal to one of the following values:\n\n| Value          | Explanation |\n| :------------- | :---------- |\n| `\"text\"`       |             |\n| `\"utf-8\"`      |             |\n| `\"html\"`       |             |\n| `\"javascript\"` |             |\n| `\"markdown\"`   |             |\n| `\"json\"`       |             |\n| `\"base64\"`     |             |\n\n---\n## $defs Type\n\nunknown\n\n---\n## items Type\n\n`object` ([Details](definition-defs-content.md))\n\n# items Properties\n\n| Property              | Type     | Required | Nullable       | Defined by                                                                                                                                               |\n| :-------------------- | :------- | :------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| [name](#name)         | `string` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-name.md \"docid#/$defs/content/properties/name\")         |\n| [contents](#contents) | `string` | Required | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-contents.md \"docid#/$defs/content/properties/contents\") |\n| [type](#type)         | `string` | Optional | cannot be null | [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-type.md \"docid#/$defs/content/properties/type\")         |\n\n## name\n\nName of the file to be included in the package.\n\n`name`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-name.md \"docid#/$defs/content/properties/name\")\n\n### name Type\n\n`string`\n\n## contents\n\nContents of the file to be included in the package. Binary data should be encoded in base64.\n\n`contents`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-contents.md \"docid#/$defs/content/properties/contents\")\n\n### contents Type\n\n`string`\n\n## type\n\nValue describes the type of the content, default is utf-8.\n\n`type`\n\n*   is optional\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Basic requirements for \\`msg\\` object to utilise this flow.](definition-defs-content-properties-type.md \"docid#/$defs/content/properties/type\")\n\n### type Type\n\n`string`\n\n### type Constraints\n\n**enum**: the value of this property must be equal to one of the following values:\n\n| Value          | Explanation |\n| :------------- | :---------- |\n| `\"text\"`       |             |\n| `\"utf-8\"`      |             |\n| `\"html\"`       |             |\n| `\"javascript\"` |             |\n| `\"markdown\"`   |             |\n| `\"json\"`       |             |\n| `\"base64\"`     |             |\n\n---\n## name Type\n\n`string`\n\n---\n## contents Type\n\n`string`\n\n---\n## type Type\n\n`string`\n\n## type Constraints\n\n**enum**: the value of this property must be equal to one of the following values:\n\n| Value          | Explanation |\n| :------------- | :---------- |\n| `\"text\"`       |             |\n| `\"utf-8\"`      |             |\n| `\"html\"`       |             |\n| `\"javascript\"` |             |\n| `\"markdown\"`   |             |\n| `\"json\"`       |             |\n| `\"base64\"`     |             |\n\n---\n## noderedinstall Type\n\n`boolean`\n\n---\n## gitcommit Type\n\n`boolean`\n\n---\n## npmpublish Type\n\n`boolean`\n\n---\n## npmunpublish Type\n\n`boolean`\n\n---\n## contents Type\n\n`object[]` ([Details](definition-defs-content.md))\n\n## contents Constraints\n\n**minimum number of items**: the minimum number of items for this array is: `3`\n"},{"id":"de9fefd043701d43","type":"JsonSchemaValidatorWithDocu","z":"d0506e991d512ace","g":"94fb93c898275493","name":"","property":"","propertyType":"msg","checkentireobject":true,"func":"{\n    \"title\": \"Check `msg` for NPM publish\",\n    \"type\": \"object\",\n    \"required\": [\n        \"npmotp\"\n    ],\n    \"properties\": {\n        \"npmotp\": {\n            \"type\": \"string\",\n            \"description\": \"One Time Password for NPM.\"\n        }\n    }\n}","schematitle":"Check `msg` for NPM publish","x":1637,"y":1713.8197021484375,"wires":[["fbe982a35d27d99b"]],"info":"## Check \\`msg\\` for NPM publish Type\n\n`object` ([Check \\`msg\\` for NPM publish](definition.md))\n\n# Check \\`msg\\` for NPM publish Properties\n\n| Property          | Type     | Required | Nullable       | Defined by                                                                                      |\n| :---------------- | :------- | :------- | :------------- | :---------------------------------------------------------------------------------------------- |\n| [npmotp](#npmotp) | `string` | Required | cannot be null | [Check \\`msg\\` for NPM publish](definition-properties-npmotp.md \"undefined#/properties/npmotp\") |\n\n## npmotp\n\nOne Time Password for NPM.\n\n`npmotp`\n\n*   is required\n\n*   Type: `string`\n\n*   cannot be null\n\n*   defined in: [Check \\`msg\\` for NPM publish](definition-properties-npmotp.md \"undefined#/properties/npmotp\")\n\n### npmotp Type\n\n`string`\n\n---\n## npmotp Type\n\n`string`\n"},{"id":"963dfb765b0d9849","type":"link in","z":"d0506e991d512ace","g":"aba9a5d741241f1c","name":"[nodedev-backend] entry point","links":["328f51ddaf7f2798","032b6dda18bca33c"],"x":1398.285888671875,"y":724.6216430664062,"wires":[["992dea9edfe05367"]]},{"id":"f8774c1c32f1631d","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"current repo revision (sha)","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - branch: branch name\n * \n * Return:\n *   - payload: current revision of repo\n * \n * Source:\n *   - https://docs.github.com/en/rest/branches/branches?apiVersion=2022-11-28#get-a-branch\n */\n\ntry {\n\n    octokit.request(\"GET /repos/:owner/:repo/branches/:branch\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        branch: msg.branch,\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.commit.sha})\n    }).catch(function (e) {\n        node.error(\"obtaining latest sha\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"request failure\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2311,"y":998.2106610466449,"wires":[["bb3ee2c3d46386a3"]]},{"id":"ef98698a4b696e66","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"create blob","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: base64 encoded content for blob\n * \n * Return:\n *   - payload: sha of newly created blob\n */\n\ntry {\n    \n    octokit.request(\"POST /repos/:owner/:repo/git/blobs\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        content: msg.payload,\n        encoding: \"base64\"\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.sha})\n    }).catch(function (e) {\n        node.error(\"creating blob\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2545,"y":646.866455078125,"wires":[["b522a5152706ad07"]]},{"id":"5226230f86c9c784","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"create tree for blobs","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: array of blobs, each blob is an object with:\n *         - path: filename of the blob in the repo, with path, i.e., dir1/dir2/filename.txt\n *         - sha: the sha of the blob created initially using the create blob function\n *   - parent_sha: the current sha of the repo, the return value of current repo revision\n * \n * Return:\n *   - payload: sha of newly created tree\n */\n\ntry {\n    var tree = msg.payload.map(function(blb){\n        return {\n            ...blb,\n            mode: \"100644\",\n            type: \"blob\"\n        }\n    });\n\n    octokit.request(\"POST /repos/:owner/:repo/git/trees\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        base_tree: msg.parent_sha,\n        tree: tree\n    }).then((resp) => {\n        node.send({ ...msg, payload: resp.data.sha })\n    }).catch(function (e) {\n        node.error(\"creating commit\", { ...msg, error: e })\n    });\n    \n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2575,"y":337.9554748535156,"wires":[["e68b9f9bac76350a"]]},{"id":"e68b9f9bac76350a","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"create commit","func":"try {\n    var octokit = new octokitRest.Octokit({\n        auth: process.env.GITHUB_TOKEN\n    });\n} catch (e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: the sha of the tree to commit\n *   - parent_sha: the current sha of the repo, the return value of current repo revision\n *   - author: an object with the following:\n *      - name: name of the author of the commit\n *      - email: email of the author of the commit\n *   - message: commit message\n * \n * Return:\n *   - payload: sha of newly commit\n * \n * Source:\n *   - https://docs.github.com/en/rest/git/commits?apiVersion=2022-11-28#create-a-commit\n */\n\ntry {\n    \n    octokit.request(\"POST /repos/:owner/:repo/git/commits\", {\n        owner: msg.owner,\n        repo: msg.repo,        \n        message: msg.message,\n        author: {\n            name: msg.author.name,\n            email: msg.author.email\n        },\n        parents: [\n            msg.parent_sha\n        ],\n        tree: msg.payload\n    }).then((resp) => {\n        node.send({ ...msg, payload: resp.data.sha })\n    }).catch(function (e) {\n        node.error(\"creating commit\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e })\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2555,"y":388.9777374267578,"wires":[["eea2441a833743f5"]]},{"id":"eea2441a833743f5","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"updating head on repo at branch - aka committing commit","func":"try {\n    var octokit = new octokitRest.Octokit({\n        auth: process.env.GITHUB_TOKEN\n    });\n} catch (e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - branch: github repo branch to update with the new commit sha\n *   - payload: the sha of the commit created\n * \n * Return:\n *   - payload: new sha of the branch\n * \n * Source:\n *   - https://docs.github.com/en/rest/git/refs?apiVersion=2022-11-28#update-a-reference\n */\n\ntry {\n    msg.new_commit_sha = msg.payload;\n\n    octokit.request(\"PATCH /repos/:owner/:repo/git/refs/heads/:branch\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        branch: msg.branch,\n        sha: msg.payload\n    }).then(function (resp) {\n        node.send({ \n            ...msg, \n            payload: resp.data.object.sha,\n        })\n    }).catch(function (e) {\n        node.error(\"committing commit\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e })\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2695,"y":440.35968017578125,"wires":[["42b6d95993c54b76"]]},{"id":"f7125db69297187e","type":"debug","z":"d0506e991d512ace","name":"github no changes","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":3087,"y":499,"wires":[]},{"id":"971ddff1a67a201f","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"get enitre tree for sha","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: sha of tree (i.e. directory)\n * \n * Return:\n *   - payload: tree of the sha, this will be an array with one entry per member of tree\n */\n\ntry {\n    \n    octokit.request(\"GET /repos/{owner}/{repo}/git/trees/{tree_sha}?recursive=true\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        tree_sha: msg.payload\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.tree})\n    }).catch(function (e) {\n         node.error(\"obtaining tree\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":2311,"y":881.2551700367644,"wires":[["732f4fa715c2fa78"]]},{"id":"732f4fa715c2fa78","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","rules":[{"t":"set","p":"current_shas","pt":"msg","to":"payload","tot":"msg","dc":true},{"t":"set","p":"payload","pt":"msg","to":"parent_sha","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2311,"y":822.7774245318242,"wires":[["b49254be1ffd7f40"]]},{"id":"255cf2c177f684a9","type":"function","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"check for changes","func":"var shaLookup = {};\n\nfor ( var idx = 0 ; idx < msg.current_shas.length ; idx++ ) {\n    shaLookup[msg.current_shas[idx].path] = msg.current_shas[idx].sha\n}\n\nmsg.changes = msg.payload.filter( (d) => {\n    return d.sha != shaLookup[d.path]\n})\n\nif ( msg.changes.length > 0 ) {\n    return [msg, undefined];\n} else {\n    msg.payload = \"github: no changes\"\n    return [undefined, msg];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2311,"y":492.4331970214844,"wires":[["79b43c9ce292f151"],["f7125db69297187e"]],"outputLabels":["sha differ","no change"]},{"id":"79b43c9ce292f151","type":"switch","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"gitcheckforchange","property":"gitcheckforchange","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2327,"y":300,"wires":[["0cb6ad0a57a95eee"],["5226230f86c9c784"]]},{"id":"0cb6ad0a57a95eee","type":"change","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"changes","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2555,"y":294,"wires":[["3ca095a5abd3abf2"]]},{"id":"3ca095a5abd3abf2","type":"debug","z":"d0506e991d512ace","name":"github changes","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3077,"y":294,"wires":[]},{"id":"bfe2775a7cf26d83","type":"switch","z":"d0506e991d512ace","g":"5d202e6481e451cb","name":"gitcheckforchange","property":"gitcheckforchange","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":2245,"y":1236,"wires":[["29ed87438e7e6749"],["8b5643cf5e2dccc4"]]},{"id":"d485bbfece99d118","type":"switch","z":"d0506e991d512ace","name":"\"ignore package check\" check","property":"ignore_package_check","propertyType":"msg","rules":[{"t":"true"},{"t":"false"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":1061,"y":1166,"wires":[["893f316ea815e2b1"],["2a7132258cbcf313"],["2a7132258cbcf313"]]}]