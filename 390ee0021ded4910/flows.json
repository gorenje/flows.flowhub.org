[{"id":"390ee0021ded4910","type":"tab","label":"GitHub functionality","disabled":false,"info":"","env":[]},{"id":"9ad713be26ac2025","type":"function","z":"390ee0021ded4910","name":"get tree for sha","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: sha of tree (i.e. directory)\n * \n * Return:\n *   - payload: tree of the sha, this will be an array with one entry per member of tree\n */\n\ntry {\n    \n    octokit.request(\"GET /repos/{owner}/{repo}/git/trees/{tree_sha}\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        tree_sha: msg.payload\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.tree})\n    }).catch(function (e) {\n         node.error(\"obtaining tree\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":682,"y":593,"wires":[["30c0f36427ec6c9d"]]},{"id":"774f89a0fcfe6965","type":"comment","z":"390ee0021ded4910","name":"Requires @octokit/rest npm package & process.env.GITHUB_TOKEN","info":"A series of GitHub functions for handling a github repo via API. The intention is to commit content to a github repo without have a local copy of it. \n\nThis is designed to work on a server without any storage.\n\nTaken from this stackoverflow answer:\n\nhttps://stackoverflow.com/questions/11801983/how-to-create-a-commit-and-push-into-repo-with-github-api-v3\n\nGitHub API documentation: https://docs.github.com/en/rest/git/trees?apiVersion=2022-11-28\n\n---\n\nEnvironment variable GITHUB_TOKEN:\n\nThe github token is a classic personal token, the new fine-grain token doesn't work with @octokit.\n\nAll the permissions needed on the token is \"repo\" (with all sub-options).\n\nFound here: https://github.com/settings/tokens --> classic token!!!\n\n---\n\nUpdate package.json to include \"@octokit/rest\": \"latest\" **HOWEVER** this will require NodeJS >=18 which the docker image of the Node-RED 3.0.2 **DOES NOT HAVE**, it still uses NodeJS 16 --> this means: don't try this with the current 3.0.2 docker image, it will only fail.","x":752,"y":95,"wires":[]},{"id":"f8774c1c32f1631d","type":"function","z":"390ee0021ded4910","name":"current repo revision (sha)","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - branch: branch name\n * \n * Return:\n *   - payload: current revision of repo\n * \n * Source: ???\n */\n\ntry {\n\n    octokit.request(\"GET /repos/:owner/:repo/branches/:branch\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        branch: msg.branch,\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.commit.sha})\n    }).catch(function (e) {\n        node.error(\"obtaining latest sha\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"request failure\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":712,"y":308,"wires":[["30c0f36427ec6c9d"]]},{"id":"c90bd91e45e1ac7e","type":"link in","z":"390ee0021ded4910","name":"[github] current repo version","links":[],"x":480,"y":213.99996337890627,"wires":[["f8774c1c32f1631d"]]},{"id":"30c0f36427ec6c9d","type":"link out","z":"390ee0021ded4910","name":"link out 91","mode":"return","links":[],"x":1114,"y":880,"wires":[]},{"id":"43d3a872c31bb664","type":"link in","z":"390ee0021ded4910","name":"[github] get tree for sha","links":[],"x":480,"y":593.7142490931919,"wires":[["9ad713be26ac2025"]]},{"id":"ef98698a4b696e66","type":"function","z":"390ee0021ded4910","name":"create blob","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: base64 encoded content for blob\n * \n * Return:\n *   - payload: sha of newly created blob\n */\n\ntry {\n\n    octokit.request(\"POST /repos/:owner/:repo/git/blobs\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        content: msg.payload,\n        encoding: \"base64\"\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data.sha})\n    }).catch(function (e) {\n        node.error(\"creating blob\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":672,"y":688,"wires":[["30c0f36427ec6c9d"]]},{"id":"5226230f86c9c784","type":"function","z":"390ee0021ded4910","name":"create tree for blobs","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: array of blobs, each blob is an object with:\n *         - path: filename of the blob in the repo, with path, i.e., dir1/dir2/filename.txt\n *         - sha: the sha of the blob created initially using the create blob function\n *   - parent_sha: the current sha of the repo, the return value of current repo revision\n * \n * Return:\n *   - payload: sha of newly created tree\n */\n\ntry {\n    var tree = msg.payload.map(function(blb){\n        return {\n            ...blb,\n            mode: \"100644\",\n            type: \"blob\"\n        }\n    });\n\n    octokit.request(\"POST /repos/:owner/:repo/git/trees\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        base_tree: msg.parent_sha,\n        tree: tree\n    }).then((resp) => {\n        node.send({ ...msg, payload: resp.data.sha })\n    }).catch(function (e) {\n        node.error(\"creating commit\", { ...msg, error: e })\n    });\n    \n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":702,"y":783,"wires":[["30c0f36427ec6c9d"]]},{"id":"e68b9f9bac76350a","type":"function","z":"390ee0021ded4910","name":"create commit","func":"try {\n    var octokit = new octokitRest.Octokit({\n        auth: process.env.GITHUB_TOKEN\n    });\n} catch (e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: the sha of the tree to commit\n *   - parent_sha: the current sha of the repo, the return value of current repo revision\n *   - author: an object with the following:\n *      - name: name of the author of the commit\n *      - email: email of the author of the commit\n *   - message: commit message\n * \n * Return:\n *   - payload: sha of newly commit\n */\n\ntry {\n    \n    octokit.request(\"POST /repos/:owner/:repo/git/commits\", {\n        owner: msg.owner,\n        repo: msg.repo,        \n        message: msg.message,\n        author: {\n            name: msg.author.name,\n            email: msg.author.email\n        },\n        parents: [\n            msg.parent_sha\n        ],\n        tree: msg.payload\n    }).then((resp) => {\n        node.send({ ...msg, payload: resp.data.sha })\n    }).catch(function (e) {\n        node.error(\"creating commit\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e })\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":682,"y":878,"wires":[["30c0f36427ec6c9d"]]},{"id":"df3c4b14324197c4","type":"function","z":"390ee0021ded4910","name":"updating head on repo at branch - aka committing commit","func":"try {\n    var octokit = new octokitRest.Octokit({\n        auth: process.env.GITHUB_TOKEN\n    });\n} catch (e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - branch: github repo branch to update with the new commit sha\n *   - payload: the sha of the commit created\n * \n * Return:\n *   - payload: new sha of the branch\n */\n\ntry {\n\n    octokit.request(\"PATCH /repos/:owner/:repo/git/refs/heads/:branch\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        branch: msg.branch,\n        sha: msg.payload\n    }).then(function (resp) {\n        node.send({ \n            ...msg, \n            payload: resp.data.sha\n        })\n    }).catch(function (e) {\n        node.error(\"committing commit\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"something went wrong\", { ...msg, error: e })\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":822,"y":973,"wires":[["30c0f36427ec6c9d"]]},{"id":"08d2d7135f31a878","type":"link in","z":"390ee0021ded4910","name":"[github] create blobs","links":[],"x":480,"y":720.2856776646205,"wires":[["ef98698a4b696e66"]]},{"id":"78d886e3f8af26b7","type":"link in","z":"390ee0021ded4910","name":"[github] create tree from blobs","links":[],"x":480,"y":846.857106236049,"wires":[["5226230f86c9c784"]]},{"id":"ab95f13fbc3a2d5b","type":"link in","z":"390ee0021ded4910","name":"[github] create commit","links":[],"x":480,"y":973.4285348074776,"wires":[["e68b9f9bac76350a"]]},{"id":"2df1a9a310e8a9fd","type":"link in","z":"390ee0021ded4910","name":"[github] update branch head","links":[],"x":480,"y":1099.9999633789062,"wires":[["df3c4b14324197c4"]]},{"id":"2b9bbf6e57664c43","type":"function","z":"390ee0021ded4910","name":"get commits for sha","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: sha for which the commits are desired\n * \n * Return:\n *   - payload: commits for sha\n * \n * Source: https://docs.github.com/en/rest/git/commits?apiVersion=2022-11-28#get-a-commit-object\n */\n\ntry {\n\n    octokit.request(\"GET /repos/:owner/:repo/git/commits/:sha\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        sha: msg.payload,\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data })\n    }).catch(function (e) {\n        node.error(\"obtaining commits\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"request failure\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":702,"y":403,"wires":[["30c0f36427ec6c9d"]]},{"id":"dbdea53966e72031","type":"link in","z":"390ee0021ded4910","name":"[github] get commits for sha","links":[],"x":480,"y":340.5713919503348,"wires":[["2b9bbf6e57664c43"]]},{"id":"c938363b5f63d0b7","type":"function","z":"390ee0021ded4910","name":"get blob for sha","func":"try {\n    var octokit = new octokitRest.Octokit({ \n        auth: process.env.GITHUB_TOKEN \n    });\n} catch(e) {\n    node.error(\"init octokit\", {\n        ...msg,\n        error: e\n    })\n    return undefined;\n}\n\n/**\n * Msg attributes:\n *   - owner: github repo owner\n *   - repo: github repo name\n *   - payload: file sha for which the contents are desired\n * \n * Return:\n *   - payload: base64 contents in a hash object\n * \n *  Source: https://docs.github.com/en/rest/git/blobs?apiVersion=2022-11-28#get-a-blob\n */\n\ntry {\n\n    octokit.request(\"GET /repos/:owner/:repo/git/blobs/:sha\", {\n        owner: msg.owner,\n        repo: msg.repo,\n        sha: msg.payload,\n    }).then( (resp) => {\n        node.send({ ...msg, payload: resp.data })\n    }).catch(function (e) {\n        node.error(\"obtaining blob\", { ...msg, error: e })\n    });\n\n} catch (e) {\n    node.error(\"request failure\", { ...msg, error: e})\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"octokitRest","module":"@octokit/rest"},{"var":"process","module":"process"}],"x":682,"y":498,"wires":[["30c0f36427ec6c9d"]]},{"id":"937f9c72251daebf","type":"link in","z":"390ee0021ded4910","name":"[github] get blob for sha","links":[],"x":480,"y":467.1428205217634,"wires":[["c938363b5f63d0b7"]]}]