[{"id":"600b912208e31e75","type":"tab","label":"[DP] Timeouts for long running process","disabled":false,"info":"::: aim\n\nTo demonstrate how to construct a simple timeout for long running tasks.\n\n:::\n\n::: background\n\nSometimes process take longer than planned but the system should not wait for the completion of those process.\n\nNode-RED being an event-driven framework, this should not really happen. Instead events should be handled when they happen, so long-running processes will eventually complete and then their results should be handled.\n\nThis flow goes against this approach and demonstrates how to set a maximum response time.\n\nGenerally there is no reason to wait in Node-RED since flows should be stateless and event-driven.\n\nAs such, this is a *dark pattern* and not a *design pattern*, avoid doing this since it spins out processes that run in the background but are not checked, they become hidden/zombie processes.\n \n:::\n\n::: explanation\n\nThis flow takes advantage of the split/join combination. A split node generates multiple messages by creating one message per entry in an array (for example). The join node waits until all those messages have arrived back at the join.\n\nAs such, split/join can be used to execute tasks concurrently and this is what is happening here.\n\nTBC.\n\n:::\n\n","env":[]},{"id":"8151cad5341df37e","type":"group","z":"600b912208e31e75","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["e86e3d17fc79dc72"],"x":31,"y":390,"w":212,"h":82},{"id":"983a06a0169c2973","type":"group","z":"600b912208e31e75","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["dc0b981fe0a86b6c","10995cfadd9e95b2"],"x":311,"y":348,"w":352,"h":166},{"id":"c679994c85dd5d5a","type":"group","z":"600b912208e31e75","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["5c1bcfc4fb14667d","2ce5e55ace0aecfd","94d2412db2d8964c","84ef5eec431cd5d4"],"x":1725,"y":348,"w":326,"h":261},{"id":"29ee166c08753224","type":"group","z":"600b912208e31e75","name":"long running process","style":{"label":true},"nodes":["d3768515de1c4172","144a420aea844c28","c2f78e46c7750586","b5537379a9d2c08b"],"x":1054,"y":527,"w":631,"h":82},{"id":"1d75c8d1a6c5e8f1","type":"group","z":"600b912208e31e75","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["248d6af6058e9716","75d449cd67f2882b","09140625d19de12b","5b7b9f8b8351c926","fb77719bf7656475","13574775c7a12e5a"],"x":705,"y":348,"w":980,"h":142},{"id":"e86e3d17fc79dc72","type":"inject","z":"600b912208e31e75","g":"8151cad5341df37e","name":"set reqCount","props":[{"p":"reqCount","v":"3","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":147,"y":431,"wires":[["10995cfadd9e95b2"]]},{"id":"dc0b981fe0a86b6c","type":"function","z":"600b912208e31e75","g":"983a06a0169c2973","name":"create reqCount number of messages","func":"msg.payload = [];\n\nfor ( var idx = 0 ; idx < msg.reqCount; idx++ ) {\n    msg.payload.push({\n        ...msg\n    })\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":487,"y":473,"wires":[["248d6af6058e9716"]]},{"id":"248d6af6058e9716","type":"split","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":781,"y":448,"wires":[["5b7b9f8b8351c926"]]},{"id":"75d449cd67f2882b","type":"join","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1609,"y":449,"wires":[["5c1bcfc4fb14667d"]]},{"id":"09140625d19de12b","type":"delay","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"delay 3seconds","pauseType":"delay","timeout":"3000","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1166,"y":389,"wires":[["fb77719bf7656475"]]},{"id":"5b7b9f8b8351c926","type":"function","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"ready, set, go","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":956,"y":448,"wires":[["09140625d19de12b","13574775c7a12e5a"]]},{"id":"fb77719bf7656475","type":"change","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"set msg.statusCode","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"TIMEDOUT","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1400,"y":389,"wires":[["75d449cd67f2882b"]]},{"id":"5c1bcfc4fb14667d","type":"join","z":"600b912208e31e75","g":"c679994c85dd5d5a","name":"wait for 2 messages","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"0.5","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1851,"y":389,"wires":[["84ef5eec431cd5d4"]]},{"id":"2ce5e55ace0aecfd","type":"change","z":"600b912208e31e75","g":"c679994c85dd5d5a","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0].payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1945,"y":568,"wires":[["d59af09e90b30aed"]]},{"id":"10995cfadd9e95b2","type":"change","z":"600b912208e31e75","g":"983a06a0169c2973","name":"set flow.packetcount","rules":[{"t":"set","p":"packetcount","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":389,"wires":[["dc0b981fe0a86b6c"]]},{"id":"94d2412db2d8964c","type":"switch","z":"600b912208e31e75","g":"c679994c85dd5d5a","name":"if packetcount == 1","property":"packetcount","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1911,"y":509,"wires":[["2ce5e55ace0aecfd"]]},{"id":"84ef5eec431cd5d4","type":"function","z":"600b912208e31e75","g":"c679994c85dd5d5a","name":"update flow.packetcount","func":"flow.set(\"packetcount\", parseInt(flow.get(\"packetcount\")) + 1 );\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1896,"y":452,"wires":[["94d2412db2d8964c"]]},{"id":"d3768515de1c4172","type":"link out","z":"600b912208e31e75","g":"29ee166c08753224","name":"link out 110","mode":"return","links":[],"x":1644,"y":568,"wires":[]},{"id":"144a420aea844c28","type":"link in","z":"600b912208e31e75","g":"29ee166c08753224","name":"long running process","links":[],"x":1095,"y":568,"wires":[["c2f78e46c7750586"]]},{"id":"13574775c7a12e5a","type":"link call","z":"600b912208e31e75","g":"1d75c8d1a6c5e8f1","name":"long running process","links":["144a420aea844c28"],"linkType":"static","timeout":"30","x":1273,"y":448,"wires":[["75d449cd67f2882b"]]},{"id":"c2f78e46c7750586","type":"delay","z":"600b912208e31e75","g":"29ee166c08753224","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1236.3333333333335,"y":568,"wires":[["b5537379a9d2c08b"]]},{"id":"d59af09e90b30aed","type":"debug","z":"600b912208e31e75","name":"debug 42","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2202,"y":464,"wires":[]},{"id":"b5537379a9d2c08b","type":"change","z":"600b912208e31e75","g":"29ee166c08753224","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"OK","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1462.6666666666667,"y":568,"wires":[["d3768515de1c4172"]]}]