[{"id":"119a019d22344192","type":"tab","label":"HN Rss + Frontend code","disabled":false,"info":"::: aim\n\nProviding a ever updating visual representation of Hacker News content.\n\n:::\n\n::: requirements\n\nThis requirements the following Node-RED nodes:\n\n- [introspection](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-introspection), version >= 0.4.0\n\n:::\n\n::: background\n\nThis is misusing the Node-RED client to create nodes that represent RSS feed items. It also wires together related nodes, in this case comments on Hacker News articles.\n\n:::\n\n### Related Flows\n\n- [Result of letting this flow run](https://flowhub.org/f/1b2cdc85fc889cd0)\n\n","env":[]},{"id":"14b07e82a651e858","type":"junction","z":"119a019d22344192","x":379.2857052087784,"y":712.8690819740295,"wires":[["1827e471f8ae10be","6bdeb72861bdc2ae","eee7edeff8563c8e"]]},{"id":"2bd777ecf6a3b9aa","type":"junction","z":"119a019d22344192","x":322.44607388973236,"y":203,"wires":[["14b07e82a651e858"]]},{"id":"a24b42e10f2bc804","type":"http request","z":"119a019d22344192","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1353.6665840148926,"y":592.6784076690674,"wires":[["18d94b608916caa0"]]},{"id":"18d94b608916caa0","type":"xml","z":"119a019d22344192","name":"","property":"payload","attr":"","chr":"","x":1355.75,"y":487.84509086608887,"wires":[["c11eda51de3f3c1f"]]},{"id":"9e3841e73885b3dd","type":"join","z":"119a019d22344192","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2462,"y":492.59503173828125,"wires":[["875ef0b0799bb044"]]},{"id":"c11eda51de3f3c1f","type":"function","z":"119a019d22344192","name":"define subflow","func":"msg.tab_id_z = RED.util.generateId();\n\nvar subflowId = RED.util.generateId();\n\nvar getName = () => {\n    var pl = msg.payload;\n    /* \n     * This supports the title being (in that order):\n     *    - payload.rss.channel[0].title[0]\n     *    - payload.feed.title[0]._ \n     *    - payload.feed.title[0]\n     */\n    return ( \n        (pl && pl.rss && pl.rss.channel && pl.rss.channel[0] && pl.rss.channel[0].title && pl.rss.channel[0].title[0]) ||\n        (pl && pl.feed && pl.feed.title && pl.feed.title[0] && (pl.feed.title[0]._ || pl.feed.title[0]) ) ||\n        \"Unk: \" + subflowId\n    )\n};\n\nvar subflowDefined = flow.get(msg.node_colour.substr(1,12));\n\nif (subflowDefined) {\n\n    msg.subflow_defined = true;\n    msg.subflow_type = subflowDefined;\n\n} else {\n\n    msg.subflow_type = {\n        \"id\": subflowId,\n        \"type\": \"subflow\",\n        \"name\": getName(),\n        \"info\": \"Imported at \" + new Date() + \"\\n<hr>\\n\" + msg.url + \"\\n\",\n        \"category\": \"rssfeeds\",\n        \"icon\": msg.icon || \"font-awesome/fa-feed\",\n\n        \"in\": [\n            {\n                \"x\": 201.25,\n                \"y\": 188.75,\n                \"wires\": []\n            }\n        ],\n\n        \"out\": [\n            {\n                \"x\": 496.25,\n                \"y\": 161.25,\n                \"wires\": [\n                    {\n                        \"id\": subflowId,\n                        \"port\": 0\n                    }\n                ]\n            }\n        ],\n\n        \"env\": [\n            {\n                \"name\": \"createdAt\",\n                \"type\": \"str\",\n                \"value\": \"\"\n            },\n            {\n                \"name\": \"updatedAt\",\n                \"type\": \"str\",\n                \"value\": \"\"\n            }\n        ],\n\n        \"meta\": {},\n        \"color\": msg.node_colour,\n    };\n\n    msg.subflow_defined = false;\n    flow.set(msg.node_colour.substr(1, 12), { ...msg.subflow_type })\n    \n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1374.0832061767578,"y":380.1546821594238,"wires":[["2add974310f6f3b1"]]},{"id":"875ef0b0799bb044","type":"function","z":"119a019d22344192","name":"prepend the subflow to the nodes array","func":"if (!msg.subflow_defined) {\n    msg.payload = [\n        msg.subflow_type,\n        ...msg.payload    \n    ];\n}\nmsg.payload = {\n    flowContent: msg.payload,\n    removeduplicates: true,\n    autoimport: true\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2415.25,"y":617.79150390625,"wires":[["5bf2de0885c59307"]]},{"id":"2add974310f6f3b1","type":"switch","z":"119a019d22344192","name":"format type decider","property":"formatType","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1393.75,"y":315.9879150390625,"wires":[["182961ab0bc4acb1"],["1c4538eccf58e703"]]},{"id":"182961ab0bc4acb1","type":"change","z":"119a019d22344192","name":"payload.rss.channel[0].item","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.rss.channel[0].item","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1723,"y":310.4075927734375,"wires":[["9db21ab092193273"]]},{"id":"9db21ab092193273","type":"split","z":"119a019d22344192","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1901.5625,"y":441.0259704589844,"wires":[["52fc4e7061589c27"]]},{"id":"1c4538eccf58e703","type":"change","z":"119a019d22344192","name":"payload.rss.channel[0].item","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.rss.channel[0].item","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1731,"y":363.023681640625,"wires":[["1b5507363bd05954"]]},{"id":"1b5507363bd05954","type":"split","z":"119a019d22344192","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1922.5625,"y":409.0259704589844,"wires":[["d4c4c49541626eb2"]]},{"id":"52fc4e7061589c27","type":"function","z":"119a019d22344192","name":"2. guid[0]._, title, description, pubDate","func":"// some GUIDs are in fact IDs so prepend the URL when generating the ID\nmsg.payload = {\n    \"id\": xxhashjs.h64(msg.url + msg.payload.guid[0]._, 0xbad0feed).toString(16),\n    \"type\": \"subflow:\" + msg.subflow_type.id,\n    \"z\": msg.tab_id_z,\n    \"name\": msg.payload.title[0].trim(),\n    \"info\": msg.payload.description[0].trim(),\n    \"env\": [\n        {\n            \"name\": \"createdAt\",\n            \"value\": msg.payload.pubDate[0],\n            \"type\": \"str\"\n        },\n        {\n            \"name\": \"updatedAt\",\n            \"value\": msg.payload.pubDate[0],\n            \"type\": \"str\"\n        }\n    ],\n    \"createdAt\": msg.payload.pubDate[0],\n    \"updatedAt\": msg.payload.pubDate[0],\n    \"x\": 2000 * Math.random(),\n    \"y\": 2000 * Math.random(),\n    \"wires\": [\n        []\n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"xxhashjs","module":"xxhashjs"}],"x":2139.5,"y":489.4075927734375,"wires":[["9e3841e73885b3dd"]]},{"id":"d4c4c49541626eb2","type":"function","z":"119a019d22344192","name":"3. guid[0]._, title, link, description & pubDate","func":"// some GUIDs are in fact IDs so prepend the URL when generating the ID\nmsg.payload = {\n    \"id\": xxhashjs.h64(msg.url + msg.payload.guid[0]._, 0xbad0feed).toString(16),\n    \"type\": \"subflow:\" + msg.subflow_type.id,\n    \"z\": msg.tab_id_z,\n    \"name\": msg.payload.title[0].trim(),\n    \"info\": msg.payload.link[0] + \"\\n<hr>\\n\" + msg.payload.description[0].trim(),\n    \"env\": [\n        {\n            \"name\": \"createdAt\",\n            \"value\": msg.payload.pubDate[0],\n            \"type\": \"str\"\n        },\n        {\n            \"name\": \"updatedAt\",\n            \"value\": msg.payload.pubDate[0],\n            \"type\": \"str\"\n        }\n    ],\n    \"createdAt\": msg.payload.pubDate[0],\n    \"updatedAt\": msg.payload.pubDate[0],\n    \"x\": 2000 * Math.random(),\n    \"y\": 2000 * Math.random(),\n    \"wires\": [\n        []\n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"xxhashjs","module":"xxhashjs"}],"x":2183.5,"y":436.023681640625,"wires":[["9e3841e73885b3dd"]]},{"id":"0fc4a6df8134452b","type":"change","z":"119a019d22344192","name":"HN frontpage","rules":[{"t":"set","p":"url","pt":"msg","to":"https://hnrss.org/frontpage","tot":"str"},{"t":"set","p":"node_colour","pt":"msg","to":"#e5b67b","tot":"str"},{"t":"set","p":"formatType","pt":"msg","to":"2","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":967,"y":427.488037109375,"wires":[["a24b42e10f2bc804"]]},{"id":"49500a324e280110","type":"change","z":"119a019d22344192","name":"HN newest submissions","rules":[{"t":"set","p":"url","pt":"msg","to":"https://hnrss.org/newest","tot":"str"},{"t":"set","p":"node_colour","pt":"msg","to":"#ebc883","tot":"str"},{"t":"set","p":"formatType","pt":"msg","to":"2","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":997,"y":390.738037109375,"wires":[["a24b42e10f2bc804"]]},{"id":"cdf472c4f75f375c","type":"change","z":"119a019d22344192","name":"hacker news new comments","rules":[{"t":"set","p":"url","pt":"msg","to":"https://hnrss.org/newcomments","tot":"str"},{"t":"set","p":"node_colour","pt":"msg","to":"#f0da8c","tot":"str"},{"t":"set","p":"formatType","pt":"msg","to":"3","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1007,"y":353.988037109375,"wires":[["a24b42e10f2bc804"]]},{"id":"426636c22cb537e5","type":"inject","z":"119a019d22344192","d":true,"name":"time giver - tick every 135secs","props":[],"repeat":"135","crontab":"","once":true,"onceDelay":"3","topic":"","x":135,"y":290,"wires":[["2bd777ecf6a3b9aa"]]},{"id":"1827e471f8ae10be","type":"delay","z":"119a019d22344192","name":"","pauseType":"delay","timeout":"7","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":759,"y":353.988037109375,"wires":[["cdf472c4f75f375c"]]},{"id":"6bdeb72861bdc2ae","type":"delay","z":"119a019d22344192","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":759,"y":390.738037109375,"wires":[["49500a324e280110"]]},{"id":"eee7edeff8563c8e","type":"delay","z":"119a019d22344192","name":"","pauseType":"delay","timeout":"13","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":759,"y":427.488037109375,"wires":[["0fc4a6df8134452b"]]},{"id":"d18f79a06689f21d","type":"inject","z":"119a019d22344192","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":475,"y":243.15478515625,"wires":[["cdf472c4f75f375c"]]},{"id":"e7fafd515c93d378","type":"inject","z":"119a019d22344192","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":467,"y":298.15478515625,"wires":[["49500a324e280110"]]},{"id":"7f326babdf2cd3b3","type":"inject","z":"119a019d22344192","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":466,"y":354.15478515625,"wires":[["0fc4a6df8134452b"]]},{"id":"8096598130f92348","type":"ClientCode","z":"119a019d22344192","name":"connect nodes for HN ","clientcode":"var namesToId = {}\n\nRED.nodes.eachNode((n) => {\n  if (n._def.category == \"rssfeeds\") {\n    namesToId[n.name] = n.id\n  }\n})\n\nRED.nodes.eachNode((n) => {\n  if (n._def.category == \"rssfeeds\" && n._def.label() == \"Hacker News: New Comments\") {\n    var title = n.name.match(/^New[ ]+comment[ ]+by.+\\\"(.*)\\\"/)[1];\n    var tgtId = namesToId[title];\n    if (tgtId) {\n      var t = RED.nodes.node(tgtId);\n      RED.nodes.addLink({ source: n, sourcePort: 0, target: t });\n      RED.view.select([t, n]);\n      console.log( \"create link\")\n    }\n  }\n})\n\nconsole.log( namesToId )","format":"javascript","x":3060.9998321533203,"y":795.9999198913574,"wires":[["dcf846bebaa1cc02"]]},{"id":"67e712983527903f","type":"inject","z":"119a019d22344192","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2024.9998893737793,"y":658.0000400543213,"wires":[["8096598130f92348"]]},{"id":"dcf846bebaa1cc02","type":"debug","z":"119a019d22344192","name":"debug 21","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3311.66650390625,"y":794.9999408721924,"wires":[]},{"id":"5bf2de0885c59307","type":"ClientCode","z":"119a019d22344192","name":"TriggerImport","clientcode":"function doIt() {\n  var content = payload.flowContent;\n\n  if (payload.removeduplicates) {\n    content = content.filter((elem) => {\n      return RED.nodes.node(elem.id) == undefined\n    });\n  }\n\n  if (content.length == 0) {\n    RED.notify(\"No new content\", {\n      type: \"ok\",\n      id: \"TriggerImport\",\n      timeout: 2000\n    });\n    return;\n  }\n  RED.clipboard.import();\n\n  setTimeout(() => {\n    $('#red-ui-clipboard-dialog-import-text').val(\n      JSON.stringify(content)\n    ).trigger(\"paste\");\n\n    if (payload.autoimport) {\n      setTimeout(() => {\n        $('#red-ui-clipboard-dialog-ok').trigger('click');\n      }, 435);\n    }\n  }, 300);\n};\n\ndoIt();\n","format":"javascript","x":2884,"y":620,"wires":[["94491cca3fb551c3"]]},{"id":"cb8915b3999f4b65","type":"ClientCode","z":"119a019d22344192","name":"delete older nodes","clientcode":"RED.view.select(false)\n\n// close any dialog that explains that there are duplicates and therefore\n// only a copy can be imported, hit the cancel button on that one.\n// Five clicks should do the job ...\nfor (var idx = 0; idx < 5; idx++) {\n  $($('.ui-dialog-buttonset').find(\"button\")[0]).trigger('click')\n}\n\nvar allSelectNodes = [];\n\nRED.nodes.eachNode(function (e) {\n  if (e._def && e.env && e.env[1] &&\n    e._def.category == data.payload.category &&\n    (Date.parse(e.env[1].value) <\n      (new Date().getTime() - parseInt(data.payload.old_than_ms)))) {\n    allSelectNodes.push(e)\n  }\n});\n\nRED.view.select({ nodes: allSelectNodes })\nsetTimeout(() => {\n  RED.actions.invoke(\"core:delete-selection\")\n}, 1500);\n","format":"javascript","x":2890,"y":275,"wires":[[]]},{"id":"f0ddfaa9d95b07f7","type":"change","z":"119a019d22344192","name":"delete old items - 3 hours","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"category\": \"rssfeeds\",\t   \"old_than_ms\": 1000 * 60 * 180\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2582,"y":206,"wires":[["cb8915b3999f4b65"]]},{"id":"8c6127fdaa8da4a1","type":"inject","z":"119a019d22344192","d":true,"name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2318,"y":301,"wires":[["f0ddfaa9d95b07f7"]]},{"id":"94491cca3fb551c3","type":"delay","z":"119a019d22344192","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2976.66650390625,"y":708.3333129882812,"wires":[["8096598130f92348"]]}]