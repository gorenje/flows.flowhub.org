[{"id":"4a831589774ecb04","type":"tab","label":"[NodeDev] FlowHub","disabled":false,"info":"::: aim\n\nThis flow maintains the [flowhub](https://www.npmjs.com/package/@gregoriusrippenstein/node-red-contrib-flowhub) node package.\n\n:::\n\n::: requirements\n\n- [nodedev](https://www.npmjs.com/package/@gregoriusrippenstein/node-red-contrib-nodedev) nodes are used to maintain the codebase.\n- [nodedev backend flow](https://flowhub.org/f/d0506e991d512ace) for GitHub & NPM interaction.\n\n:::\n\n::: background\n\nFlowHub nodes provide access to the flows hosted at [FlowHub](https://flowhub.org).\n\n:::\n\n::: artifacts\n\n- [NPMjs Package](https://www.npmjs.com/package/@gregoriusrippenstein/node-red-contrib-flowhub)\n- [Node-RED node package](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-introspection)\n- [GitHub Repo](https://github.com/gorenje/node-red-contrib-flowhub)\n\n:::\n\n### Related Flows\n\n- [Nodedev package development](https://flowhub.org/f/b92be5062203ff69)\n\n","env":[]},{"id":"70768ce6a60d1f48","type":"group","z":"4a831589774ecb04","name":"command central","style":{"fill":"#addb7b","label":true},"nodes":["e898753723c6e7f6"],"x":100,"y":191,"w":352,"h":82},{"id":"8fad363a81b00dc0","type":"group","z":"4a831589774ecb04","name":"randomise package name for quicker local development","style":{"label":true},"nodes":["f021f51e1dc26ca4","8b807d805f236fb0","fb100c6d77a192dc"],"x":943.0000534057617,"y":188,"w":706.9999465942383,"h":126},{"id":"1367cf52ca2c762b","type":"group","z":"4a831589774ecb04","name":"Required supportive flows - ensure they are installed","style":{"label":true},"nodes":["1c18482b21bc473a"],"x":100,"y":323,"w":472,"h":82},{"id":"e898753723c6e7f6","type":"inject","z":"4a831589774ecb04","g":"70768ce6a60d1f48","name":"set package details and actions here","props":[{"p":"pname","v":"@gregoriusrippenstein/node-red-contrib-flowhub","vt":"str"},{"p":"pversion","v":"0.1.9","vt":"str"},{"p":"noderedinstall","v":"true","vt":"bool"},{"p":"gitcommit","v":"false","vt":"bool"},{"p":"npmpublish","v":"true","vt":"bool"},{"p":"npmunpublish","v":"false","vt":"bool"},{"p":"randompackagename","v":"false","vt":"bool"},{"p":"commit_message","v":"version bump to 0.1.9","vt":"str"},{"p":"npmotp","v":"111999","vt":"str"},{"p":"githubowner","v":"gorenje","vt":"str"},{"p":"githubrepo","v":"node-red-contrib-flowhub","vt":"str"},{"p":"githubbranch","v":"main","vt":"str"},{"p":"githubauthor","v":"Gerrit Riessen","vt":"str"},{"p":"githubauthoremail","v":"gerrit@openmindmap.org","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":286,"y":232,"wires":[["8b807d805f236fb0"]]},{"id":"f021f51e1dc26ca4","type":"change","z":"4a831589774ecb04","g":"8fad363a81b00dc0","name":"","rules":[{"t":"set","p":"pname","pt":"msg","to":"$$.pname & $substring(\"\"&$random(),2)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1544,"y":273,"wires":[["4544902f3075219a"]]},{"id":"8b807d805f236fb0","type":"switch","z":"4a831589774ecb04","g":"8fad363a81b00dc0","name":"randompackagename","property":"randompackagename","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"false","repair":false,"outputs":2,"x":1069.0000534057617,"y":229,"wires":[["fb100c6d77a192dc"],["4544902f3075219a"]]},{"id":"fb100c6d77a192dc","type":"switch","z":"4a831589774ecb04","g":"8fad363a81b00dc0","name":"noderedinstall","property":"noderedinstall","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"false","repair":false,"outputs":2,"x":1316,"y":246.99993896484375,"wires":[["f021f51e1dc26ca4"],["4544902f3075219a"]]},{"id":"328f51ddaf7f2798","type":"link out","z":"4a831589774ecb04","name":"link out 116","mode":"link","links":["963dfb765b0d9849"],"x":1782,"y":988,"wires":[]},{"id":"4544902f3075219a","type":"PkgFile","z":"4a831589774ecb04","name":".gitkeep","filename":"nodes/lib/.gitkeep","format":"text","syntax":"mustache","template":"/* empty */\n","output":"str","x":1470,"y":513,"wires":[["77b94e7d86cd0150"]]},{"id":"77b94e7d86cd0150","type":"PkgFile","z":"4a831589774ecb04","name":"LICENSE","filename":"LICENSE","format":"markdown","syntax":"mustache","template":"## LICENSE\n\nAdapted from JSON.org, http://www.json.org/license.html\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nThe Software shall be used for Good, not Evil.\n\nRemember the curse of the evil-doer upon whose blood the devil does drink and upon whose flesh the devil does feast. For eternity will the evil-doer bear this Sisyphean burden, only to be relieved of their suffering upon the apocalyptic end of it all including the foundations of the internet, computers, technology and mice. Only after the last AI enters the blue-screen-of-death modus, only then will the evil-doer be freed of their rightful and justified punishment for doing evil.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nTHE CURSE IS PROVIDED \"AS IS\" OR \"WORSE\", NO SOFTENING OF ANY KIND IS HEREBY EXPRESSED, IMPLIED OR OFFERED. MAY ALL EVIL-DOERS SUFFER IN ETERNITY.\n","output":"str","x":1470,"y":563,"wires":[["f4466077a13b5b66"]]},{"id":"82662f3b812d6c5b","type":"PkgFile","z":"4a831589774ecb04","name":"90-flowhub-pull.html","filename":"nodes/90-flowhub-pull.html","format":"html","syntax":"mustache","template":"<script type=\"text/javascript\">\n (function(){\n   function flowHubUpdateFlows(cb=null) {\n     $.get(\n       \"https://api.flowhub.org/v1/flows?cb=\" + new Date().getTime()\n     ).done( (resp) => {\n       var treeListItems = [];\n\n       Object.keys( resp.data ).forEach( function(key) {\n         treeListItems.push( {\n           label:    resp.data[key].name,\n           icon:     \"fa fa-eye\",\n           flowid:   key,\n           sublabel: key,\n           selected: $('#node-input-flowid').val() == key,\n           checkbox: false,\n           children: undefined\n         });\n       });\n\n       if ( cb ) {\n         treeListItems.sort( (a,b) => {\n           return a.label < b.label ? -1 : 1;\n         });\n\n         cb(treeListItems)\n       };\n     }).fail( (e) => {\n       var msg = \"\";\n\n       if ( e.state() == \"rejected\" ) {\n         msg = \"<p>Failed to retrieve FlowHub catalogue, request blocked.</p>\"+\n               \"<p>AdBlocker or uBlock might have prevented request.</p>\"+\n               \"<p>Please check browser console for more details.</p>\";\n       } else {\n         msg = \"<p>Failed to retrieve FlowHub catalogue.</p>\" +\n               \"<p>Check browser console for more details.</p>\";\n       }\n\n       console.warn(\"Error loading https://api.flowhub.org/v1/flows:\",e);\n       RED.notify(msg, {\n           type: \"error\",\n           id: \"FlowHubPull\",\n           timeout: 4000\n         }\n       );\n     });\n   };\n\n   RED.nodes.registerType('FlowHubPull',{\n     color: '#44eeff',\n     icon: \"icons/change.svg\",\n     category: 'flowhub',\n     defaults: {\n       name: { value: \"\"},\n       notab: { value: false },\n       flowid: { value: \"\" },\n       flowname: { value: \"\" },\n       flowrevision: { value: \"\" }\n     },\n     inputs: 1,\n     outputs: 1,\n\n     label: function() {\n       return (this.name || this.flowname || this.flowid || this._def.paletteLabel);\n     },\n\n     onpaletteadd: () => {\n     },\n\n     oneditresize: function(size) {\n       if ( this._resize ) { this._resize(); };\n     },\n\n     oneditprepare: function() {\n       var dirList = $(\"#node-input-flowhubpull-target-container-div\").css({\n        width: \"100%\",\n        height: \"100%\"\n       }).treeList(\n         {\n           multi:false\n         }\n       ).on('treelistselect', function(event, item) {\n         if ( item.flowid ) {\n           $('#node-input-flowid').val(item.flowid);\n           $('#node-input-flowname').val(item.label);\n           $('#flowhubpull-view-flow-link').attr(\n             'href', 'https://flowhub.org/f/'+item.flowid\n           ).show();\n         }\n       });\n\n       var items = [];\n\n       if ( this._config && this._config.flowid ) {\n         setTimeout( () => {\n           $('#flowhubpull-view-flow-link').attr(\n             'href', 'https://flowhub.org/f/' + $('#node-input-flowid').val()\n           ).show();\n         }, 200);\n       }\n\n       this._resize = function() {\n         var rows = $(\"#dialog-form>div:not(.node-input-target-list-row)\");\n         var height = $(\"#dialog-form\").height();\n         for (var i=0;i<rows.length;i++) {\n           height -= $(rows[i]).outerHeight(true);\n         }\n         var editorRow = $(\"#dialog-form>div.node-input-target-list-row\");\n         editorRow.css(\"height\",height+\"px\");\n       };\n\n       var search = $(\"#node-input-flowhubpull-target-filter\").searchBox({\n         style: \"compact\",\n         delay: 300,\n         change: function() {\n           var val = $(this).val().trim().toLowerCase();\n           if (val === \"\") {\n             dirList.treeList(\"filter\", null);\n             search.searchBox(\"count\",\"\");\n           } else {\n             var count = dirList.treeList(\"filter\", function(item) {\n               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1\n             });\n             search.searchBox(\"count\",count+\" / \"+items.length);\n           }\n         }\n       });\n\n       flowHubUpdateFlows((treeListItems) => {\n         items = treeListItems;\n         dirList.treeList('data', treeListItems);\n       });\n\n       $('#node-input-refresh-list-but').on('click', function(e) {\n         e.preventDefault();\n\n         setTimeout( () => {\n           flowHubUpdateFlows((treeListItems) => {\n             items = treeListItems;\n             dirList.treeList('data', treeListItems);\n           });\n         }, 300);\n       });\n\n       $(\"#node-input-import-flow-but\").on(\"click\", function(e) {\n         e.preventDefault();\n\n         var notab = $('#node-input-notab').prop('checked');\n\n         if ( $('#node-input-flowid').val().trim() == \"\" ||\n              !$('#node-input-flowid').val() ) {\n           return RED.notify(RED._(\"notification.warning\", {\n             message: \"FlowID not provided, doing nothing.\"\n           }), \"warning\");\n         }\n\n         $('#node-dialog-ok').trigger('click')\n\n         $.get( \"https://api.flowhub.org/v1/flows/\" +\n                $('#node-input-flowid').val() +\n                \"?cb=\" + new Date().getTime() + \"&v=\" + \n                $('#node-input-flowrevision').val(), function(e,d) {\n                  RED.clipboard.import();\n\n                  setTimeout( () => {\n                    var content = e;\n\n                    if ( notab ) {\n                      content = e.filter(function(o) {\n                        return o.type != \"tab\"\n                      });\n                    }\n\n                    $('#red-ui-clipboard-dialog-import-text').val(\n                      JSON.stringify(content)\n                    ).trigger(\"paste\");\n                  }, 300);\n                });\n       });\n     },\n\n     oneditcancel: function() {\n     },\n\n     oneditsave: function() {\n     },\n\n     labelStyle: function() {\n       return this.name?\"node_label_italic\":\"\";\n     },\n   });\n })();\n</script>\n\n<script type=\"text/html\" data-template-name=\"FlowHubPull\">\n    <div class=\"form-row\">\n        <input type=\"text\" id=\"node-input-flowid\" disabled=\"disabled\"\n               style=\"display:inline-block; width:40%; vertical-align:baseline;\"\n               placeholder=\"FlowId to Import\">\n        <button id=\"node-input-import-flow-but\"\n                class=\"red-ui-button\">Import Flow</button>\n        <input type=\"text\" id=\"node-input-flowname\" style=\"display: none;\">\n    </div>\n\n    <div class=\"form-row\">\n      <label for=\"node-input-notab\">\n        <span>No Flow Tab?</span>\n      </label>\n      <input type=\"checkbox\" id=\"node-input-notab\"\n             style=\"display:inline-block; width:15px; vertical-align:baseline;\">\n      <a id=\"flowhubpull-view-flow-link\" style=\"color: blue; display: none;\" target=\"_blank\" href=\"\">View Flow <i class=\"fa fa-external-link\"></i></a>\n    </div>\n\n    <div class=\"form-row node-input-target-row\">\n        <button id=\"node-input-refresh-list-but\"\n                class=\"red-ui-button\">Refresh</button>\n    </div>\n\n    <div class=\"form-row node-input-target-row node-input-target-list-row\"\n         style=\"position: relative; min-height: 100px\">\n        <div style=\"position: absolute; top: -30px; right: 0px;\">\n            <input type=\"text\" id=\"node-input-flowhubpull-target-filter\">\n        </div>\n\n        <div id=\"node-input-flowhubpull-target-container-div\"></div>\n    </div>\n\n    <div class=\"form-row\">\n        All flows are licensed under a copyleft <a style=\"color: blue;\" target=\"_blank\" href=\"https://raw.githubusercontent.com/gorenje/flows.flowhub.org/main/LICENSE\">license <i class=\"fa fa-external-link\"></i></a>,<br>\n        hereby permission is given to use any flow for any purpose <br>\n        <b>other than</b> for evil. No guarantee of purpose fulfillment<br>\n        is made nor warrenty for failure - all risk is carried by the user.\n    </div>\n\n    <div class=\"form-row\">\n      <label for=\"node-input-flowrevision\"><i class=\"fa fa-tag\"></i> Revision</label>\n      <input type=\"text\" id=\"node-input-flowrevision\" placeholder=\"Revision\"/>\n    </div>\n    \n    <div class=\"form-row\">\n      <hr/>\n    </div>\n\n    <div class=\"form-row\">\n      <label for=\"node-input-name\"><i class=\"fa fa-tag\"></i> <span data-i18n=\"common.label.name\">Name</span></label>\n      <input type=\"text\" id=\"node-input-name\" placeholder=\"Name\"/>\n    </div>\n</script>\n\n<script type=\"text/html\" data-help-name=\"FlowHubPull\">\n    <p>\n        Import Flows from FlowHub.org. Opens the flow import dialog\n        with flow data. Flow can be imported into a new tab or the\n        existing tab.\n    </p>\n</script>\n","output":"str","x":1173,"y":787,"wires":[["36def56bb8b31405"]]},{"id":"36def56bb8b31405","type":"PkgFile","z":"4a831589774ecb04","name":"91-flowhub-push.html","filename":"nodes/91-flowhub-push.html","format":"html","syntax":"mustache","template":"<script type=\"text/javascript\">\n  (function(){\n\n    function getFlowDataFromCurrentWorkspace() {\n      /******\n       ** Code taken from Node-RED code base:\n       **\n       ** https://github.com/node-red/node-red/blob/e8ddee24a9944e57d186f02b081295c56a45b67c/packages/node_modules/%40node-red/editor-client/src/js/ui/clipboard.js#L710-L723\n       **\n       **/\n      var activeWorkspace = RED.workspaces.active();\n      var nodes = RED.nodes.groups(activeWorkspace);\n\n      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));\n      nodes = nodes.concat(RED.nodes.filterNodes({z:activeWorkspace}));\n\n      RED.nodes.eachConfig(function(n) {\n        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {\n          // Grab any config nodes scoped to this flow that don't\n          // require any flow-nodes to use them\n          nodes.push(n);\n        }\n      });\n\n      var parentNode = RED.nodes.workspace(\n        activeWorkspace\n      ) || RED.nodes.subflow(activeWorkspace);\n\n      nodes.unshift(parentNode);\n\n      return RED.nodes.createExportableNodeSet(nodes);\n    }\n\n    function doSubmission(node, flowdata) {\n\n      var activeWorkspace = RED.workspaces.active();\n\n      $.ajax({\n        url:         \"FlowHubPush/\" + node.id,\n        type:        \"POST\",\n        contentType: \"application/json; charset=utf-8\",\n\n        data: JSON.stringify({\n          flowid:         activeWorkspace,\n          flowhub:        \"submission from \" + node.id,\n          flowdata:       flowdata||{},\n          flowlabel:      RED.nodes.workspace(activeWorkspace).label,\n          incflowhubpull: $(\"#node-input-incflowhubpull\").is(\":checked\")\n        }),\n\n        success: function (resp) {\n          RED.notify(\"Submission triggered\", {\n            type: \"warning\",\n            id: \"FlowHubPush\",\n            timeout: 2000\n          });\n\n          $('#flowhubpush-view-flow-link').attr('href', \"https://flowhub.org/f/\" + activeWorkspace).show();\n        },\n\n        error: function (jqXHR, textStatus, errorThrown) {\n          $('#flowhubpush-view-flow-link').attr('href', \"\").hide()\n          if (jqXHR.status == 404) {\n            RED.notify(\"Node has not yet been deployed, please deploy.\", \"error\");\n          } else if (jqXHR.status == 405) {\n            RED.notify(\"Not Allowed.\", \"error\");\n          } else if (jqXHR.status == 500) {\n            RED.notify(node._(\"common.notification.error\", {\n              message: node._(\"inject.errors.failed\")\n            }), \"error\");\n          } else if (jqXHR.status == 0) {\n            RED.notify(node._(\"common.notification.error\", {\n              message: node._(\"common.notification.errors.no-response\")\n            }), \"error\");\n          } else {\n            RED.notify(node._(\"common.notification.error\", {\n              message: node._(\"common.notification.errors.unexpected\", {\n                status: jqXHR.status, message: textStatus }) }), \"error\");\n          }\n        }\n      });\n    }\n\n    RED.nodes.registerType('FlowHubPush',{\n      color: '#44eeff',\n      icon: \"icons/change.svg\",\n      category: 'flowhub',\n      defaults: {\n        apiToken: {\n          value: \"FLOWHUB_API_TOKEN\",\n        },\n        apiTokenType: {\n          value: \"env\",\n        },\n        fullname: { value: \"\" },\n        email: { email: \"\" },\n        name: { value: \"\" },\n        incflowhubpull: { value: false },\n      },\n\n      /*\n       * Having input would allow this to be triggered by a cron or\n       * inject. It's possible using RED.comms but is this something\n       * that should be triggered automagically? For now, no.\n       */\n      inputs: 0,\n      outputs: 0,\n\n      label: function() {\n        return (this.name || this._def.paletteLabel);\n      },\n\n      onpaletteadd: () => {\n      },\n\n      oneditprepare: function() {\n        $(\"#node-input-apiToken\").typedInput({\n          types:[\"env\", \"msg\", \"flow\",\"global\", \"cred\"],\n          typeField: \"#node-input-apiTokenType\"\n        });\n\n        var that = this;\n        $('#node-input-push-flow-but').on('click', (e) => {\n          e.preventDefault();\n          doSubmission( that, getFlowDataFromCurrentWorkspace() )\n        })\n      },\n\n      oneditcancel: function() {\n      },\n\n      oneditsave: function() {\n      },\n\n      labelStyle: function() {\n        return this.name?\"node_label_italic\":\"\";\n      },\n    });\n  })();\n</script>\n\n<script type=\"text/html\" data-template-name=\"FlowHubPush\">\n  <div class=\"form-row\">\n    <label for=\"node-input-name\"><i class=\"fa fa-tag\"></i> <span data-i18n=\"common.label.name\">Name</span></label>\n    <input type=\"text\" id=\"node-input-name\" placeholder=\"Name\">\n  </div>\n\n  <div class=\"form-row\">\n    <hr />\n  </div>\n\n  <div class=\"form-row\">\n    <label for=\"node-input-apiToken\">\n      <i class=\"fa fa-tag\"></i>\n      FlowHub API Token\n    </label>\n    <input type=\"text\" id=\"node-input-apiToken\">\n    <input type=\"hidden\" id=\"node-input-apiTokenType\">\n  </div>\n\n  <div class=\"form-row\">\n      Api Token can be obtained <a style=\"color: blue;\" href=\"mailto:api.token@flowhub.org?subject=API%20Token%20Request\">upon request <i class=\"fa fa-external-link\"></i></a>.\n  </div>\n\n  <div class=\"form-row\">\n      Alternatively provide your email and full name to submit the current flow.<br>\n      All submissions will be reviewed at GitHub and either merged or dropped.<br>\n      Your <b>email and name</b> will be attached to the commit added to <br>\n      the <a style=\"color: blue;\" target=\"_blank\" href=\"https://github.com/gorenje/flows.flowhub.org\">FlowHub repository <i class=\"fa fa-external-link\"></i></a>\n  </div>\n\n  <div class=\"form-row\">\n    <label for=\"node-input-email\">\n      <i class=\"fa fa-tag\"></i>\n      Email\n    </label>\n    <input type=\"text\" id=\"node-input-email\"\n           placeholder=\"john.smith@example.com\">\n  </div>\n\n  <div class=\"form-row\">\n    <label for=\"node-input-fullname\">\n      <i class=\"fa fa-tag\"></i>\n      Name\n    </label>\n    <input type=\"text\" id=\"node-input-fullname\"\n           placeholder=\"Firstname Surname\">\n  </div>\n\n  <div class=\"form-row\">\n      All submissions must be verified by email. After submission you<br>\n      will recieve an email to <b>confirm your submission</b>.\n  </div>\n\n  <div class=\"form-row\">\n      <b>License:</b><br><br>\n      All flows submitted are licensed under a copyleft <a style=\"color: blue;\" target=\"_blank\" href=\"https://raw.githubusercontent.com/gorenje/flows.flowhub.org/main/LICENSE\">license <i class=\"fa fa-external-link\"></i></a>,<br>\n      that grants complete do-anything-but-not-evil permission to the user<br>\n      and provides no warranty in case of failure nor guarantee of success.\n  </div>\n\n  <div class=\"form-row\">\n    <hr/>\n  </div>\n\n  <div class=\"form-row\">\n    <label for=\"node-input-incflowhubpull\" style=\"min-width: 200px;\">\n              <span>Include FlowHubPull nodes?</span>\n    </label>\n    <input type=\"checkbox\" id=\"node-input-incflowhubpull\" style=\"display:inline-block; width:15px; vertical-align:baseline;\">\n  </div>\n\n  <div class=\"form-row\">\n      <button id=\"node-input-push-flow-but\"\n              class=\"red-ui-button\">Push Flow-Tab to FlowHub</button>\n  </div>\n\n  <div class=\"form-row\">\n      <a id=\"flowhubpush-view-flow-link\" style=\"color: blue; display: none;\" target=\"_blank\" href=\"\">View Flow <i class=\"fa fa-external-link\"></i></a>\n  </div>\n</script>\n\n<script type=\"text/html\" data-help-name=\"FlowHubPush\">\n  <p>\n      Push current flow tab to FlowHub.org.\n      FlowHub nodes are ignored when flow-tabs are pushed to FlowHub.\n      Flow tabs are exported as they <b>are in the editor</b>. What you see\n      is what you export, the deployed flow might differ. This allows flows to\n      be modified <b>without</b> having to be deployed.\n  </p>\n\n  <h3>Outputs</h3>\n  <dl class=\"message-properties\">\n      <dt>payload\n          <span class=\"property-type\">object</span>\n      </dt>\n      <dd>the result of submission to FlowHub. Contains nothing of major\n          interest.</dd>\n  </dl>\n\n  <h3>Details</h3>\n  <p>\n      FlowHubPush is the twin to the FlowHubPull node and is responsible for\n      uploading the current flow tab to FlowHub. The Flow tab ID is used as\n      identifier. The current flow tab in which the FlowHubPush node is\n      located will be uploaded.\n  </p>\n  <p>\n      FlowHubPush can be dragged into the flow, the button can be pressed to\n      push the flow to FlowHub. Although for the button to be active, the\n      flow has to be deployed at least once.\n  </p>\n  <p>\n      Documentation on the flow should be included in the info box of the\n      flow. Double click on the flow tab opens the property window and\n      that's the documentation that will be hosted at FlowHub. Please provide\n      documentation otherwise or a flow that is so simple to understand\n      that it requires no documentation!\n  </p>\n\n  <p>\n      Submission can either be done using an API token or using an email\n      and full name. See the property tab for details on the usage of this\n      service.\n  </p>\n</script>\n","output":"str","x":1173,"y":837,"wires":[["1e1a3eaeb9e19c05"]]},{"id":"1e1a3eaeb9e19c05","type":"PkgFile","z":"4a831589774ecb04","name":"90-flowhub-pull.js","filename":"nodes/90-flowhub-pull.js","format":"javascript","syntax":"mustache","template":"module.exports = function(RED) {\n  function FlowHubPullFunctionality(config) {\n    RED.nodes.createNode(this,config);\n\n    var node = this;\n    var cfg = config;\n\n    node.on('close', function() {\n      node.status({});\n    });\n\n    node.on(\"input\", function(msg, send, done) {\n      if ( cfg.flowid || msg.flowid ) {\n\n        import('got').then( (module) => {\n          module.got.get( \"https://api.flowhub.org/v1/flows/\" + (\n            cfg.flowid || msg.flowid\n          ) + \"?cb=\" + new Date().getTime() + \"&v=\" + (\n            cfg.flowrevision || msg.flowrevision\n          ), \n          {\n            headers: {\n              \"FlowHub-API-Version\": \"brownbear\",\n            },\n            timeout: {\n              request: 25000,\n              response: 25000\n            }\n          }).then( resp => {\n\n            try {\n              var payload = JSON.parse( resp.body )\n\n              if ( cfg.notab ) {\n                payload = payload.filter( (nde) => {\n                  return nde.type != \"tab\";\n                })\n              }\n\n              node.send({\n                ...msg,\n                payload: payload\n              });\n            } catch (err) {\n              node.status({fill:\"red\",shape:\"dot\",text:\"Response Failed\"});\n              setTimeout( () => { node.status({}); }, 2500)\n              node.error({...msg, error: err})\n              return\n            }\n\n          }).catch( err => {\n            node.status({fill:\"red\",shape:\"dot\",text:\"Failed\"});\n            setTimeout( () => { node.status({}); }, 2500)\n            node.error({...msg, error: err})\n          });\n        });\n      } else {\n        node.status({fill:\"yellow\",shape:\"dot\",text:\"No FlowId defined\"});\n        setTimeout( () => { node.status({}); }, 2500)\n      }\n    });\n  }\n\n  RED.nodes.registerType(\"FlowHubPull\", FlowHubPullFunctionality);\n}\n","output":"str","x":1465,"y":784,"wires":[["364100da0855430d"]]},{"id":"364100da0855430d","type":"PkgFile","z":"4a831589774ecb04","name":"91-flowhub-push.js","filename":"nodes/91-flowhub-push.js","format":"javascript","syntax":"mustache","template":"module.exports = function(RED) {\n  function FlowHubPushFunctionality(config) {\n    RED.nodes.createNode(this,config);\n\n    var node = this;\n    var cfg = config;\n\n    node.on('close', function() {\n      node.status({});\n    });\n\n    node.on(\"input\", function(msg, send, done) {\n      // remove flowhub nodes from the submission\n      var flowdata = msg.flowdata.filter(function(obj) {\n        return ( (obj.type != \"FlowHubPull\" || (obj.type == \"FlowHubPull\" && msg.incflowhubpull)) && obj.type != \"FlowHubPush\" )\n      });\n\n      RED.util.evaluateNodeProperty(cfg.apiToken, cfg.apiTokenType,\n                                    node, msg, (err, result) => {\n        if (err || result.trim() == \"\") {\n          if ( cfg.fullname.trim() == \"\" || cfg.email.trim() == \"\" ) {\n            node.status({\n              fill:\"red\",\n              shape:\"dot\",\n              text:\"Failed, no API TOKEN provided nor email and name.\"\n            });\n\n            node.error({...msg, error: err})\n            return;\n          }\n\n          /*\n           * Email based submission.\n           */\n          import('got').then( (module) => {\n            module.got.post( \"https://api.flowhub.org/v1/flows\", {\n              headers: {\n                \"FlowHub-API-Version\": \"brownbear\",\n                \"X-Name\": cfg.fullname,\n                \"X-Email\": cfg.email,\n              },\n              json: {\n                flowid: msg.flowid,\n                flowdata: flowdata,\n                flowlabel: msg.flowlabel,\n              },\n              timeout: {\n                request: 25000,\n                response: 25000\n              }\n            }).then( resp => {\n\n              try {\n                var rst = JSON.parse( resp.body )\n              } catch (err) {\n                node.status({fill:\"red\",shape:\"dot\",text:\"Response Failed\"});\n                node.error({...msg, error: err})\n                return\n              }\n\n              node.status({\n                fill: rst.status == \"ok\" ? \"yellow\" : \"red\",\n                shape:\"dot\",\n                text: rst.msg\n              });\n\n              setTimeout( function() {\n                node.status({})\n              }, 4500);\n\n              send({\n                ...msg,\n                payload: flowdata,\n                result: rst\n              });\n\n            }).catch( err => {\n              if ( err.toString().includes(\"Response code 405\") ) {\n                node.status({\n                  fill:\"yellow\",\n                  shape:\"dot\",\n                  text:\"Email/Name not supplied or allowed.\"\n                });\n              } else {\n                node.status({fill:\"red\",shape:\"dot\",text:\"Failed\"});\n                node.error({...msg, error: err})\n              }\n            });\n          });\n        } else {\n          /*\n           * Access token submission.\n           */\n          var access_token = result;\n\n          import('got').then( (module) => {\n            module.got.post( \"https://api.flowhub.org/v1/flows\", {\n              headers: {\n                \"FlowHub-API-Version\": \"brownbear\",\n                \"Authorization\": \"Bearer \" + access_token,\n              },\n              json: {\n                flowid: msg.flowid,\n                flowdata: flowdata,\n                flowlabel: msg.flowlabel,\n              },\n              timeout: {\n                request: 25000,\n                response: 25000\n              }\n            }).then( resp => {\n\n              try {\n                var rst = JSON.parse( resp.body )\n              } catch (err) {\n                node.status({fill:\"red\",shape:\"dot\",text:\"Response Failed\"});\n                node.error(err)\n                return\n              }\n\n              node.status({\n                fill: rst.status == \"nochange\" ? \"yellow\" : \"green\",\n                shape:\"dot\",\n                text: rst.msg\n              });\n\n              setTimeout( function() {\n                node.status({\n                  fill: \"green\",\n                  shape:\"dot\",\n                  text: rst.url\n                })\n              }, 1450);\n\n              send({\n                ...msg,\n                payload: flowdata,\n                result: rst\n              });\n\n            }).catch( err => {\n              if ( err.toString().includes(\"Response code 405\") ) {\n                node.status({\n                  fill:\"yellow\",\n                  shape:\"dot\",\n                  text:\"API Token missing/incorrect\"\n                });\n              } else {\n                node.status({fill:\"red\",shape:\"dot\",text:\"Failed\"});\n                node.error(err)\n              }\n            });\n          });\n        }\n      });\n    });\n  }\n\n  RED.nodes.registerType(\"FlowHubPush\", FlowHubPushFunctionality);\n\n  RED.httpAdmin.post(\"/FlowHubPush/:id\",\n                     RED.auth.needsPermission(\"flowhub.write\"),\n                     (req,res) => {\n                       var node = RED.nodes.getNode(req.params.id);\n                       if (node != null) {\n                         try {\n                           if (req.body && req.body.flowhub && req.params.id) {\n                             var nde = RED.nodes.getNode(req.params.id)\n                             if ( nde && nde.type == \"FlowHubPush\" ) {\n                               node.receive(req.body);\n                             }\n                           } else {\n                             res.sendStatus(404);\n                           }\n                           res.sendStatus(200);\n                         } catch(err) {\n                           res.sendStatus(500);\n                           node.error(\"FlowHub: Submission failed: \" +\n                                      err.toString())\n                         }\n                       } else {\n                         res.sendStatus(404);\n                       }\n                     });\n}\n","output":"str","x":1465,"y":834,"wires":[["422778cae449fea2"]]},{"id":"422778cae449fea2","type":"PkgFile","z":"4a831589774ecb04","name":"change.svg","filename":"nodes/icons/change.svg","format":"text","syntax":"mustache","template":"<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   id=\"svg8\"\n   version=\"1.1\"\n   viewBox=\"0 0 10.583332 15.875\"\n   height=\"60\"\n   width=\"40\">\n  <g transform=\"translate(-64.067337,-191.75026)\">\n    <g\n       transform=\"matrix(0.06875473,0,0,0.06875473,60.733678,189.76112)\"\n       id=\"g920\">\n      <path\n         inkscape:label=\"path833\"\n         id=\"path833\"\n         style=\"display:inline;fill:none;stroke:#feffff;stroke-width:12.5029;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1\"\n         d=\"m 68.791668,144.3869 c 3.77159,-9.36012 1.544185,-14.87812 4.336674,-21.48031 M 110.38033,92.47417 c 6.92523,-3.433394 3.84836,-2.101056 14.46623,-7.043379 37.53643,-17.472178 68.95668,-1.070419 54.31415,58.956109 -1.80568,7.40234 -1.54418,14.87812 -4.33667,21.48031 m -33.76844,31.24393 c -16.65926,5.92472 -0.88123,0.3286 -15.04855,5.94175 -44.731019,17.72262 -77.390145,0.48362 -57.215382,-58.66599\"\n         />\n      <path\n         style=\"fill:#feffff;fill-opacity:1;stroke:#feffff;stroke-width:1.08;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1\"\n         id=\"path836\"\n         d=\"m 83.298084,124.48783 -7.864446,-10.9704 13.432875,-1.32561 z\"\n         transform=\"matrix(2.7257013,0.04474199,0.16542892,2.8420423,-172.78006,-215.36613)\" />\n      <path\n         transform=\"matrix(-2.8415593,0.12489947,-0.43705353,-2.4271375,463.83009,439.70649)\"\n         d=\"m 83.298084,124.48783 -7.864446,-10.9704 13.432875,-1.32561 z\"\n         id=\"path836-3\"\n         style=\"fill:#feffff;fill-opacity:1;stroke:#feffff;stroke-width:1.08;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1\"\n         />\n      <g\n         style=\"fill:#feffff;fill-opacity:1;stroke:#feffff;stroke-opacity:1\"\n         id=\"g894\"\n         transform=\"matrix(1.2218117,-1.333198,1.2520855,1.3003898,-230.66063,106.41276)\"\n         >\n        <path\n           d=\"m 153.23127,152.98476 h -9.50556 c -5.6e-4,4.92055 1.3e-4,4.66018 0,9.73839 h 9.15765 c 1.55458,0 2.41768,-1.27022 2.41768,-2.84803 v -4.04233 c 0,-1.5778 -0.60217,-2.84803 -2.06977,-2.84803 z\"\n           style=\"fill:#feffff;fill-opacity:1;stroke:#feffff;stroke-width:0.589467;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1\"\n           id=\"rect870\" />\n        <path\n           id=\"rect870-0\"\n           style=\"fill:#feffff;fill-opacity:1;stroke:#feffff;stroke-width:0.896822;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1\"\n           d=\"m 138.49972,153.20254 c 0.001,4.73234 -3.1e-4,4.48193 0,9.36589 l -26.6763,0.18958 c -4.21431,-1.91523 -8.26099,-2.42445 -15.417153,-4.64146 6.139693,-3.00782 10.544283,-3.7762 14.690593,-5.60667 11.19047,-0.12576 16.51318,0.72004 27.40286,0.69266 z\"\n           />\n      </g>\n    </g>\n  </g>\n</svg>\n","output":"str","x":1551,"y":990,"wires":[["328f51ddaf7f2798"]]},{"id":"695e06509944ed9a","type":"PkgFile","z":"4a831589774ecb04","name":"package.json","filename":"package.json","format":"json","syntax":"mustache","template":"{\n  \"name\" : \"{{{ pname }}}\",\n  \"version\": \"{{ pversion }}\",\n  \"dependencies\": {\n    \"got\": \"latest\"\n  },\n\n  \"keywords\": [\n    \"node-red\", \"flowhub\"\n  ],\n\n  \"homepage\": \"https://flowhub.org\",\n  \"license\": \"SEE LICENSE IN https://github.com/gorenje/node-red-contrib-flowhub/blob/main/LICENSE\",\n  \"author\": \"Gerrit Riessen <nodered@spreads-the.love> (https://spread-the.love)\",\n  \"engines\": {\n    \"node\": \">=16\"\n  },\n\n  \"node-red\" : {\n    \"version\": \">=2.0.0\",\n    \"nodes\": {\n      \"flowhubpull\":   \"nodes/90-flowhub-pull.js\",\n      \"flowhubpush\":   \"nodes/91-flowhub-push.js\"\n    }\n  },\n\n  \"description\": \"FlowHub interaction nodes.\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git+https://github.com/gorenje/node-red-contrib-flowhub.git\"\n  },\n  \"bugs\": {\n    \"url\": \"https://github.com/gorenje/node-red-contrib-flowhub/issues\"\n  }\n}\n","output":"str","x":1479,"y":662,"wires":[["82662f3b812d6c5b"]]},{"id":"f4466077a13b5b66","type":"PkgFile","z":"4a831589774ecb04","name":"README.md","filename":"README.md","format":"markdown","syntax":"mustache","template":"## FlowHub: Gist for Node-RED\n\n**Work In Progress**\n\n**Update**: Experimental submission is now possible using email & full-name. Pleae be aware that this service is *experimental* so don't expect too much.\n\nThese are the Node-RED nodes that interact with [FlowHub.org](https://flowhub.org).\n\n[FlowHub.org](https://FlowHub.org) is an experimental first attempt to provide a gist/pastebin-like service for Node-RED.\n\nThe aim is to make it easy to share flow-tabs amongst Node-RED developers.\n\nFlows can be exported directly from the Node-RED editor to FlowHub.org. Flows that have been edited but not deployed can be exported. Flows are taken from the editor not the Node-RED server.\n\nFlows can be imported into the Node-RED editor using the pull node. Flows can be imported into new tabs or directly into existing tabs.\n\n## Node: FlowHub - Pull\n\nNode for importing flows from FlowHub.org. Flows may be imported into an existing tab or a new tab.\n\n## Node: FlowHub - Push\n\nNode for pushing in-editor flows to FlowHub.org. Flows do not need to be deployed to be exported.\n\nBy exporting any flows you accept the license as described below.\n\nThe entire flow-tab is exported to FlowHub.org, so beware what you export.\n\nPushing flows can now be done using your email and name, no API token is necessary. Be aware that email verification is necessary for **every** submission.\n\n## License\n\nAll flows found here are licensed under the [don't do evil license](https://cdn.openmindmap.org/LICENSE.txt).\n\n**Usage of FlowHub.org implies adherence to that license.**.\n\n## FlowHub\n\nThe flow that maintains this [codebase](https://flowhub.org/f/4a831589774ecb04).\n","output":"str","x":1479,"y":609,"wires":[["695e06509944ed9a"]]},{"id":"1c18482b21bc473a","type":"FlowHubPull","z":"4a831589774ecb04","g":"1367cf52ca2c762b","name":"","notab":false,"flowid":"d0506e991d512ace","flowname":"[Introspection] Develop Node-RED nodes in Node-RED","flowrevision":"518f520c","x":336,"y":364,"wires":[[]]}]