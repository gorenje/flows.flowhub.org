[{"id":"e02ba6e534f7a0f4","type":"tab","label":"[Introspection] ClientCode: Convert RSS to Nodes","disabled":false,"info":"::: aim\n\nProvide an example of the TriggerImport node that can be used to import dynamically generated flows.\n\nDemonstrate by converting an RSS feed to a Node-RED flow tab.\n\n:::\n\n::: requirements\n\nThis requirements the following Node-RED nodes:\n\n- [introspection](https://flows.nodered.org/node/@gregoriusrippenstein/node-red-contrib-introspection), version >= 0.4.1\n\n:::\n\n::: explanation\n\n**RSS to Nodes**\n\nThe flow retrieves an RSS feed and for each entry, it generates a comment node.\n\nThe <a class=\"ahl-node-only\" data-ids=\"5bf2de0885c59307\">ClientCode node</a> is triggered once the flow contents have been created and it executes Javascript code in the client to open the Flow Import dialog. It the pastes the flow contents into the dialog.\n\nThe nodes generated in the <a class=\"ahl-node-only\" data-ids=\"77a3c9b5811260e2\">function node</a> have the format:\n\n```javascript\nmsg.payload = {\n    \"id\": msg.payload.id[0].match(/.{16}$/)[0],\n    \"type\": \"comment\",\n    \"name\": msg.payload.title[0][\"_\"],\n    \"info\": msg.payload.id[0],\n    \"x\": 801 * Math.random(),\n    \"y\": 699 * Math.random(),\n    \"wires\": [\n    ]\n}\n```\n\nThe `id` (in this case) assumes that the orignal RSS id contains a 16 digit hexdecimal. This is an assumption that **only** works with this RSS feed.\n\n\n**Hello World**\n\nThe <a class=\"ahl-group-only\" data-ids=\"6862158f3d80a473\">hello world flow</a> will simply open an alert window in the browser with *hello world* - the payload set in the <a class=\"ahl-node-only\" data-ids=\"d648fd685e2efd72\">inject node</a>.\n\n:::\n","env":[]},{"id":"6862158f3d80a473","type":"group","z":"e02ba6e534f7a0f4","name":"hello world","style":{"label":true},"nodes":["d648fd685e2efd72","3176194cbb4abcf5"],"x":170.25,"y":49,"w":630,"h":151},{"id":"e6f43d21f8ccfad6","type":"group","z":"e02ba6e534f7a0f4","name":"create dynamic flow using RSS as input","style":{"label":true},"nodes":["f3bdcd54a0aa8585","c2d4ce3e6e7c2e31","f210b63040eeb212","e7289b9433d25283","3d604af7f2cb8912","77a3c9b5811260e2","9de0d672c6fbccb8","875ef0b0799bb044","5bf2de0885c59307"],"x":170.25,"y":471,"w":1607.75,"h":522},{"id":"fdc3fd787c126eb3","type":"group","z":"e02ba6e534f7a0f4","name":"align all connected nodes","style":{"label":true},"nodes":["c482389d05470096","2798c3c8c33abd09","c4df7559e046aac8"],"x":1068,"y":49,"w":710,"h":328},{"id":"576eb2790b07f530","type":"group","z":"e02ba6e534f7a0f4","name":"move node","style":{"label":true},"nodes":["d06cce0db2eb2cf8","516fc0b2023ebe87"],"x":170.25,"y":274,"w":494,"h":147},{"id":"f3c9039641e8c2e9","type":"group","z":"e02ba6e534f7a0f4","name":"display user agent","style":{"label":true},"nodes":["f264cd20b53c537c","71f605053c3902b8","d41834f0310a9f66","f8dc6845645740ca"],"x":170.25,"y":1086,"w":810,"h":157},{"id":"b74369273536bfab","type":"group","z":"e02ba6e534f7a0f4","name":"connect nodes","style":{"label":true},"nodes":["87ecedcda805b9fc","ae105ff2ffd71fea","85926682e41d7e3e","d396d46edc750dd7"],"x":1068,"y":1032,"w":710,"h":211},{"id":"f3bdcd54a0aa8585","type":"inject","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"set RSS url","props":[{"p":"url","v":"https://flows.flowhub.org/feed.xml","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":276.25,"y":512,"wires":[["c2d4ce3e6e7c2e31"]]},{"id":"c2d4ce3e6e7c2e31","type":"http request","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":431.25,"y":595,"wires":[["f210b63040eeb212"]]},{"id":"f210b63040eeb212","type":"xml","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"parse feed.xml","property":"payload","attr":"","chr":"","x":599.25,"y":670,"wires":[["3d604af7f2cb8912"]]},{"id":"e7289b9433d25283","type":"split","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1108.25,"y":779,"wires":[["77a3c9b5811260e2"]]},{"id":"3d604af7f2cb8912","type":"change","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"set payload and define fake tab Z id","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.feed.entry","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":866.25,"y":730,"wires":[["e7289b9433d25283"]]},{"id":"77a3c9b5811260e2","type":"function","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"convert xml object to flow object","func":"msg.payload = {\n    \"id\": msg.payload.id[0].match(/.{16}$/)[0],\n    \"type\": \"comment\",\n    \"name\": msg.payload.title[0][\"_\"],\n    \"info\": msg.payload.id[0],\n    \"x\": 801 * Math.random(),\n    \"y\": 699 * Math.random(),\n    \"wires\": [\n    ]\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1135.25,"y":866,"wires":[["9de0d672c6fbccb8"]]},{"id":"9de0d672c6fbccb8","type":"join","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1132.25,"y":952,"wires":[["875ef0b0799bb044"]]},{"id":"875ef0b0799bb044","type":"function","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"prepend the subflow to the nodes array","func":"msg.payload = {\n    flowContent: msg.payload,\n    removeduplicates: true,\n    autoimport: false\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1399.25,"y":952,"wires":[["5bf2de0885c59307"]]},{"id":"5bf2de0885c59307","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"e6f43d21f8ccfad6","name":"Open import dialog","clientcode":"function doIt() {\n  var content = payload.flowContent;\n\n  if (payload.removeduplicates) {\n    content = content.filter((elem) => {\n      return RED.nodes.node(elem.id) == undefined\n    });\n  }\n\n  if (content.length == 0) {\n    RED.notify(\"No new content\", {\n      type: \"ok\",\n      id: \"TriggerImport\",\n      timeout: 2000\n    });\n    return;\n  }\n  RED.clipboard.import();\n\n  setTimeout(() => {\n    $('#red-ui-clipboard-dialog-import-text').val(\n      JSON.stringify(content)\n    ).trigger(\"paste\");\n\n    if (payload.autoimport) {\n      setTimeout(() => {\n        $('#red-ui-clipboard-dialog-ok').trigger('click');\n      }, 435);\n    }\n  }, 300);\n};\n\ndoIt();\n","format":"javascript","x":1662,"y":821.20849609375,"wires":[[]]},{"id":"d648fd685e2efd72","type":"inject","z":"e02ba6e534f7a0f4","g":"6862158f3d80a473","name":"Hello World example","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"hello world","payloadType":"str","x":306.25,"y":90,"wires":[["3176194cbb4abcf5"]]},{"id":"3176194cbb4abcf5","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"6862158f3d80a473","name":"open alert window","clientcode":"alert(payload);\n","format":"javascript","x":684.25,"y":159,"wires":[[]]},{"id":"d06cce0db2eb2cf8","type":"inject","z":"e02ba6e534f7a0f4","g":"576eb2790b07f530","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":276.25,"y":315,"wires":[["516fc0b2023ebe87"]]},{"id":"516fc0b2023ebe87","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"576eb2790b07f530","name":"Move node up","clientcode":"var nde = RED.nodes.node(nodeid);\n\nnde.y -= 20;\n\nnde.dirty = true;\n\nRED.view.redraw(true)\n\nnode.send({\n    payload: \"done\"\n})","format":"javascript","x":558.25,"y":380,"wires":[[]]},{"id":"c482389d05470096","type":"inject","z":"e02ba6e534f7a0f4","g":"fdc3fd787c126eb3","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1174,"y":90,"wires":[["2798c3c8c33abd09"]]},{"id":"2798c3c8c33abd09","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"fdc3fd787c126eb3","name":"Align Nodes","clientcode":"var thisNode = RED.nodes.node(nodeid);\n\nconsole.log( thisNode)\nvar connectedNodes = [thisNode];\n\nRED.nodes.eachNode( (nde) => {\n    RED.nodes.getNodeLinks(nde).forEach(function (l) {\n        if ( l.target.id == nodeid) {\n            connectedNodes.push(nde)\n        }\n    });\n})\n\nRED.nodes.getNodeLinks(thisNode).forEach(function (l) {\n    connectedNodes.push(l.target)\n});\n\nRED.view.select({ nodes: connectedNodes })\nsetTimeout(() => {\n    RED.actions.invoke(\"core:align-selection-to-middle\")\n    node.send({\n        payload: \"done\"\n    })\n}, 1000);\n\n","format":"javascript","x":1406,"y":206,"wires":[["c4df7559e046aac8"]]},{"id":"c4df7559e046aac8","type":"debug","z":"e02ba6e534f7a0f4","g":"fdc3fd787c126eb3","name":"debug 8","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1672,"y":336,"wires":[]},{"id":"f264cd20b53c537c","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"f3c9039641e8c2e9","name":"get userAgent","clientcode":"node.send({\n    payload: navigator.userAgent \n});\n","format":"javascript","x":533.25,"y":1202,"wires":[["d41834f0310a9f66","f8dc6845645740ca"]]},{"id":"71f605053c3902b8","type":"inject","z":"e02ba6e534f7a0f4","g":"f3c9039641e8c2e9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":276.25,"y":1201,"wires":[["f264cd20b53c537c"]]},{"id":"d41834f0310a9f66","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"f3c9039641e8c2e9","name":"Open notify popup","clientcode":"RED.notify(\"Your navigator: \" + payload, {\n    id: nodeid,\n    type: \"ok\",\n    timeout: 2000\n})","format":"javascript","x":864.25,"y":1199,"wires":[[]]},{"id":"f8dc6845645740ca","type":"debug","z":"e02ba6e534f7a0f4","g":"f3c9039641e8c2e9","name":"debug 18","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":798.25,"y":1127,"wires":[]},{"id":"87ecedcda805b9fc","type":"inject","z":"e02ba6e534f7a0f4","g":"b74369273536bfab","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1174,"y":1073,"wires":[["ae105ff2ffd71fea"]]},{"id":"ae105ff2ffd71fea","type":"ClientCode","z":"e02ba6e534f7a0f4","g":"b74369273536bfab","name":"connect nodes","clientcode":"\nvar dgbNode = RED.nodes.node(\"85926682e41d7e3e\");\nvar injNode = RED.nodes.node(\"d396d46edc750dd7\");\nvar thisNode = RED.nodes.node(nodeid);\n\nRED.nodes.addLink({ source: thisNode, sourcePort: 0, target: dgbNode });\nRED.nodes.addLink({ target: thisNode, sourcePort: 0, source: injNode });\n\nRED.view.select([dgbNode, thisNode, injNode]);\n","format":"javascript","x":1483,"y":1074,"wires":[[]]},{"id":"85926682e41d7e3e","type":"debug","z":"e02ba6e534f7a0f4","g":"b74369273536bfab","name":"debug 19","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1672,"y":1202,"wires":[]},{"id":"d396d46edc750dd7","type":"inject","z":"e02ba6e534f7a0f4","g":"b74369273536bfab","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1209,"y":1197,"wires":[[]]}]